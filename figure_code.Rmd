---
title: "figure_code"
author: "Timothy Terlizzi"
date: "2024-07-18"
output: html_document
---

# Figure Script Context
The code within this script is used to generate all of the figures within the paper and supplemental material. It uses .csv files generated by both the smthdata_v2_Brewer.Rmd and hill_number_calculations.Rmd *Note both of these scripts must be run before the figures in this script can be generated* For the figures generated within ArcGIS Pro, the input data (such as the marine isotope stage (MIS) means and the Kruskal-Wallis tests) were also generated within this script.

#Libraries and Packages
The packages that need to be installed
```{r}
install.packages("paletteer")
```

These are the packages used in this file
```{r Required Packages}
library("vegan")
library("ggplot2")
library("ggrepel")
library("ggforce")
library("dplyr")
library("paletteer")
library("mgcv")
library("gratia")
library("ggformula")
library("ggpubr")
library("stringr")
```

# Data Import
This code is to read in the raw composite datasheet we generated using the code in the smthdata_v2_Brewer.Rmd file.
```{r File Import, echo=TRUE}
tot<-read.csv("./composite/NAAll_raw.csv") #importing the composite raw data file for all the sites from the composite folder in the working directory

colnames(tot)[1] ="Sample" #renaming the first column in the raw data to Sample from its original name of site

tot$site<-gsub("[^a-zA-Z]", "", tot$Sample) #create a column with the name of the site for each sample; removing the numbers from the Sample column 

#capitalize first letter of site name
tot$site<-str_to_title(tot$site)
```

# DCA Code
The below code is used to generate a Detrended Correspondence Analysis (DCA) which was then used to create 7 regions based on the groupings of sites within the DCA. We opted to use a DCA due to its status as the preferred coordination method within the ecological community. This DCA creates a point for each row of the tot dataframe and color codes them based on the site. The placement of the points is based on the taxonomic composition of each sample. Samples with similar taxonomic compositions plot close together while samples with difference compositions plot farther apart. This enabled us to group sites together based on the taxonomic composition. The results of the DCA also confirmed our assumption that sites within geographically similar regions have similar taxonomic compositions. 

### DCA variables
These are the necessary variables to transform the data to correct for differences in number of taxa and number of samples as well as generate the DCA that is plotted in the following code chunk.
```{r Defining_DCA_variables, echo=TRUE}
tot[is.na(tot)]<-0 #replacing NA's with 0 as the DCA cannot run with NA's
mysites <- tot$site #list of sites for color coding
#standardization method for the DCA to correct for differences in the number of samples and number of taxa
tot.t1<-decostand(tot[,3:144], "total") #standardization method to divide by the total number of rows
tot.t2<-decostand(tot.t1, "max") #divide by the maximum column
tot.t2.dca<-decorana(tot.t2) #running the DCA with the transformed data

t2.dca.scores <- tot.t2.dca$rproj[ ,1:2] # Extract axis 1 & 2 sample scores 
t2.dca.scoressites <- data.frame(t2.dca1=t2.dca.scores[,1],t2.dca2=t2.dca.scores[,2],"sit"=mysites)
attach(t2.dca.scoressites) # Merge site codes and samples scores into single data frame 

#calculating the centroid for each site in the DCA (centroid is the center of the point cloud for each site; this is not the same thing as the center of the CI ellipse)
cent <- aggregate(cbind(t2.dca1, t2.dca2) ~ sit, data = t2.dca.scoressites, FUN = mean)

virid<-paletteer_c("grDevices::Viridis", 23) #creating a color palette for the 23 sites of the DCA
```

### DCA plotting
The below code is to plot the DCA with 30% CI ellipses. This means the ellipses represent 30% of the points for each site. Larger ellipses indicate a wider range of taxonomic compositions over time while smaller ellipses indicate taxonomic stability over time. 
```{r DCA_Plotting, echo=TRUE, message=FALSE}
#plotting the DCA as normal but adding CI ellipse with a level of 0.3 to the sites, this plot does the best job as visualizing where the sites are plotting in the DCA and was used to create our seven regions
dca.ellipse<-ggplot(t2.dca.scoressites, aes(t2.dca1,t2.dca2, col=sit)) +
  geom_point(alpha=0.25, aes(col=sit), size=0.5) +
  theme_classic() + 
  stat_ellipse(geom="polygon", aes(fill=sit), 
               color="#000000", 
               type="t",level=0.3,alpha=0.5) + 
  geom_text_repel(data = cent, mapping=aes(label=sit), #adding site name labels
                  max.overlaps = 20, bg.color="white", bg.r=0.05,
                  segment.colour="#000000", color="#000000",
                  box.padding = 0.75, force=3) +
  scale_color_manual(values=virid) + #coloring the points with the custom color scale
  scale_fill_manual(values=virid) + #coloring the ellipse with the custom color scale
  xlab("DCA axis 1") +
  ylab("DCA axis 2") +
  theme(
    legend.position = "none",
    panel.border = element_rect(colour = "black", fill=NA, size=0.25)
  ) + 
  ggtitle("Site DCA")

dca.ellipse #display the ellipse DCA

#save the ellipse DCA as a pdf in the supplemental_plots folder within the working directory
ggsave("DCA_ellipse.pdf", plot=dca.ellipse, path="./supplemental plots", device="pdf")
```

# Region classifications
We used the DCA to group similar sites together into regions. The region numbers for each site were manually determined and listed here. Sites were grouped into regions so that their diversity trends could be plotted together and smoothed with a spline.
```{r creating region groupings, echo=TRUE}
tot<-read.csv("./composite/NAAll_raw.csv") #importing the composite raw data file for all the sites from the composite folder in the working directory

colnames(tot)[1] ="Sample" #renaming the first column in the raw data to Sample from its original name of site

tot$site<-gsub("[^a-zA-Z]", "", tot$Sample) #create a column with the name of the site for each sample; removing the numbers from the Sample column 

tot$reg<-0 #creating a region column

#creating a region dataframe with a row for each site and a region number associated with each site. The region grouping were determined via the DCA plotted above and manually listed
reg<-data.frame(site=unique(tot$site), region=c(4,4,4,5,2,1,3,4,4,1,4,1,2,4,2,4,5,6,4,4,5,3,1)) #region list ordered by site

#looping through each row in reg and tot to assign a region number for each sample in the tot data frame
for (j in 1:nrow(reg)){
  for (k in 1:nrow(tot)){
    if (reg$site[j]==tot$site[k]){
      tot$reg[k]<-reg$region[j]
    }
  }
}

tot<-tot %>% filter(.$reg!=0)
tot$reg<-as.character(tot$reg) #converting the numeric regions to character for discrete classification
```

### DCA with regions
This code replots the DCA from above but adds ellipses grouping the sites into the 6 different regions in order to visualize the regional classifications. The Grass site is the only site that does not match its grouping. Grass on the DCA is more aligned with the Intermountain West (IMW) than the Pacific Northwest but it's location is in Northern California. We decided to include Grass in the Pacific Northwest because of its location rather than IMW due to it appearing to be an outlier in our dataset.
```{r DCA Plot with regions, echo=TRUE}
reg<-reg %>% arrange(.$site,.$region)
cent$reg<-reg$region #giving the centroid dataframe region classifications as well
cent$reg<-as.character(cent$reg) #converting to characters to be used in the plot

#replotting the dca to add ellipses to highlight the different region groupings
dca.region<-ggplot(t2.dca.scoressites, aes(t2.dca1,t2.dca2, col=sit)) +
  geom_point(alpha=0.25, aes(col=sit), size=0.5, color="#000000") +
  theme_classic() + 
  stat_ellipse(geom="polygon", aes(group=sit, fill=sit), 
               type="t",level=0.3,alpha=0.5, fill="#000000", color="#000000") + 
  theme(
    legend.position = "none",
    panel.border = element_rect(colour = "black", fill=NA, size=0.25)
  ) + 
  ggtitle("Transformed ellipse with Regions") +
  #the code below is used to create ellipses around the sites that have been grouped into the same region, this is for the visualization of the region classifications that were made using the DCA
  geom_mark_ellipse(data=cent, aes(group=reg, label=reg), #excluding the grass site as it is the only one to not fit into the region classifications
                    color="red", linetype=1, size=0.5, label.fill=NA, con.size=0.5,
                    label.buffer = unit(48.5, "pt"), fill="red", alpha=0.1) +
  xlab("DCA axis 1") +
  ylab("DCA axis 2") 
  
  dca.region #plotting the DCA with region groupings highlighted

#saving the DCA as DCA_region_classification.pdf within the supplemental plots folder in the working directory  
ggsave("DCA_region_classification.pdf", plot=dca.region, path="./supplemental plots", device="pdf")
```

# Trend line plots
The below code chunks are used to plot the diversity trend lines. The majority of the code is used to identify the significant shifts in diversity via GAM derivatives and manually filtering to only show the trends during the significant periods via ifelse statements. The trend line plots are used for figures 3, 4, and 5 in the paper. 

### Data import and Significance
The below code is used to first import the tot.sm dataframe with the hill numbers and assign the region classifications to each site manually as was done above with the DCA. The hill numbers are smoothed for each region with a GAM, creating 6 GAMs for each order of q, and both taxonomic and functional diversity, for 36 total GAMs. The GAMs are then filtered by their derivatives to only include the years that are deemed significant based on the methods of Simpson, 2018.
```{r}
tot.sm<-read.csv("./composite/hill_master.csv") #importing the master file with both taxonomic and functional Hill numbers

#creating a dateframe with the name of each site as a row and the region classification in another column
reg<-data.frame(site=unique(tot.sm$site), 
region=c(4,4,4,5,2,1,3,4,4,1,4,1,2,4,2,4,5,6,4,4,5,3,1))
#creating a KyrBP column to put the time in thousands of years rather than just years
tot.sm<-tot.sm %>%
  mutate(KyrBP = .$YrBP/1000)

#assigning the region number to each row of tot.sm based on the site name
for (j in 1:nrow(reg)){
  for (k in 1:nrow(tot.sm)){
    if (reg$site[j]==tot.sm$site[k]){
      tot.sm$Region[k]<-reg$region[j]
    }
  }
}

#classifying the regions numbers as characters to prevent issues when plotting
tot.sm$Region<-as.character(tot.sm$Region)

#replacing rows 467 through 472 of the functional q=0, q=1, and q=2 with NA due to an artifact of the formulas having diversity approach infinity. This is because row 774 was 100% pine pollen which caused the formula to produce infinity. Removing these rows prevents the data from distorting the spline. 
tot.sm$fq0[467:472]<-NA
tot.sm$fq1[467:472]<-NA
tot.sm$fq2[467:472]<-NA
```

Averages diversity per site
```{r}
#creating empty data frame q.avgs with 7 columns and 0 rows
q.avgs<-data.frame(matrix(ncol = 7, nrow = 0))
colnames(q.avgs)<-c("Sample", "q0.m", "q1.m", "q2.m", "fq0.m", "fq1.m", "fq2.m")
sites<-unique(tot.sm$site)

#for each of the sites the average of each order q for taxonomic and functional diversity is taken
for (i in 1:length(sites)){
  q.avg <- tot.sm %>%
    filter(.$site == sites[i]) %>% #filtering to only include samples from site i
    #creating average columns for each order q
    mutate(q0.m = mean(.$q0, na.rm=T),
           q1.m = mean(.$q1, na.rm=T),
           q2.m = mean(.$q2, na.rm=T),
           fq0.m = mean(.$fq0, na.rm=T),
           fq1.m = mean(.$fq1, na.rm=T),
           fq2.m = mean(.$fq2, na.rm=T))
  q.avgs<-rbind(q.avg[c(1,153:159)], q.avgs) #stacking all of the region averages together to rebuild the original dataframe
}

tot.sm <- tot.sm %>% #merging the dataframe with the averages by the original tot.sm dataframe via the Sample column
  left_join(q.avgs)
```


```{r}
#creating two empty lists, one for the identified significant decreases and one for the identified significant increases
smth.dec<-list() #decreases
smth.inc<-list() #increases 

#looping through the six different diversity measures aka the taxonomic q=0, q=1, and q=2 and the functional q=0, q=1, and q=2
for (q in 1:6){
  reg.dec<-list() #creating a temporary list in the loop to store the significant decreases for an individual region
  reg.inc<-list() #creating a temporary list in the loop to store the significant increases for an individual region
  for (i in 1:6){ #looping through the 6 different regions
    tot.reg<-tot.sm%>% #filtering tot.sm to only include record for region i 
    filter(.$Region==i)
  
    smth<-gam(tot.reg[,q+145] ~ s(KyrBP), data=tot.reg, method="REML") #creating the GAM for the current (q) diversity metric and the current region i
  
    smth.d<-derivatives(smth, type="central") #taking the derivative of the generated GAM
  
    #because the x axis is time and we are looking at it in reverse (ie 150-0 rather than 0-150) decreases in the gam are actually increases when we plot them later with the reversed x axis. 
    reg.inc[[i]]<-smth.d$data[smth.d$upper<0 & smth.d$lower<0] #if the upper and lower CI are below 0 then it is deemed a signficant increase and stored within reg.inc as item [[i]] for the region number.
    reg.dec[[i]]<-smth.d$data[smth.d$upper>0 & smth.d$lower>0] #if the upper and lower CI are above 0 then it is a significant decrease and stored within reg.dec as item [[i]] for the region number
  }
  #once we've iterated through all 6 regions (i) we save the list of 6 items within smth.inc and smth.dec for the current diversity metric (q). The result is smth.inc and smth.dec have 6 items, for each q, and each of the 6 items has 6 trends.
  smth.inc[[q]]<-reg.inc
  smth.dec[[q]]<-reg.dec
}

#creating two empty lists, one for the taxonomic significant trends and one for the functional significant trends
sig.t<-list() #taxonomic trends
sig.f<-list() #functional trends

#looping through the three orders of q, q=0, q=1, and q=2
for (q in 1:3){
  sm.t<-data.frame() #creating an empty dataframe to store the taxonomic spline data for all 6 regions 
  sm.f<-data.frame() #creating an empty dataframe to store the functional spline data for all 6 regions
  #looping through all 6 regions
  for (i in 1:6){
    tot.reg<-tot.sm %>% #filtering for only the current region (i)
      filter(.$Region==i)
    
    #using the ggplot_build function to save the metadata of a geom_smooth with the method="gam". The ggplot GAM spline is the same as the mgcv GAM, however using the ggplot version makes it easier to plot in ggplot with the trend lines. This is for the taxonomic diversity
    dat.sm.t<-ggplot_build(ggplot(tot.reg, aes(KyrBP, tot.reg[,q+145]))+
    geom_smooth(mapping=aes(KyrBP, tot.reg[,q+145]), method="gam", formula=y ~ s(x, bs="tp"), method.args = list(family = gaussian(link = "identity")), n=100, na.rm=T))$data[[1]][1:2]
    
    dat.sm.t$Region[1:nrow(dat.sm.t)]<-i #adding a Region column with the region number (i) to the spline data
    sm.t<-rbind(sm.t, dat.sm.t) #using the rbind function the regional splines are combined into one dataframe, sm.t, that contains the taxonomic splines for all 6 regions.
 
    #we repeat the above code but for the functional diversity
    dat.sm.f<-ggplot_build(ggplot(tot.reg, aes(KyrBP, tot.reg[,q+148]))+
    geom_smooth(mapping=aes(KyrBP, tot.reg[,q+148]),method="gam", formula=y ~ s(x, bs="tp"), method.args = list(family = gaussian(link = "identity")), n=100, na.rm=T))$data[[1]][1:2]
    
    dat.sm.f$Region[1:nrow(dat.sm.f)]<-i
    sm.f<-rbind(sm.f, dat.sm.f)
  }
  sig.t[[q]]<-sm.t #the splines for all regions are then added to the list as item q for the diversity metric. The result is a list with 3 items for each q, and each item is a dataframe with the splines of all 6 regions. This is for taxonomic diversity.
  sig.f[[q]]<-sm.f #this is for functional diversity
}

#The below code is identical to the above except for the fact that it is calculating the significant trends for the plots of the normalized diversity ((x-mean)/mean)
#----------------------------------------------
#creating two empty lists, one for the identified significant decreases and one for the identified significant increases
smth.dec.m<-list() #decreases
smth.inc.m<-list() #increases 

#looping through the six different diversity measures aka the taxonomic q=0, q=1, and q=2 and the functional q=0, q=1, and q=2
for (q in 1:6){
  reg.dec.m<-list() #creating a temporary list in the loop to store the significant decreases for an individual region
  reg.inc.m<-list() #creating a temporary list in the loop to store the significant increases for an individual region
  for (i in 1:6){ #looping through the 6 different regions
    tot.reg<-tot.sm%>% #filtering tot.sm to only include record for region i 
    filter(.$Region==i)
  
    smth.m<-gam((tot.reg[,q+145]-tot.reg[,q+153])/tot.reg[,q+153] ~ s(KyrBP), data=tot.reg, method="REML") #creating the GAM for the current (q) diversity metric and the current region i
  
    smth.d.m<-derivatives(smth.m, type="central") #taking the derivative of the generated GAM
  
    #because the x axis is time and we are looking at it in reverse (ie 150-0 rather than 0-150) decreases in the gam are actually increases when we plot them later with the reversed x axis. 
    reg.inc.m[[i]]<-smth.d.m$data[smth.d.m$upper<0 & smth.d.m$lower<0] #if the upper and lower CI are below 0 then it is deemed a signficant increase and stored within reg.inc as item [[i]] for the region number.
    reg.dec.m[[i]]<-smth.d.m$data[smth.d.m$upper>0 & smth.d.m$lower>0] #if the upper and lower CI are above 0 then it is a significant decrease and stored within reg.dec as item [[i]] for the region number
  }
  #once we've iterated through all 6 regions (i) we save the list of 6 items within smth.inc and smth.dec for the current diversity metric (q). The result is smth.inc and smth.dec have 6 items, for each q, and each of the 6 items has 6 trends.
  smth.inc.m[[q]]<-reg.inc.m
  smth.dec.m[[q]]<-reg.dec.m
}

#creating two empty lists, one for the taxonomic significant trends and one for the functional significant trends
sig.t.m<-list() #taxonomic trends
sig.f.m<-list() #functional trends

#looping through the three orders of q, q=0, q=1, and q=2
for (q in 1:3){
  sm.t.m<-data.frame() #creating an empty dataframe to store the taxonomic spline data for all 6 regions 
  sm.f.m<-data.frame() #creating an empty dataframe to store the functional spline data for all 6 regions
  #looping through all 6 regions
  for (i in 1:6){
    tot.reg<-tot.sm %>% #filtering for only the current region (i)
      filter(.$Region==i)
    
    #using the ggplot_build function to save the metadata of a geom_smooth with the method="gam". The ggplot GAM spline is the same as the mgcv GAM, however using the ggplot version makes it easier to plot in ggplot with the trend lines. This is for the taxonomic diversity
    dat.sm.t.m<-ggplot_build(ggplot(tot.reg, aes(KyrBP, (tot.reg[,q+145]-tot.reg[,q+153])/tot.reg[,q+153])) +
    geom_smooth(mapping=aes(KyrBP, ((tot.reg[,q+145]-tot.reg[,q+153])/tot.reg[,q+153])), method="gam", formula=y ~ s(x, bs="tp"), method.args = list(family = gaussian(link = "identity")),  n=100, na.rm=T))$data[[1]][1:2]
    
    dat.sm.t.m$Region[1:nrow(dat.sm.t.m)]<-i #adding a Region column with the region number (i) to the spline data
    sm.t.m<-rbind(sm.t.m, dat.sm.t.m) #using the rbind function the regional splines are combined into one dataframe, sm.t, that contains the taxonomic splines for all 6 regions.
 
    #we repeat the above code but for the functional diversity
    dat.sm.f.m<-ggplot_build(ggplot(tot.reg, aes(KyrBP, (tot.reg[,q+148]-tot.reg[,q+156])/tot.reg[,q+156]))+
    geom_smooth(mapping=aes(KyrBP, ((tot.reg[,q+148]-tot.reg[,q+156])/tot.reg[,q+156])), method="gam", formula=y ~ s(x, bs="tp"), method.args = list(family = gaussian(link = "identity")), n=100, na.rm=T))$data[[1]][1:2]
    
    dat.sm.f.m$Region[1:nrow(dat.sm.f.m)]<-i
    sm.f.m<-rbind(sm.f.m, dat.sm.f.m)
  }
  sig.t.m[[q]]<-sm.t.m #the splines for all regions are then added to the list as item q for the diversity metric. The result is a list with 3 items for each q, and each item is a dataframe with the splines of all 6 regions. This is for taxonomic diversity.
  sig.f.m[[q]]<-sm.f.m #this is for functional diversity
}
```

### Significance Filtering
The below code is overwhelming at first but its purpose is simple. The extracted values for the ggplot GAMs need to be filtered to only include dates with the identified significant increases and decreases. To do this we use ifelse() to check to see if there are x values that fall within the range of values from smth.dec or smth.inc. This was manually done by viewing the x values for each region and q value within smth.dec and smth.inc and writing out the ifelse() statements. Many trends have multiple periods of significant trends, to prevent the inclusion of x values that fall between the significant periods, multiple iflelse() statements had to be used. Additionally, in the cases with multiple significant trends, each signficant period was given a different number, for example if there were three periods, then trends would be numbers 1, 2, and 3. This was done so when plotting, ggplot would not try and connect the periods. This was done for both significant increases and decreases for each of the seven regions, and the three q orders for both taxonomic and functional diversity. As such there are ((6 regions * 3 q values) * 2 trends(increases and decreases) * 2 metrics (taxonomic and functional)) or 72 ifelse blocks. This is doubled, one block of 72 for the raw diversity and one block of 72 for the normalized diversity.
```{r}
#The below code is to identify the significant increases and decreases for taxonomic diversity

#for each q within sig.t, we create a decrease column and an increase column and fill with NA's, significant periods with have their NA's replaced with sequential numbers
#for clarity, indexing through sig.t or sig.t can be through of as: sig.t[[q value]]
sig.t[[1]]$dec<-NA
sig.t[[2]]$dec<-NA
sig.t[[3]]$dec<-NA

sig.t[[1]]$inc<-NA
sig.t[[2]]$inc<-NA
sig.t[[3]]$inc<-NA

#looping through every row of sig.t[[1]] which is the same number as the other q values (sig.t[[2]] and sig.t[[3]])). This is so the if statement can be applied to every row, one at a time.
for (i in 1:nrow(sig.t[[1]])){
  
  ########q0
  
  #rather than go through each block, this will be described in detail and can be applied to any of the below.
  
  #this pattern is repeated for each region and q value
  if (sig.t[[1]]$Region[i]==1) #This block is to identify the significant trends within region 1 so the first step is to check if the current row of sig.t is in region 1, if it is then the below code is executed and if it is not then nothing is done
    #Region 1 of q=0 has 2 significant decreases, so we set up two ifelse() statements
    {ifelse(sig.t[[1]]$x[i] >= smth.dec[[1]][[1]][1] & sig.t[[1]]$x[i] <= smth.dec[[1]][[1]][9],
          #if the x value falls between row 1 and 12 of smth.dec q=0 and region 1, then the dec column is given a value of 1. The indexing through the lists can be confusing so this is the key: smth.dec[[q value]][[region]][row #]. The same is true for smth.inc
            sig.t[[1]]$dec[i]<-1, sig.t[[1]]$dec[i]<-NA)} #If the x value does not fall within the significant ranges, it is given a value of NA, indicating it is not significant.
  
  if (sig.t[[1]]$Region[i]==2)
    {ifelse(sig.t[[1]]$x[i] >= smth.dec[[1]][[2]][1] & sig.t[[1]]$x[i] <= smth.dec[[1]][[2]][8],  
    sig.t[[1]]$dec[i]<-1, 
    ifelse(sig.t[[1]]$x[i] >= smth.dec[[1]][[2]][9] & sig.t[[1]]$x[i] <= smth.dec[[1]][[2]][23], 
    #since there is a second significant decrease, another ifelse() statement is used in the place of the else portion of the initial ifelse() statement
    sig.t[[1]]$dec[i]<-2, sig.t[[1]]$dec[i]<-NA))}
  
  if (sig.t[[1]]$Region[i]==3)
    {ifelse(sig.t[[1]]$x[i] >= smth.dec[[1]][[3]][1] & sig.t[[1]]$x[i] <= smth.dec[[1]][[3]][11],  
    sig.t[[1]]$dec[i]<-1, sig.t[[1]]$dec[i]<-NA)}
  
  if (sig.t[[1]]$Region[i]==4)
    {ifelse(sig.t[[1]]$x[i] >= smth.dec[[1]][[4]][1] & sig.t[[1]]$x[i] <= smth.dec[[1]][[4]][18],
    sig.t[[1]]$dec[i]<-1, sig.t[[1]]$dec[i]<-NA)} 
  
  if (sig.t[[1]]$Region[i]==5){} #a region with no significant periods is empty
  
  if (sig.t[[1]]$Region[i]==6)
    {ifelse(sig.t[[1]]$x[i] >= smth.dec[[1]][[6]][1] & sig.t[[1]]$x[i] <= smth.dec[[1]][[6]][16],  
    sig.t[[1]]$dec[i]<-1, 
    ifelse(sig.t[[1]]$x[i] >= smth.dec[[1]][[6]][17] & sig.t[[1]]$x[i] <= smth.dec[[1]][[6]][27], 
    sig.t[[1]]$dec[i]<-2, sig.t[[1]]$dec[i]<-NA))}
 
   ###########q1
  if (sig.t[[2]]$Region[i]==1)
    {ifelse(sig.t[[2]]$x[i] >= smth.dec[[2]][[1]][1] & sig.t[[2]]$x[i] <= smth.dec[[2]][[1]][3],  
    sig.t[[2]]$dec[i]<-1, 
    ifelse(sig.t[[2]]$x[i] >= smth.dec[[2]][[1]][4] & sig.t[[2]]$x[i] <= smth.dec[[2]][[1]][14],
    sig.t[[2]]$dec[i]<-2, sig.t[[2]]$dec[i]<-NA))}
  
  if (sig.t[[2]]$Region[i]==2)
    {ifelse(sig.t[[2]]$x[i] >= smth.dec[[2]][[2]][1] & sig.t[[2]]$x[i] <= smth.dec[[2]][[2]][24],  
    sig.t[[2]]$dec[i]<-1, sig.t[[2]]$dec[i]<-NA)}
  
  if (sig.t[[2]]$Region[i]==3)
    {ifelse(sig.t[[2]]$x[i] >= smth.dec[[2]][[3]][1] & sig.t[[2]]$x[i] <= smth.dec[[2]][[3]][15],  
    sig.t[[2]]$dec[i]<-1, 
    ifelse(sig.t[[2]]$x[i] >= smth.dec[[2]][[3]][16] & sig.t[[2]]$x[i] <= smth.dec[[2]][[3]][28], 
    sig.t[[2]]$dec[i]<-2, sig.t[[2]]$dec[i]<-NA))}
  
  if (sig.t[[2]]$Region[i]==4)
    {ifelse(sig.t[[2]]$x[i] >= smth.dec[[2]][[4]][1] & sig.t[[2]]$x[i] <= smth.dec[[2]][[4]][29],  
    sig.t[[2]]$dec[i]<-1, sig.t[[2]]$dec[i]<-NA)}
  
  if (sig.t[[2]]$Region[i]==5)
    {ifelse(sig.t[[2]]$x[i] >= smth.dec[[2]][[5]][1] & sig.t[[2]]$x[i] <= smth.dec[[2]][[5]][21],  
    sig.t[[2]]$dec[i]<-1, 
    ifelse(sig.t[[2]]$x[i] >= smth.dec[[2]][[5]][22] & sig.t[[2]]$x[i] <= smth.dec[[2]][[5]][35],
    sig.t[[2]]$dec[i]<-2, sig.t[[2]]$dec[i]<-NA))}
  
  if (sig.t[[2]]$Region[i]==6)
    {ifelse(sig.t[[2]]$x[i] >= smth.dec[[2]][[6]][1] & sig.t[[2]]$x[i] <= smth.dec[[2]][[6]][119],  
    sig.t[[2]]$dec[i]<-1, sig.t[[2]]$dec[i]<-NA)}
  
  ######q2
  if (sig.t[[3]]$Region[i]==1)
    {ifelse(sig.t[[3]]$x[i] >= smth.dec[[3]][[1]][1] & sig.t[[3]]$x[i] <= smth.dec[[3]][[1]][14],  
    sig.t[[3]]$dec[i]<-1, sig.t[[3]]$dec[i]<-NA)}
 
   if (sig.t[[3]]$Region[i]==2)
    {ifelse(sig.t[[3]]$x[i] >= smth.dec[[3]][[2]][1] & sig.t[[3]]$x[i] <= smth.dec[[3]][[2]][30],  
    sig.t[[3]]$dec[i]<-1, sig.t[[3]]$dec[i]<-NA)}
  
  if (sig.t[[3]]$Region[i]==3)
    {ifelse(sig.t[[3]]$x[i] >= smth.dec[[3]][[3]][1] & sig.t[[3]]$x[i] <= smth.dec[[3]][[3]][16],  
    sig.t[[3]]$dec[i]<-1, 
    ifelse(sig.t[[3]]$x[i] >= smth.dec[[3]][[3]][17] & sig.t[[3]]$x[i] <= smth.dec[[3]][[3]][29], 
    sig.t[[3]]$dec[i]<-2, sig.t[[3]]$dec[i]<-NA))}
  
  if (sig.t[[3]]$Region[i]==4)
    {ifelse(sig.t[[3]]$x[i] >= smth.dec[[3]][[4]][1] & sig.t[[3]]$x[i] <= smth.dec[[3]][[4]][25],  
    sig.t[[3]]$dec[i]<-1, 
    ifelse(sig.t[[3]]$x[i] >= smth.dec[[3]][[4]][26] & sig.t[[3]]$x[i] <= smth.dec[[3]][[4]][55], 
    sig.t[[3]]$dec[i]<-2, sig.t[[3]]$dec[i]<-NA))}
  
  if (sig.t[[3]]$Region[i]==5)
    {ifelse(sig.t[[3]]$x[i] >= smth.dec[[3]][[5]][1] & sig.t[[3]]$x[i] <= smth.dec[[3]][[5]][5],  
    sig.t[[3]]$dec[i]<-1, 
    ifelse(sig.t[[3]]$x[i] >= smth.dec[[3]][[5]][6] & sig.t[[3]]$x[i] <= smth.dec[[3]][[5]][19],
    sig.t[[3]]$dec[i]<-2, 
    ifelse(sig.t[[3]]$x[i] >= smth.dec[[3]][[5]][20] & sig.t[[3]]$x[i] <= smth.dec[[3]][[5]][33],
    sig.t[[3]]$dec[i]<-3, sig.t[[3]]$dec[i]<-NA)))}
  
  if (sig.t[[3]]$Region[i]==6)
    {ifelse(sig.t[[3]]$x[i] >= smth.dec[[3]][[6]][1] & sig.t[[3]]$x[i] <= smth.dec[[3]][[6]][113],  
    sig.t[[3]]$dec[i]<-1, sig.t[[3]]$dec[i]<-NA)}

#The below code is for the taxonomic significant increases. The pattern is the same except for using smth.inc and adding values to the inc column of sig.t rather than the dec.
  
  ########q0
  if (sig.t[[1]]$Region[i]==1)
    {ifelse(sig.t[[1]]$x[i] >= smth.inc[[1]][[1]][1] & sig.t[[1]]$x[i] <= smth.inc[[1]][[1]][22],  
    sig.t[[1]]$inc[i]<-1, sig.t[[1]]$inc[i]<-NA)}
  
  if (sig.t[[1]]$Region[i]==2)
    {ifelse(sig.t[[1]]$x[i] >= smth.inc[[1]][[2]][1] & sig.t[[1]]$x[i] <= smth.inc[[1]][[2]][14],  
    sig.t[[1]]$inc[i]<-1, 
    ifelse(sig.t[[1]]$x[i] >= smth.inc[[1]][[2]][15] & sig.t[[1]]$x[i] <= smth.inc[[1]][[2]][21],
    sig.t[[1]]$inc[i]<-2, 
    ifelse(sig.t[[1]]$x[i] >= smth.inc[[1]][[2]][22] & sig.t[[1]]$x[i] <= smth.inc[[1]][[2]][141],
    sig.t[[1]]$dec[i]<-3, sig.t[[1]]$inc[i]<-NA)))}
  
  if (sig.t[[1]]$Region[i]==3)
    {ifelse(sig.t[[1]]$x[i] >= smth.inc[[1]][[3]][1] & sig.t[[1]]$x[i] <= smth.inc[[1]][[3]][13],  
    sig.t[[1]]$inc[i]<-1, 
    ifelse(sig.t[[1]]$x[i] >= smth.inc[[1]][[3]][14] & sig.t[[1]]$x[i] <= smth.inc[[1]][[3]][20],
    sig.t[[1]]$inc[i]<-2, sig.t[[1]]$inc[i]<-NA))}
  
  if (sig.t[[1]]$Region[i]==4)
    {ifelse(sig.t[[1]]$x[i] >= smth.inc[[1]][[4]][1] & sig.t[[1]]$x[i] <= smth.inc[[1]][[4]][15],
    sig.t[[1]]$inc[i]<-1, sig.t[[1]]$inc<-NA)}
  
  if (sig.t[[1]]$Region[i]==5)
    {ifelse(sig.t[[1]]$x[i] >= smth.inc[[1]][[5]][1] & sig.t[[1]]$x[i] <= smth.inc[[1]][[5]][200],  
    sig.t[[1]]$inc[i]<-1, sig.t[[1]]$inc[i]<-NA)}
  
  if (sig.t[[1]]$Region[i]==6)
    {ifelse(sig.t[[1]]$x[i] >= smth.inc[[1]][[6]][1] & sig.t[[1]]$x[i] <= smth.inc[[1]][[6]][15],  
    sig.t[[1]]$inc[i]<-1, 
    ifelse(sig.t[[1]]$x[i] >= smth.inc[[1]][[6]][16] & sig.t[[1]]$x[i] <= smth.inc[[1]][[6]][112], 
    sig.t[[1]]$inc[i]<-2, sig.t[[1]]$inc[i]<-NA))}
  
  ###########q1
  if (sig.t[[2]]$Region[i]==1){}
  
  if (sig.t[[2]]$Region[i]==2){}
  
  if (sig.t[[2]]$Region[i]==3)
    {ifelse(sig.t[[2]]$x[i] >= smth.inc[[2]][[3]][1] & sig.t[[2]]$x[i] <= smth.inc[[2]][[3]][12],  
    sig.t[[2]]$inc[i]<-1, 
    ifelse(sig.t[[2]]$x[i] >= smth.inc[[2]][[3]][13] & sig.t[[2]]$x[i] <= smth.inc[[2]][[3]][23], 
    sig.t[[2]]$inc[i]<-2, sig.t[[2]]$inc[i]<-NA))}
  
  if (sig.t[[2]]$Region[i]==4)
    {ifelse(sig.t[[2]]$x[i] >= smth.inc[[2]][[4]][1] & sig.t[[2]]$x[i] <= smth.inc[[2]][[4]][29],  
    sig.t[[2]]$inc[i]<-1, sig.t[[2]]$inc[i]<-NA)}
  
  if (sig.t[[2]]$Region[i]==5)
    {ifelse(sig.t[[2]]$x[i] >= smth.inc[[2]][[5]][1] & sig.t[[2]]$x[i] <= smth.inc[[2]][[5]][13],  
    sig.t[[2]]$inc[i]<-1, 
    ifelse(sig.t[[2]]$x[i] >= smth.inc[[2]][[5]][14] & sig.t[[2]]$x[i] <= smth.inc[[2]][[5]][29], 
    sig.t[[2]]$inc[i]<-2,
    ifelse(sig.t[[2]]$x[i] >= smth.inc[[2]][[5]][30] & sig.t[[2]]$x[i] <= smth.inc[[2]][[5]][32],
    sig.t[[2]]$inc[i]<-3, sig.t[[2]]$inc[i]<-NA)))}
  
  if (sig.t[[2]]$Region[i]==6)
    {ifelse(sig.t[[2]]$x[i] >= smth.inc[[2]][[6]][1] & sig.t[[2]]$x[i] <= smth.inc[[2]][[6]][30],  
    sig.t[[2]]$inc[i]<-1, 
    ifelse(sig.t[[2]]$x[i] >= smth.inc[[2]][[6]][31] & sig.t[[2]]$x[i] <= smth.inc[[2]][[6]][49],
    sig.t[[2]]$inc[i]<-2, sig.t[[2]]$inc[i]<-NA))}
  
  ######q2
  if (sig.t[[3]]$Region[i]==1){}
  
  if (sig.t[[3]]$Region[i]==2){}
  
  if (sig.t[[3]]$Region[i]==3)
    {ifelse(sig.t[[3]]$x[i] >= smth.inc[[3]][[3]][1] & sig.t[[3]]$x[i] <= smth.inc[[3]][[3]][13],  
    sig.t[[3]]$inc[i]<-1, 
    ifelse(sig.t[[3]]$x[i] >= smth.inc[[3]][[3]][14] & sig.t[[3]]$x[i] <= smth.inc[[3]][[3]][25], 
    sig.t[[3]]$inc[i]<-2, sig.t[[3]]$inc[i]<-NA))}
  
  if (sig.t[[3]]$Region[i]==4)
    {ifelse(sig.t[[3]]$x[i] >= smth.inc[[3]][[4]][1] & sig.t[[3]]$x[i] <= smth.inc[[3]][[4]][33],  
    sig.t[[3]]$inc[i]<-1, 
    ifelse(sig.t[[3]]$x[i] >= smth.inc[[3]][[4]][34] & sig.t[[3]]$x[i] <= smth.inc[[3]][[4]][37],
    sig.t[[3]]$inc[i]<-2, sig.t[[3]]$inc[i]<-NA))}
  
  if (sig.t[[3]]$Region[i]==5)
    {ifelse(sig.t[[3]]$x[i] >= smth.inc[[3]][[5]][1] & sig.t[[3]]$x[i] <= smth.inc[[3]][[5]][8],  
    sig.t[[3]]$inc[i]<-1, 
    ifelse(sig.t[[3]]$x[i] >= smth.inc[[3]][[5]][9] & sig.t[[3]]$x[i] <= smth.inc[[3]][[5]][24], 
    sig.t[[3]]$inc[i]<-2,
    ifelse(sig.t[[3]]$x[i] >= smth.inc[[3]][[5]][25] & sig.t[[3]]$x[i] <= smth.inc[[3]][[5]][30],
    sig.t[[3]]$inc[i]<-3, sig.t[[3]]$inc[i]<-NA)))}
  
  if (sig.t[[3]]$Region[i]==6)
    {ifelse(sig.t[[3]]$x[i] >= smth.inc[[3]][[6]][1] & sig.t[[3]]$x[i] <= smth.inc[[3]][[6]][28],  
    sig.t[[3]]$inc[i]<-1, 
    ifelse(sig.t[[3]]$x[i] >= smth.inc[[3]][[6]][29] & sig.t[[3]]$x[i] <= smth.inc[[3]][[6]][41],
    sig.t[[3]]$inc[i]<-2, sig.t[[3]]$inc[i]<-NA))}
} #here the loop ends as we have iterated through all of the q values and regions for increases and decreases

#the below code is the same as the above, but it is not repeated for all of the functional diversity trends. As such we use sig.f rather than sig.t. The pattern is the same as above. 
sig.f[[1]]$dec<-NA
sig.f[[2]]$dec<-NA
sig.f[[3]]$dec<-NA

sig.f[[1]]$inc<-NA
sig.f[[2]]$inc<-NA
sig.f[[3]]$inc<-NA

#significant functional decreases
#looping through each row of the functional trends
for (i in 1:nrow(sig.f[[1]])){
  ########fq0
  if (sig.f[[1]]$Region[i]==1){}
  
  if (sig.f[[1]]$Region[i]==2)
    {ifelse(sig.f[[1]]$x[i] >= smth.dec[[4]][[2]][1] & sig.f[[1]]$x[i] <= smth.dec[[4]][[2]][2],  
    sig.f[[1]]$dec[i]<-1, 
    ifelse(sig.f[[1]]$x[i] >= smth.dec[[4]][[2]][3] & sig.f[[1]]$x[i] <= smth.dec[[4]][[2]][12],
    sig.f[[1]]$dec[i]<-2,
    ifelse(sig.f[[1]]$x[i] >= smth.dec[[4]][[2]][13] & sig.f[[1]]$x[i] <= smth.dec[[4]][[2]][16],       sig.f[[1]]$dec[i]<-3, sig.f[[1]]$dec[i]<-NA)))}
  
  if (sig.f[[1]]$Region[i]==3)
    {ifelse(sig.f[[1]]$x[i] >= smth.dec[[4]][[3]][1] & sig.f[[1]]$x[i] <= smth.dec[[4]][[3]][11],  
    sig.f[[1]]$dec[i]<-1,
    ifelse(sig.f[[1]]$x[i] >= smth.dec[[4]][[3]][12] & sig.f[[1]]$x[i] <= smth.dec[[4]][[3]][14],
    sig.f[[1]]$dec[i]<-2, sig.f[[1]]$dec[i]<-NA))}
  
  if (sig.f[[1]]$Region[i]==4)
    {ifelse(sig.f[[1]]$x[i] >= smth.dec[[4]][[4]][1] & sig.f[[1]]$x[i] <= smth.dec[[4]][[4]][26],  
    sig.f[[1]]$dec[i]<-1, 
    ifelse(sig.f[[1]]$x[i] >= smth.dec[[4]][[4]][27] & sig.f[[1]]$x[i] <= smth.dec[[4]][[4]][50],       sig.f[[1]]$dec[i]<-2, sig.f[[1]]$dec[i]<-NA))}
  
  if (sig.f[[1]]$Region[i]==5){}
  
  if (sig.f[[1]]$Region[i]==6)
    {ifelse(sig.f[[1]]$x[i] >= smth.dec[[4]][[6]][1] & sig.f[[1]]$x[i] <= smth.dec[[4]][[6]][23],  
    sig.f[[1]]$dec[i]<-1, 
    ifelse(sig.f[[1]]$x[i] >= smth.dec[[4]][[6]][24] & sig.f[[1]]$x[i] <= smth.dec[[4]][[6]][37], 
    sig.f[[1]]$dec[i]<-2, sig.f[[1]]$dec[i]<-NA))}
  
  ###########fq1
  if (sig.t[[2]]$Region[i]==1)
    {ifelse(sig.f[[2]]$x[i] >= smth.dec[[5]][[1]][1] & sig.f[[2]]$x[i] <= smth.dec[[5]][[1]][18],  
    sig.f[[2]]$dec[i]<-1, sig.f[[2]]$dec[i]<-NA)}
  
  if (sig.f[[2]]$Region[i]==2)
    {ifelse(sig.f[[2]]$x[i] >= smth.dec[[5]][[2]][1] & sig.f[[2]]$x[i] <= smth.dec[[5]][[2]][17],  
    sig.f[[2]]$dec[i]<-1, sig.f[[2]]$dec[i]<-NA)}
  
  if (sig.f[[2]]$Region[i]==3)
    {ifelse(sig.f[[2]]$x[i] >= smth.dec[[5]][[3]][1] & sig.f[[2]]$x[i] <= smth.dec[[5]][[3]][13],  
    sig.f[[2]]$dec[i]<-1, 
    ifelse(sig.f[[2]]$x[i] >= smth.dec[[5]][[3]][14] & sig.f[[2]]$x[i] <= smth.dec[[5]][[3]][25],
    sig.f[[2]]$dec[i]<-3, sig.f[[2]]$dec[i]<-NA))}
  
  if (sig.f[[2]]$Region[i]==4)
    {ifelse(sig.f[[2]]$x[i] >= smth.dec[[5]][[4]][1] & sig.f[[2]]$x[i] <= smth.dec[[5]][[4]][38],  
    sig.f[[2]]$dec[i]<-1, 
    ifelse(sig.f[[2]]$x[i] >= smth.dec[[5]][[4]][39] & sig.f[[2]]$x[i] <= smth.dec[[5]][[4]][50],       sig.f[[2]]$dec[i]<-2, sig.f[[2]]$dec[i]<-NA))}
  
  if (sig.f[[2]]$Region[i]==5)
    {ifelse(sig.f[[2]]$x[i] >= smth.dec[[5]][[5]][1] & sig.f[[2]]$x[i] <= smth.dec[[5]][[5]][10],  
    sig.f[[2]]$dec[i]<-1, sig.f[[2]]$dec[i]<-NA)}
  
  if (sig.f[[2]]$Region[i]==6)
    {ifelse(sig.f[[2]]$x[i] >= smth.dec[[5]][[6]][1] & sig.f[[2]]$x[i] <= smth.dec[[5]][[6]][122],  
    sig.f[[2]]$dec[i]<-1, sig.f[[2]]$dec[i]<-NA)}
  
  ######fq2
  if (sig.f[[3]]$Region[i]==1)
    {ifelse(sig.f[[3]]$x[i] >= smth.dec[[6]][[1]][1] & sig.f[[3]]$x[i] <= smth.dec[[6]][[1]][31],  
    sig.f[[3]]$dec[i]<-1, sig.f[[3]]$dec[i]<-NA)}
  
  if (sig.f[[3]]$Region[i]==2)
    {ifelse(sig.f[[3]]$x[i] >= smth.dec[[6]][[2]][1] & sig.f[[3]]$x[i] <= smth.dec[[6]][[2]][22],  
    sig.f[[3]]$dec[i]<-1, sig.f[[3]]$dec[i]<-NA)}
  
  if (sig.f[[3]]$Region[i]==3)
    {ifelse(sig.f[[3]]$x[i] >= smth.dec[[6]][[3]][1] & sig.f[[3]]$x[i] <= smth.dec[[6]][[3]][12],  
    sig.f[[3]]$dec[i]<-1, 
    ifelse(sig.f[[3]]$x[i] >= smth.dec[[6]][[3]][13] & sig.f[[3]]$x[i] <= smth.dec[[6]][[3]][25],
    sig.f[[3]]$dec[i]<2, sig.f[[3]]$dec[i]<-NA))}
  
  if (sig.f[[3]]$Region[i]==4)
    {ifelse(sig.f[[3]]$x[i] >= smth.dec[[6]][[4]][1] & sig.f[[3]]$x[i] <= smth.dec[[6]][[4]][37],  
    sig.f[[3]]$dec[i]<-1, 
    ifelse(sig.f[[3]]$x[i] >= smth.dec[[6]][[4]][38] & sig.f[[3]]$x[i] <= smth.dec[[6]][[4]][54], 
    sig.f[[3]]$dec[i]<-2, sig.f[[3]]$dec[i]<-NA))}
  
  if (sig.f[[3]]$Region[i]==5)
    {ifelse(sig.f[[3]]$x[i] >= smth.dec[[6]][[5]][1] & sig.f[[3]]$x[i] <= smth.dec[[6]][[5]][14],  
    sig.f[[3]]$dec[i]<-1, sig.f[[3]]$dec[i]<-NA)}
  
  if (sig.f[[3]]$Region[i]==6)
    {ifelse(sig.f[[3]]$x[i] >= smth.dec[[6]][[6]][1] & sig.f[[3]]$x[i] <= smth.dec[[6]][[6]][120],  
    sig.f[[3]]$dec[i]<-1, sig.f[[3]]$dec[i]<-NA)}

#significant functional increases
  ########fq0
  if (sig.f[[1]]$Region[i]==1)
    {ifelse(sig.f[[1]]$x[i] >= smth.inc[[4]][[1]][1] & sig.f[[1]]$x[i] <= smth.inc[[4]][[1]][23],  
    sig.f[[1]]$inc[i]<-1, sig.f[[1]]$inc[i]<-NA)}
  
  if (sig.f[[1]]$Region[i]==2)
    {ifelse(sig.f[[1]]$x[i] >= smth.inc[[4]][[2]][1] & sig.f[[1]]$x[i] <= smth.inc[[4]][[2]][16],  
    sig.f[[1]]$inc[i]<-1, 
    ifelse(sig.f[[1]]$x[i] >= smth.inc[[4]][[2]][17] & sig.f[[1]]$x[i] <= smth.inc[[4]][[2]][134],
    sig.f[[1]]$inc[i]<-2, sig.f[[1]]$inc[i]<-NA))}
  
  if (sig.f[[1]]$Region[i]==3)
    {ifelse(sig.f[[1]]$x[i] >= smth.inc[[4]][[3]][1] & sig.f[[1]]$x[i] <= smth.inc[[4]][[3]][18],  
    sig.f[[1]]$inc[i]<-1, 
    ifelse(sig.f[[1]]$x[i] >= smth.inc[[4]][[3]][19] & sig.f[[1]]$x[i] <= smth.inc[[4]][[3]][23],
    sig.f[[1]]$inc[i]<-2, 
    ifelse(sig.f[[1]]$x[i] >= smth.inc[[4]][[3]][24] & sig.f[[1]]$x[i] <= smth.inc[[4]][[3]][153],
    sig.f[[1]]$inc[i]<-3, sig.f[[1]]$inc[i]<-NA)))}
   
  if (sig.f[[1]]$Region[i]==4)
    {ifelse(sig.f[[1]]$x[i] >= smth.inc[[4]][[4]][1] & sig.f[[1]]$x[i] <= smth.inc[[4]][[4]][5],  
    sig.f[[1]]$inc[i]<-1, 
    ifelse(sig.f[[1]]$x[i] >= smth.inc[[4]][[4]][6] & sig.f[[1]]$x[i] <= smth.inc[[4]][[4]][33],
    sig.f[[1]]$inc[i]<-2, sig.f[[1]]$inc[i]<-NA))}
  
  if (sig.f[[1]]$Region[i]==5)
    {ifelse(sig.f[[1]]$x[i] >= smth.inc[[4]][[5]][1] & sig.f[[1]]$x[i] <= smth.inc[[4]][[5]][44],  
    sig.f[[1]]$inc[i]<-1, sig.f[[1]]$inc[i]<-NA)}
  
  if (sig.f[[1]]$Region[i]==6)
    {ifelse(sig.f[[1]]$x[i] >= smth.inc[[4]][[6]][1] & sig.f[[1]]$x[i] <= smth.inc[[4]][[6]][9],  
    sig.f[[1]]$inc[i]<-1, 
    ifelse(sig.f[[1]]$x[i] >= smth.inc[[4]][[6]][10] & sig.f[[1]]$x[i] <= smth.inc[[4]][[6]][118], 
    sig.f[[1]]$inc[i]<-2, sig.f[[1]]$inc[i]<-NA))}
  
  ###########fq1
  if (sig.t[[2]]$Region[i]==1){}
  
  if (sig.f[[2]]$Region[i]==2)
    {ifelse(sig.f[[2]]$x[i] >= smth.inc[[5]][[2]][1] & sig.f[[2]]$x[i] <= smth.inc[[5]][[2]][22],  
    sig.f[[2]]$inc[i]<-1, 
    ifelse(sig.f[[2]]$x[i] >= smth.inc[[5]][[2]][23] & sig.f[[2]]$x[i] <= smth.inc[[5]][[2]][129],
    sig.f[[2]]$inc[i]<-2, sig.f[[2]]$inc[i]<-NA))}
  
  if (sig.f[[2]]$Region[i]==3)
    {ifelse(sig.f[[2]]$x[i] >= smth.inc[[5]][[3]][1] & sig.f[[2]]$x[i] <= smth.inc[[5]][[3]][8],  
    sig.f[[2]]$inc[i]<-1,
    ifelse(sig.f[[2]]$x[i] >= smth.inc[[5]][[3]][9] & sig.f[[2]]$x[i] <= smth.inc[[5]][[3]][13],         sig.f[[2]]$inc[i]<-2, sig.f[[2]]$inc[i]<-NA))}
  
  if (sig.f[[2]]$Region[i]==4)
    {ifelse(sig.f[[2]]$x[i] >= smth.inc[[5]][[4]][1] & sig.f[[2]]$x[i] <= smth.inc[[5]][[4]][30],  
    sig.f[[2]]$inc[i]<-1,
    ifelse(sig.f[[2]]$x[i] >= smth.inc[[5]][[4]][31] & sig.f[[2]]$x[i] <= smth.inc[[5]][[4]][65],       sig.f[[2]]$inc[i]<-2, sig.f[[2]]$inc[i]<-NA))}
  
  if (sig.f[[2]]$Region[i]==5)
    {ifelse(sig.f[[2]]$x[i] >= smth.inc[[5]][[5]][1] & sig.f[[2]]$x[i] <= smth.inc[[5]][[5]][15],  
    sig.f[[2]]$inc[i]<-1, 
    ifelse(sig.f[[2]]$x[i] >= smth.inc[[5]][[5]][16] & sig.f[[2]]$x[i] <= smth.inc[[5]][[5]][39],
    sig.f[[2]]$inc[i]<-2, 
    ifelse(sig.f[[2]]$x[i] >= smth.inc[[5]][[5]][40] & sig.f[[2]]$x[i] <= smth.inc[[5]][[5]][132],
    sig.f[[2]]$inc[i]<-3, sig.f[[2]]$inc[i]<-NA)))}
  
  if (sig.f[[2]]$Region[i]==6)
    {ifelse(sig.f[[2]]$x[i] >= smth.inc[[5]][[6]][1] & sig.f[[2]]$x[i] <= smth.inc[[5]][[6]][29],  
    sig.f[[2]]$inc[i]<-1, 
    ifelse(sig.f[[2]]$x[i] >= smth.inc[[5]][[6]][30] & sig.f[[2]]$x[i] <= smth.inc[[5]][[6]][49],       sig.f[[2]]$inc[i]<-2, sig.f[[2]]$inc[i]<-NA))}
  
  ######fq2
  if (sig.f[[3]]$Region[i]==1){}
  
  if (sig.f[[3]]$Region[i]==2){}
  
  if (sig.f[[3]]$Region[i]==3)
    {ifelse(sig.f[[3]]$x[i] >= smth.inc[[6]][[3]][1] & sig.f[[3]]$x[i] <= smth.inc[[6]][[3]][7],  
    sig.f[[3]]$inc[i]<-1, 
    ifelse(sig.f[[3]]$x[i] >= smth.inc[[6]][[3]][8] & sig.f[[3]]$x[i] <= smth.inc[[6]][[3]][19], 
    sig.f[[3]]$inc[i]<-2, sig.f[[3]]$inc[i]<-NA))}
  
  if (sig.f[[3]]$Region[i]==4)
    {ifelse(sig.f[[3]]$x[i] >= smth.inc[[6]][[4]][1] & sig.f[[3]]$x[i] <= smth.inc[[6]][[4]][31],  
    sig.f[[3]]$inc[i]<-1, 
    ifelse(sig.f[[3]]$x[i] >= smth.inc[[6]][[4]][32] & sig.f[[3]]$x[i] <= smth.inc[[6]][[4]][58],
    sig.f[[3]]$inc[i]<-2, sig.f[[3]]$inc[i]<-NA))}
  
  if (sig.f[[3]]$Region[i]==5)
    {ifelse(sig.f[[3]]$x[i] >= smth.inc[[6]][[5]][1] & sig.f[[3]]$x[i] <= smth.inc[[6]][[5]][9],  
    sig.f[[3]]$inc[i]<-1, 
    ifelse(sig.f[[3]]$x[i] >= smth.inc[[6]][[6]][10] & sig.f[[3]]$x[i] <= smth.inc[[6]][[6]][27],
    sig.f[[3]]$inc[i]<-2,
    ifelse(sig.f[[3]]$x[i] >= smth.inc[[6]][[6]][28] & sig.f[[3]]$x[i] <= smth.inc[[6]][[6]][120],
    sig.f[[3]]$inc[i]<-3, sig.f[[3]]$inc[i]<-NA)))}
  
  if (sig.f[[3]]$Region[i]==6)
    {ifelse(sig.f[[3]]$x[i] >= smth.inc[[6]][[6]][1] & sig.f[[3]]$x[i] <= smth.inc[[6]][[6]][28],  
    sig.f[[3]]$inc[i]<-1, 
    ifelse(sig.f[[3]]$x[i] >= smth.inc[[6]][[6]][29] & sig.f[[3]]$x[i] <= smth.inc[[6]][[6]][47],       sig.f[[3]]$inc[i]<-2, sig.f[[3]]$inc[i]<-NA))}
} #end of the loop through the functional diversity
```

```{r}
#The below code is to identify the significant increases and decreases for taxonomic diversity

#for each q within sig.t, we create a decrease column and an increase column and fill with NA's, significant periods with have their NA's replaced with sequential numbers
#for clarity, indexing through sig.t or sig.t can be through of as: sig.t[[q value]]
sig.t.m[[1]]$dec<-NA
sig.t.m[[2]]$dec<-NA
sig.t.m[[3]]$dec<-NA

sig.t.m[[1]]$inc<-NA
sig.t.m[[2]]$inc<-NA
sig.t.m[[3]]$inc<-NA

#looping through every row of sig.t[[1]] which is the same number as the other q values (sig.t[[2]] and sig.t[[3]])). This is so the if statement can be applied to every row, one at a time.
for (i in 1:nrow(sig.t.m[[1]])){
  
  ########q0
  
  #rather than go through each block, this will be described in detail and can be applied to any of the below.
  if (sig.t.m[[1]]$Region[i]==1) #This block is to identify the significant trends within region 1 so the first step is to check if the current row of sig.t is in region 1, if it is then the below code is executed and if it is not then nothing is done
    #Region 1 of q=0 has 2 significant decreases, so we set up two ifelse() statements
    {ifelse(sig.t.m[[1]]$x[i] >= smth.dec.m[[1]][[1]][1] & sig.t.m[[1]]$x[i] <= smth.dec.m[[1]][[1]][19], #if the x value falls between row 1 and 13 of smth.dec q=0 and region 1, then the dec column is given a value of 1. The indexing through the lists can be confusing so this is the key: smth.dec[[q value]][[region]][row #]. The same is true for smth.inc
    sig.t.m[[1]]$dec[i]<-1, #storing a value of 1 for any rows where x falls between the above values
    sig.t.m[[1]]$dec[i]<-NA)} #If the x value does not fall within the significant ranges, it is given a value of NA, indicating it is not significant.
  
  #this pattern is repeated for each region and q value
  
  #Great lakes region removed
  #if (sig.t.m[[1]]$Region[i]==2)
   # {ifelse(sig.t.m[[1]]$x[i] >= smth.dec.m[[1]][[2]][1] & sig.t.m[[1]]$x[i] <= smth.dec.m[[1]][[2]][4],  
    #sig.t.m[[1]]$dec[i]<-1, sig.t.m[[1]]$dec[i]<-NA)}
  
  if (sig.t.m[[1]]$Region[i]==2)
    {ifelse(sig.t.m[[1]]$x[i] >= smth.dec.m[[1]][[2]][1] & sig.t.m[[1]]$x[i] <= smth.dec.m[[1]][[2]][9],  
    sig.t.m[[1]]$dec[i]<-1, 
    #since there is a second significant decrease, another ifelse() statement is used in the place of the else portion of the initial ifelse() statement
    ifelse(sig.t.m[[1]]$x[i] >= smth.dec.m[[1]][[2]][10] & sig.t.m[[1]]$x[i] <= smth.dec.m[[1]][[2]][23], 
    sig.t.m[[1]]$dec[i]<-2, sig.t.m[[1]]$dec[i]<-NA))}
  
  if (sig.t.m[[1]]$Region[i]==3)
    {ifelse(sig.t.m[[1]]$x[i] >= smth.dec.m[[1]][[3]][1] & sig.t.m[[1]]$x[i] <= smth.dec.m[[1]][[3]][11],
     sig.t.m[[1]]$dec[i]<-1, sig.t.m[[1]]$dec[i]<-NA)}
  
  if (sig.t.m[[1]]$Region[i]==4)
    {ifelse(sig.t.m[[1]]$x[i] >= smth.dec.m[[1]][[4]][1] & sig.t.m[[1]]$x[i] <= smth.dec.m[[1]][[4]][21],  
    sig.t.m[[1]]$dec[i]<-1, 
    ifelse(sig.t.m[[1]]$x[i] >= smth.dec.m[[1]][[4]][22] & sig.t.m[[1]]$x[i] <= smth.dec.m[[1]][[4]][31], 
    sig.t.m[[1]]$dec[i]<-2, 
    ifelse(sig.t.m[[1]]$x[i] >= smth.dec.m[[1]][[4]][32] & sig.t.m[[1]]$x[i] <= smth.dec.m[[1]][[4]][52],
    sig.t.m[[1]]$dec[i]<-3, sig.t.m[[1]]$dec[i]<-NA)))}
  
  if (sig.t.m[[1]]$Region[i]==5)
    {ifelse(sig.t.m[[1]]$x[i] >= smth.dec.m[[1]][[5]][1] & sig.t.m[[1]]$x[i] <= smth.dec.m[[1]][[5]][16],
     sig.t.m[[1]]$dec[i]<-1,
     ifelse(sig.t.m[[1]]$x[i] >= smth.dec.m[[1]][[5]][17] & sig.t.m[[1]]$x[i] <= smth.dec.m[[1]][[5]][28],
     sig.t.m[[1]]$dec[i]<-2, sig.t.m[[1]]$dec[i]<-NA))}
  
  if (sig.t.m[[1]]$Region[i]==6)
    {ifelse(sig.t.m[[1]]$x[i] >= smth.dec.m[[1]][[6]][1] & sig.t.m[[1]]$x[i] <= smth.dec.m[[1]][[6]][16],  
    sig.t.m[[1]]$dec[i]<-1, 
    ifelse(sig.t.m[[1]]$x[i] >= smth.dec.m[[1]][[6]][17] & sig.t.m[[1]]$x[i] <= smth.dec.m[[1]][[6]][27], 
    sig.t.m[[1]]$dec[i]<-2, sig.t.m[[1]]$dec[i]<-NA))}
 
   ###########q1
  if (sig.t.m[[2]]$Region[i]==1)
    {ifelse(sig.t.m[[2]]$x[i] >= smth.dec.m[[2]][[1]][1] & sig.t.m[[2]]$x[i] <= smth.dec.m[[2]][[1]][13],  
    sig.t.m[[2]]$dec[i]<-1, sig.t.m[[2]]$dec[i]<-NA)}
  
  #if (sig.t.m[[2]]$Region[i]==2)
   # {ifelse(sig.t.m[[2]]$x[i] >= smth.dec.m[[2]][[2]][1] & sig.t.m[[2]]$x[i] <= smth.dec.m[[2]][[2]][110],  
    #sig.t.m[[2]]$dec[i]<-1, sig.t.m[[2]]$dec[i]<-NA)}
  
  if (sig.t.m[[2]]$Region[i]==2)
    {ifelse(sig.t.m[[2]]$x[i] >= smth.dec.m[[2]][[2]][1] & sig.t.m[[2]]$x[i] <= smth.dec.m[[2]][[2]][18],  
    sig.t.m[[2]]$dec[i]<-1, sig.t.m[[2]]$dec[i]<-NA)}
  
  if (sig.t.m[[2]]$Region[i]==3)
    {ifelse(sig.t.m[[2]]$x[i] >= smth.dec.m[[2]][[3]][1] & sig.t.m[[2]]$x[i] <= smth.dec.m[[2]][[3]][15],  
    sig.t.m[[2]]$dec[i]<-1, 
    ifelse(sig.t.m[[2]]$x[i] >= smth.dec.m[[2]][[3]][16] & sig.t.m[[2]]$x[i] <= smth.dec.m[[2]][[3]][28], 
    sig.t.m[[2]]$dec[i]<-2, sig.t.m[[2]]$dec[i]<-NA))}
  
  if (sig.t.m[[2]]$Region[i]==4)
    {ifelse(sig.t.m[[2]]$x[i] >= smth.dec.m[[2]][[4]][1] & sig.t.m[[2]]$x[i] <= smth.dec.m[[2]][[4]][32],  
    sig.t.m[[2]]$dec[i]<-1, sig.t.m[[2]]$dec[i]<-NA)}
  
  if (sig.t.m[[2]]$Region[i]==5)
    {ifelse(sig.t.m[[2]]$x[i] >= smth.dec.m[[2]][[5]][1] & sig.t.m[[2]]$x[i] <= smth.dec.m[[2]][[5]][12],  
    sig.t.m[[2]]$dec[i]<-1, 
    ifelse(sig.t.m[[2]]$x[i] >= smth.dec.m[[2]][[5]][13] & sig.t.m[[2]]$x[i] <= smth.dec.m[[2]][[5]][22], 
    sig.t.m[[2]]$dec[i]<-2,
    ifelse(sig.t.m[[2]]$x[i] >= smth.dec.m[[2]][[5]][23] & sig.t.m[[2]]$x[i] <= smth.dec.m[[2]][[5]][36],
    sig.t.m[[2]]$dec[i]<-3, sig.t.m[[2]]$dec[i]<-NA)))}
  
  if (sig.t.m[[2]]$Region[i]==6)
    {ifelse(sig.t.m[[2]]$x[i] >= smth.dec.m[[2]][[6]][1] & sig.t.m[[2]]$x[i] <= smth.dec.m[[2]][[6]][119],  
    sig.t.m[[2]]$dec[i]<-1, sig.t.m[[2]]$dec[i]<-NA)}
  
  ######q2
  if (sig.t.m[[3]]$Region[i]==1)
    {ifelse(sig.t.m[[3]]$x[i] >= smth.dec.m[[3]][[1]][1] & sig.t.m[[3]]$x[i] <= smth.dec.m[[3]][[1]][15],  
    sig.t.m[[3]]$dec[i]<-1, sig.t.m[[3]]$dec[i]<-NA)}
 
   #if (sig.t.m[[3]]$Region[i]==2)
    #{ifelse(sig.t.m[[3]]$x[i] >= smth.dec.m[[3]][[2]][1] & sig.t.m[[3]]$x[i] <= smth.dec.m[[3]][[2]][107],  
    #sig.t.m[[3]]$dec[i]<-1, sig.t.m[[3]]$dec[i]<-NA)}
  
  if (sig.t.m[[3]]$Region[i]==2)
  {ifelse(sig.t.m[[3]]$x[i] >= smth.dec.m[[3]][[2]][1] & sig.t.m[[2]]$x[i] <= smth.dec.m[[3]][[2]][25],
    sig.t.m[[3]]$dec[i]<-1, sig.t.m[[3]]$dec[i]<-NA)}
  
  if (sig.t.m[[3]]$Region[i]==3)
    {ifelse(sig.t.m[[3]]$x[i] >= smth.dec.m[[3]][[3]][1] & sig.t.m[[3]]$x[i] <= smth.dec.m[[3]][[3]][16],  
    sig.t.m[[3]]$dec[i]<-1, 
    ifelse(sig.t.m[[3]]$x[i] >= smth.dec.m[[3]][[3]][17] & sig.t.m[[3]]$x[i] <= smth.dec.m[[3]][[3]][29], 
    sig.t.m[[3]]$dec[i]<-2, sig.t.m[[3]]$dec[i]<-NA))}
  
  if (sig.t.m[[3]]$Region[i]==4)
    {ifelse(sig.t.m[[3]]$x[i] >= smth.dec.m[[3]][[4]][1] & sig.t.m[[3]]$x[i] <= smth.dec.m[[3]][[4]][30],  
    sig.t.m[[3]]$dec[i]<-1, sig.t.m[[3]]$dec[i]<-NA)}
  
  if (sig.t.m[[3]]$Region[i]==5)
    {ifelse(sig.t.m[[3]]$x[i] >= smth.dec.m[[3]][[5]][1] & sig.t.m[[3]]$x[i] <= smth.dec.m[[3]][[5]][6],  
    sig.t.m[[3]]$dec[i]<-1, 
    ifelse(sig.t.m[[3]]$x[i] >= smth.dec.m[[3]][[5]][7] & sig.t.m[[3]]$x[i] <= smth.dec.m[[3]][[5]][18], 
    sig.t.m[[3]]$dec[i]<-2,
    ifelse(sig.t.m[[3]]$x[i] >= smth.dec.m[[3]][[5]][19] & sig.t.m[[3]]$x[i] <= smth.dec.m[[3]][[5]][32],
    sig.t.m[[3]]$dec[i]<-3, sig.t.m[[3]]$dec[i]<-NA)))}
  
  if (sig.t.m[[3]]$Region[i]==6)
    {ifelse(sig.t.m[[3]]$x[i] >= smth.dec.m[[3]][[6]][1] & sig.t.m[[3]]$x[i] <= smth.dec.m[[3]][[6]][113],  
    sig.t.m[[3]]$dec[i]<-1, sig.t.m[[3]]$dec[i]<-NA)}

#The below code is for the taxonomic significant increases. The pattern is the same except for using smth.inc and adding values to the inc column of sig.t rather than the dec.
  
  ########q0
  if (sig.t.m[[1]]$Region[i]==1)
    {ifelse(sig.t.m[[1]]$x[i] >= smth.inc.m[[1]][[1]][1] & sig.t.m[[1]]$x[i] <= smth.inc.m[[1]][[1]][15],  
    sig.t.m[[1]]$inc[i]<-1, sig.t.m[[1]]$inc[i]<-NA)}
  
 # if (sig.t.m[[1]]$Region[i]==2)
  #  {ifelse(sig.t.m[[1]]$x[i] >= smth.inc.m[[1]][[2]][1] & sig.t.m[[1]]$x[i] <= smth.inc.m[[1]][[2]][18],  
   # sig.t.m[[1]]$inc[i]<-1, 
    #ifelse(sig.t.m[[1]]$x[i] >= smth.inc.m[[1]][[2]][19] & sig.t.m[[1]]$x[i] <= smth.inc.m[[1]][[2]][43],
    #sig.t.m[[1]]$inc[i]<-2, sig.t.m[[1]]$inc[i]<-NA))}
  
  if (sig.t.m[[1]]$Region[i]==2)
    {ifelse(sig.t.m[[1]]$x[i] >= smth.inc.m[[1]][[2]][1] & sig.t.m[[1]]$x[i] <= smth.inc.m[[1]][[2]][16],  
    sig.t.m[[1]]$inc[i]<-1, 
    ifelse(sig.t.m[[1]]$x[i] >= smth.inc.m[[1]][[2]][17] & sig.t.m[[1]]$x[i] <= smth.inc.m[[1]][[2]][25],
    sig.t.m[[1]]$inc[i]<-2, 
    ifelse(sig.t.m[[1]]$x[i] >= smth.inc.m[[1]][[2]][26] & sig.t.m[[1]]$x[i] <= smth.inc.m[[1]][[2]][145],
    sig.t.m[[1]]$inc[i]<-3, sig.t.m[[1]]$inc[i]<-NA)))}
  
  if (sig.t.m[[1]]$Region[i]==3)
    {ifelse(sig.t.m[[1]]$x[i] >= smth.inc.m[[1]][[3]][1] & sig.t.m[[1]]$x[i] <= smth.inc.m[[1]][[3]][13],
    sig.t.m[[1]]$inc[i]<-1, 
    ifelse(sig.t.m[[1]]$x[i] >= smth.inc.m[[1]][[3]][14] & sig.t.m[[1]]$x[i] <= smth.inc.m[[1]][[3]][17],
    sig.t.m[[1]]$inc[i]<-2, sig.t.m[[1]]$inc[i]<-NA))}
  
  if (sig.t.m[[1]]$Region[i]==4)
    {ifelse(sig.t.m[[1]]$x[i] >= smth.inc.m[[1]][[4]][1] & sig.t.m[[1]]$x[i] <= smth.inc.m[[1]][[4]][32],  
    sig.t.m[[1]]$inc[i]<-1, 
    ifelse(sig.t.m[[1]]$x[i] >= smth.inc.m[[1]][[4]][33] & sig.t.m[[1]]$x[i] <= smth.inc.m[[1]][[4]][40],
    sig.t.m[[1]]$inc[i]<-2, sig.t.m[[1]]$inc[i]<-NA))}
  
  if (sig.t.m[[1]]$Region[i]==5)
    {ifelse(sig.t.m[[1]]$x[i] >= smth.inc.m[[1]][[5]][1] & sig.t.m[[1]]$x[i] <= smth.inc.m[[1]][[5]][13],  
    sig.t.m[[1]]$inc[i]<-1, 
    ifelse(sig.t.m[[1]]$x[i] >= smth.inc.m[[1]][[5]][14] & sig.t.m[[1]]$x[i] <= smth.inc.m[[1]][[5]][47],
    sig.t.m[[1]]$inc[i]<-2,
    ifelse(sig.t.m[[1]]$x[i] >= smth.inc.m[[1]][[5]][48] & sig.t.m[[1]]$x[i] <= smth.inc.m[[1]][[5]][138],
    sig.t.m[[1]]$inc[i]<-3, sig.t.m[[1]]$inc[i]<-NA)))}
  
  if (sig.t.m[[1]]$Region[i]==6)
    {ifelse(sig.t.m[[1]]$x[i] >= smth.inc.m[[1]][[6]][1] & sig.t.m[[1]]$x[i] <= smth.inc.m[[1]][[6]][15],  
    sig.t.m[[1]]$inc[i]<-1, 
    ifelse(sig.t.m[[1]]$x[i] >= smth.inc.m[[1]][[6]][16] & sig.t.m[[1]]$x[i] <= smth.inc.m[[1]][[6]][112], 
    sig.t.m[[1]]$inc[i]<-2, sig.t.m[[1]]$inc[i]<-NA))}
  
  ###########q1
  if (sig.t.m[[2]]$Region[i]==1){}
  
 # if (sig.t.m[[2]]$Region[i]==2)
  #  {ifelse(sig.t.m[[2]]$x[i] >= smth.inc.m[[2]][[2]][1] & sig.t.m[[2]]$x[i] <= smth.inc.m[[2]][[2]][27],  
   # sig.t.m[[2]]$inc[i]<-1, sig.t.m[[2]]$inc[i]<-NA)}
  
  if (sig.t.m[[2]]$Region[i]==2)
  {ifelse(sig.t.m[[2]]$x[i] >= smth.inc.m[[2]][[2]][1] & sig.t.m[[2]]$x[i] <= smth.inc.m[[2]][[2]][4],
  sig.t.m[[2]]$inc[i]<-1, sig.t.m[[2]]$inc[i]<-NA)}
  
  if (sig.t.m[[2]]$Region[i]==3)
    {ifelse(sig.t.m[[2]]$x[i] >= smth.inc.m[[2]][[3]][1] & sig.t.m[[2]]$x[i] <= smth.inc.m[[2]][[3]][12],  
    sig.t.m[[2]]$inc[i]<-1, 
    ifelse(sig.t.m[[2]]$x[i] >= smth.inc.m[[2]][[3]][13] & sig.t.m[[2]]$x[i] <= smth.inc.m[[2]][[3]][23], 
    sig.t.m[[2]]$inc[i]<-2, sig.t.m[[2]]$inc[i]<-NA))}
  
  if (sig.t.m[[2]]$Region[i]==4)
    {ifelse(sig.t.m[[2]]$x[i] >= smth.inc.m[[2]][[4]][1] & sig.t.m[[2]]$x[i] <= smth.inc.m[[2]][[4]][8],  
    sig.t.m[[2]]$inc[i]<-1, 
    ifelse(sig.t.m[[2]]$x[i] >= smth.inc.m[[2]][[4]][9] & sig.t.m[[2]]$x[i] <= smth.inc.m[[2]][[4]][38],
    sig.t.m[[2]]$inc[i]<-2, sig.t.m[[2]]$inc[i]<-NA))}
  
  if (sig.t.m[[2]]$Region[i]==5)
    {ifelse(sig.t.m[[2]]$x[i] >= smth.inc.m[[2]][[5]][1] & sig.t.m[[2]]$x[i] <= smth.inc.m[[2]][[5]][13],  
    sig.t.m[[2]]$inc[i]<-1, 
    ifelse(sig.t.m[[2]]$x[i] >= smth.inc.m[[2]][[5]][14] & sig.t.m[[2]]$x[i] <= smth.inc.m[[2]][[5]][29], 
    sig.t.m[[2]]$inc[i]<-2,
    ifelse(sig.t.m[[2]]$x[i] >= smth.inc.m[[2]][[5]][30] & sig.t.m[[2]]$x[i] <= smth.inc.m[[2]][[5]][33],
    sig.t.m[[2]]$inc[i]<-3, sig.t.m[[2]]$inc[i]<-NA)))}
  
  if (sig.t.m[[2]]$Region[i]==6)
    {ifelse(sig.t.m[[2]]$x[i] >= smth.inc.m[[2]][[6]][1] & sig.t.m[[2]]$x[i] <= smth.inc.m[[2]][[6]][30],  
    sig.t.m[[2]]$inc[i]<-1, 
    ifelse(sig.t.m[[2]]$x[i] >= smth.inc.m[[2]][[6]][31] & sig.t.m[[2]]$x[i] <= smth.inc.m[[2]][[6]][49],
    sig.t.m[[2]]$inc[i]<-2, sig.t.m[[2]]$inc[i]<-NA))}
  
  ######q2
  if (sig.t.m[[3]]$Region[i]==1){}

  #if (sig.t.m[[3]]$Region[i]==2)
   # {ifelse(sig.t.m[[3]]$x[i] >= smth.inc.m[[3]][[2]][1] & sig.t.m[[3]]$x[i] <= smth.inc.m[[3]][[2]][20],  
    #sig.t.m[[3]]$inc[i]<-1, 
    #ifelse(sig.t.m[[3]]$x[i] >= smth.inc.m[[3]][[2]][21] & sig.t.m[[3]]$x[i] <= smth.inc.m[[3]][[2]][24],
    #sig.t.m[[3]]$inc[i]<-2, sig.t.m[[3]]$inc[i]<-NA))}
  
  if (sig.t.m[[3]]$Region[i]==2)
    {ifelse(sig.t.m[[3]]$x[i] >= smth.inc.m[[3]][[2]][1] & sig.t.m[[3]]$x[i] <= smth.inc.m[[3]][[2]][7],
    sig.t.m[[3]]$inc[i]<-1, sig.t.m[[3]]$inc[i]<-NA)}
  
  if (sig.t.m[[3]]$Region[i]==3)
    {ifelse(sig.t.m[[3]]$x[i] >= smth.inc.m[[3]][[3]][1] & sig.t.m[[3]]$x[i] <= smth.inc.m[[3]][[3]][13],  
    sig.t.m[[3]]$inc[i]<-1, 
    ifelse(sig.t.m[[3]]$x[i] >= smth.inc.m[[3]][[3]][14] & sig.t.m[[3]]$x[i] <= smth.inc.m[[3]][[3]][24], 
    sig.t.m[[3]]$inc[i]<-2, sig.t.m[[3]]$inc[i]<-NA))}
  
  if (sig.t.m[[3]]$Region[i]==4)
    {ifelse(sig.t.m[[3]]$x[i] >= smth.inc.m[[3]][[4]][1] & sig.t.m[[3]]$x[i] <= smth.inc.m[[3]][[4]][31],  
    sig.t.m[[3]]$inc[i]<-1, 
    ifelse(sig.t.m[[3]]$x[i] >= smth.inc.m[[3]][[4]][32] & sig.t.m[[3]]$x[i] <= smth.inc.m[[3]][[4]][41],
    sig.t.m[[3]]$inc[i]<-2, sig.t.m[[3]]$inc[i]<-NA))}
  
  if (sig.t.m[[3]]$Region[i]==5)
    {ifelse(sig.t.m[[3]]$x[i] >= smth.inc.m[[3]][[5]][1] & sig.t.m[[3]]$x[i] <= smth.inc.m[[3]][[5]][9],  
    sig.t.m[[3]]$inc[i]<-1, 
    ifelse(sig.t.m[[3]]$x[i] >= smth.inc.m[[3]][[5]][10] & sig.t.m[[3]]$x[i] <= smth.inc.m[[3]][[5]][24], 
    sig.t.m[[3]]$inc[i]<-2,
    ifelse(sig.t.m[[3]]$x[i] >= smth.inc.m[[3]][[5]][25] & sig.t.m[[3]]$x[i] <= smth.inc.m[[3]][[5]][31],
    sig.t.m[[3]]$inc[i]<-3, sig.t.m[[3]]$inc[i]<-NA)))}
  
  if (sig.t.m[[3]]$Region[i]==6)
    {ifelse(sig.t.m[[3]]$x[i] >= smth.inc.m[[3]][[6]][1] & sig.t.m[[3]]$x[i] <= smth.inc.m[[3]][[6]][28],  
    sig.t.m[[3]]$inc[i]<-1, 
    ifelse(sig.t.m[[3]]$x[i] >= smth.inc.m[[3]][[6]][29] & sig.t.m[[3]]$x[i] <= smth.inc.m[[3]][[6]][41],
    sig.t.m[[3]]$inc[i]<-2, sig.t.m[[3]]$inc[i]<-NA))}
} #here the loop ends as we have iterated through all of the q values and regions for increases and decreases

#the below code is the same as the above, but it is not repeated for all of the functional diversity trends. As such we use sig.f rather than sig.t. The pattern is the same as above. 
sig.f.m[[1]]$dec<-NA
sig.f.m[[2]]$dec<-NA
sig.f.m[[3]]$dec<-NA

sig.f.m[[1]]$inc<-NA
sig.f.m[[2]]$inc<-NA
sig.f.m[[3]]$inc<-NA

#significant functional decreases
#looping through each row of the functional trends
for (i in 1:nrow(sig.f.m[[1]])){
  ########fq0
  if (sig.f.m[[1]]$Region[i]==1)
    {ifelse(sig.f.m[[1]]$x[i] >= smth.dec.m[[4]][[1]][1] & sig.f.m[[1]]$x[i] <= smth.dec.m[[4]][[1]][10],
     sig.f.m[[1]]$dec[i]<-1, sig.f.m[[1]]$dec[i]<-NA)}
  
  if (sig.f.m[[1]]$Region[i]==2)
    {ifelse(sig.f.m[[1]]$x[i] >= smth.dec.m[[4]][[2]][1] & sig.f.m[[1]]$x[i] <= smth.dec.m[[4]][[2]][11],  
    sig.f.m[[1]]$dec[i]<-1, 
    ifelse(sig.f.m[[1]]$x[i] >= smth.dec.m[[4]][[2]][12] & sig.f.m[[1]]$x[i] <= smth.dec.m[[4]][[2]][20],
    sig.f.m[[1]]$dec[i]<-2, sig.f.m[[1]]$dec[i]<-NA))}
  
  if (sig.f.m[[1]]$Region[i]==3)
    {ifelse(sig.f.m[[1]]$x[i] >= smth.dec.m[[4]][[3]][1] & sig.f.m[[1]]$x[i] <= smth.dec.m[[4]][[3]][12],
    sig.f.m[[1]]$dec[i]<-1,
    ifelse(sig.f.m[[1]]$x[i] >= smth.dec.m[[4]][[3]][13] & sig.f.m[[1]]$x[i] <= smth.dec.m[[4]][[3]][17],
    sig.f.m[[1]]$dec[i]<-2, sig.f.m[[1]]$dec[i]<-NA))}
  
  if (sig.f.m[[1]]$Region[i]==4)
    {ifelse(sig.f.m[[1]]$x[i] >= smth.dec.m[[4]][[4]][1] & sig.f.m[[1]]$x[i] <= smth.dec.m[[4]][[4]][18],  
    sig.f.m[[1]]$dec[i]<-1, sig.f.m[[1]]$dec[i]<-NA)}
  
  if (sig.f.m[[1]]$Region[i]==5)
    {ifelse(sig.f.m[[1]]$x[i] >= smth.dec.m[[4]][[5]][1] & sig.f.m[[1]]$x[i] <= smth.dec.m[[4]][[5]][14],
    sig.f.m[[1]]$dec[i]<-1,
    ifelse(sig.f.m[[1]]$x[i] >= smth.dec.m[[4]][[5]][15] & sig.f.m[[1]]$x[i] <= smth.dec.m[[4]][[5]][24],
    sig.f.m[[1]]$dec[i]<-2, sig.f.m[[1]]$dec[i]<-NA))}
  
  if (sig.f.m[[1]]$Region[i]==6)
    {ifelse(sig.f.m[[1]]$x[i] >= smth.dec.m[[4]][[6]][1] & sig.f.m[[1]]$x[i] <= smth.dec.m[[4]][[6]][23],  
    sig.f.m[[1]]$dec[i]<-1, 
    ifelse(sig.f.m[[1]]$x[i] >= smth.dec.m[[4]][[6]][24] & sig.f.m[[1]]$x[i] <= smth.dec.m[[4]][[6]][37], 
    sig.f.m[[1]]$dec[i]<-2, sig.f.m[[1]]$dec[i]<-NA))}
  
  ###########fq1
  if (sig.f.m[[2]]$Region[i]==1)
    {ifelse(sig.f.m[[2]]$x[i] >= smth.dec.m[[5]][[1]][1] & sig.f.m[[2]]$x[i] <= smth.dec.m[[5]][[1]][21],  
    sig.f.m[[2]]$dec[i]<-1, sig.f.m[[2]]$dec[i]<-NA)}
  
  if (sig.f.m[[2]]$Region[i]==2)
    {ifelse(sig.f.m[[2]]$x[i] >= smth.dec.m[[5]][[2]][1] & sig.f.m[[2]]$x[i] <= smth.dec.m[[5]][[2]][15],  
    sig.f.m[[2]]$dec[i]<-1, sig.f.m[[2]]$dec[i]<-NA)}

  if (sig.f.m[[2]]$Region[i]==3)
    {ifelse(sig.f.m[[2]]$x[i] >= smth.dec.m[[5]][[3]][1] & sig.f.m[[2]]$x[i] <= smth.dec.m[[5]][[3]][14],  
    sig.f.m[[2]]$dec[i]<-1, 
    ifelse(sig.f.m[[2]]$x[i] >= smth.dec.m[[5]][[3]][15] & sig.f.m[[2]]$x[i] <= smth.dec.m[[5]][[3]][27], 
    sig.f.m[[2]]$dec[i]<-2, sig.f.m[[2]]$dec[i]<-NA))}
  
  if (sig.f.m[[2]]$Region[i]==4)
    {ifelse(sig.f.m[[2]]$x[i] >= smth.dec.m[[5]][[4]][1] & sig.f.m[[2]]$x[i] <= smth.dec.m[[5]][[4]][34],  
    sig.f.m[[2]]$dec[i]<-1, sig.f.m[[2]]$dec[i]<-NA)}
  
  if (sig.f.m[[2]]$Region[i]==5)
    {ifelse(sig.f.m[[2]]$x[i] >= smth.dec.m[[5]][[5]][1] & sig.f.m[[2]]$x[i] <= smth.dec.m[[5]][[5]][16],  
    sig.f.m[[2]]$dec[i]<-1, 
    ifelse(sig.f.m[[2]]$x[i] >= smth.dec.m[[5]][[5]][17] & sig.f.m[[2]]$x[i] <= smth.dec.m[[5]][[5]][30],
    sig.f.m[[2]]$dec[i]<-2, sig.f.m[[2]]$dec[i]<-NA))}
  
  if (sig.f.m[[2]]$Region[i]==6)
    {ifelse(sig.f.m[[2]]$x[i] >= smth.dec.m[[5]][[6]][1] & sig.f.m[[2]]$x[i] <= smth.dec.m[[5]][[6]][122],  
    sig.f.m[[2]]$dec[i]<-1, sig.f.m[[2]]$dec[i]<-NA)}
  
  ######fq2
  if (sig.f.m[[3]]$Region[i]==1)
    {ifelse(sig.f.m[[3]]$x[i] >= smth.dec.m[[6]][[1]][1] & sig.f.m[[3]]$x[i] <= smth.dec.m[[6]][[1]][11],  
    sig.f.m[[3]]$dec[i]<-1, sig.f.m[[3]]$dec[i]<-NA)}
  
  if (sig.f.m[[3]]$Region[i]==2)
    {ifelse(sig.f.m[[3]]$x[i] >= smth.dec.m[[6]][[2]][1] & sig.f.m[[3]]$x[i] <= smth.dec.m[[6]][[2]][17],  
    sig.f.m[[3]]$dec[i]<-1, sig.f.m[[3]]$dec[i]<-NA)}
  
  if (sig.f.m[[3]]$Region[i]==3)
    {ifelse(sig.f.m[[3]]$x[i] >= smth.dec.m[[6]][[3]][1] & sig.f.m[[3]]$x[i] <= smth.dec.m[[6]][[3]][12],  
    sig.f.m[[3]]$dec[i]<-1, 
    ifelse(sig.f.m[[3]]$x[i] >= smth.dec.m[[6]][[3]][13] & sig.f.m[[3]]$x[i] <= smth.dec.m[[6]][[3]][25], 
    sig.f.m[[3]]$dec[i]<-2, sig.f.m[[3]]$dec[i]<-NA))}
  
  if (sig.f.m[[3]]$Region[i]==4)
    {ifelse(sig.f.m[[3]]$x[i] >= smth.dec.m[[6]][[4]][1] & sig.f.m[[3]]$x[i] <= smth.dec.m[[6]][[4]][36],  
    sig.f.m[[3]]$dec[i]<-1, sig.f.m[[3]]$dec[i]<-NA)}
  
  if (sig.f.m[[3]]$Region[i]==5)
    {ifelse(sig.f.m[[3]]$x[i] >= smth.dec.m[[6]][[5]][1] & sig.f.m[[3]]$x[i] <= smth.dec.m[[6]][[5]][15],  
    sig.f.m[[3]]$dec[i]<-1, sig.f.m[[3]]$dec[i]<-NA)}
  
  if (sig.f.m[[3]]$Region[i]==6)
    {ifelse(sig.f.m[[3]]$x[i] >= smth.dec.m[[6]][[6]][1] & sig.f.m[[3]]$x[i] <= smth.dec.m[[6]][[6]][120],  
    sig.f.m[[3]]$dec[i]<-1, sig.f.m[[3]]$dec[i]<-NA)}

#significant functional increases
  ########fq0
  if (sig.f.m[[1]]$Region[i]==1)
    {ifelse(sig.f.m[[1]]$x[i] >= smth.inc.m[[4]][[1]][1] & sig.f.m[[1]]$x[i] <= smth.inc.m[[4]][[1]][14],  
    sig.f.m[[1]]$inc[i]<-1, sig.f.m[[1]]$inc[i]<-NA)}

  if (sig.f.m[[1]]$Region[i]==2)
    {ifelse(sig.f.m[[1]]$x[i] >= smth.inc.m[[4]][[2]][1] & sig.f.m[[1]]$x[i] <= smth.inc.m[[4]][[2]][16],  
    sig.f.m[[1]]$inc[i]<-1, 
    ifelse(sig.f.m[[1]]$x[i] >= smth.inc.m[[4]][[2]][17] & sig.f.m[[1]]$x[i] <= smth.inc.m[[4]][[2]][134],
    sig.f.m[[1]]$inc[i]<-2, sig.f.m[[1]]$inc[i]<-NA))}
  
  if (sig.f.m[[1]]$Region[i]==3)
    {ifelse(sig.f.m[[1]]$x[i] >= smth.inc.m[[4]][[3]][1] & sig.f.m[[1]]$x[i] <= smth.inc.m[[4]][[3]][20],  
     sig.f.m[[1]]$inc[i]<-1, 
     ifelse(sig.f.m[[1]]$x[i] >= smth.inc.m[[4]][[3]][21] & sig.f.m[[1]]$x[i] <= smth.inc.m[[4]][[3]][27],
     sig.f.m[[1]]$inc[i]<-2,
     ifelse(sig.f.m[[1]]$x[i] >= smth.inc.m[[4]][[3]][28] & sig.f.m[[1]]$x[i] <= smth.inc.m[[4]][[3]][157],
     sig.f.m[[1]]$inc[i]<-3, sig.f.m[[1]]$inc[i]<-NA)))}
  
  if (sig.f.m[[1]]$Region[i]==4)
    {ifelse(sig.f.m[[1]]$x[i] >= smth.inc.m[[4]][[4]][1] & sig.f.m[[1]]$x[i] <= smth.inc.m[[4]][[4]][32],  
    sig.f.m[[1]]$inc[i]<-1, 
    ifelse(sig.f.m[[1]]$x[i] >= smth.inc.m[[4]][[4]][33] & sig.f.m[[1]]$x[i] <= smth.inc.m[[4]][[4]][44], 
    sig.f.m[[1]]$inc[i]<-2, sig.f.m[[1]]$inc[i]<-NA))}
  
  if (sig.f.m[[1]]$Region[i]==5)
    {ifelse(sig.f.m[[1]]$x[i] >= smth.inc.m[[4]][[5]][1] & sig.f.m[[1]]$x[i] <= smth.inc.m[[4]][[5]][8],  
    sig.f.m[[1]]$inc[i]<-1, 
    ifelse(sig.f.m[[1]]$x[i] >= smth.inc.m[[4]][[5]][9] & sig.f.m[[1]]$x[i] <= smth.inc.m[[4]][[5]][26],
    sig.f.m[[1]]$inc[i]<-2, 
    ifelse(sig.f.m[[1]]$x[i] >= smth.inc.m[[4]][[5]][27] & sig.f.m[[1]]$x[i] <= smth.inc.m[[4]][[5]][37],
    sig.f.m[[1]]$inc[i]<-3, 
    ifelse(sig.f.m[[1]]$x[i] >= smth.inc.m[[4]][[5]][38] & sig.f.m[[1]]$x[i] <= smth.inc.m[[4]][[5]][129],
    sig.f.m[[1]]$inc[i]<-4, sig.f.m[[1]]$inc[i]<-NA))))}
  
  if (sig.f.m[[1]]$Region[i]==6)
    {ifelse(sig.f.m[[1]]$x[i] >= smth.inc.m[[4]][[6]][1] & sig.f.m[[1]]$x[i] <= smth.inc.m[[4]][[6]][9],  
    sig.f.m[[1]]$inc[i]<-1, 
    ifelse(sig.f.m[[1]]$x[i] >= smth.inc.m[[4]][[6]][10] & sig.f.m[[1]]$x[i] <= smth.inc.m[[4]][[6]][118], 
    sig.f.m[[1]]$inc[i]<-2, sig.f.m[[1]]$inc[i]<-NA))}
  
  ###########fq1
  if (sig.t.m[[2]]$Region[i]==1){}
  
  if (sig.f.m[[2]]$Region[i]==2)
  {ifelse(sig.f.m[[2]]$x[i] >= smth.inc.m[[5]][[2]][1] & sig.f.m[[2]]$x[i] <= smth.inc.m[[5]][[2]][22],
   sig.f.m[[2]]$inc[i]<-1,
   ifelse(sig.f.m[[2]]$x[i] >= smth.inc.m[[5]][[2]][23] & sig.f.m[[2]]$x[i] <= smth.inc.m[[5]][[2]][136],
   sig.f.m[[2]]$inc[i]<-2, sig.f.m[[2]]$inc[i]<-NA))}
  
  if (sig.f.m[[2]]$Region[i]==3)
    {ifelse(sig.f.m[[2]]$x[i] >= smth.inc.m[[5]][[3]][1] & sig.f.m[[2]]$x[i] <= smth.inc.m[[5]][[3]][8],  
    sig.f.m[[2]]$inc[i]<-1,
    ifelse(sig.f.m[[2]]$x[i] >= smth.inc.m[[5]][[3]][9] & sig.f.m[[2]]$x[i] <= smth.inc.m[[5]][[3]][17],  
    sig.f.m[[2]]$inc[i]<-2,
    ifelse(sig.f.m[[2]]$x[i] >= smth.inc.m[[5]][[3]][18] & sig.f.m[[2]]$x[i] <= smth.inc.m[[5]][[3]][153], 
    sig.f.m[[2]]$inc[i]<-3, sig.f.m[[2]]$inc[i]<-NA)))}
  
  if (sig.f.m[[2]]$Region[i]==4)
    {ifelse(sig.f.m[[2]]$x[i] >= smth.inc.m[[5]][[4]][1] & sig.f.m[[2]]$x[i] <= smth.inc.m[[5]][[4]][32],  
    sig.f.m[[2]]$inc[i]<-1, 
    ifelse(sig.f.m[[2]]$x[i] >= smth.inc.m[[5]][[4]][33] & sig.f.m[[2]]$x[i] <= smth.inc.m[[5]][[4]][37],  
    sig.f.m[[2]]$inc[i]<-2, 
    ifelse(sig.f.m[[2]]$x[i] >= smth.inc.m[[5]][[4]][38] & sig.f.m[[2]]$x[i] <= smth.inc.m[[5]][[4]][49], 
    sig.f.m[[2]]$inc[i]<-3, 
    ifelse(sig.f.m[[2]]$x[i] >= smth.inc.m[[5]][[4]][50] & sig.f.m[[2]]$x[i] <= smth.inc.m[[5]][[4]][74], 
    sig.f.m[[2]]$inc[i]<-4, sig.f.m[[2]]$inc[i]<-NA))))}
  
  if (sig.f.m[[2]]$Region[i]==5)
    {ifelse(sig.f.m[[2]]$x[i] >= smth.inc.m[[5]][[5]][1] & sig.f.m[[2]]$x[i] <= smth.inc.m[[5]][[5]][18],  
    sig.f.m[[2]]$inc[i]<-1, 
    ifelse(sig.f.m[[2]]$x[i] >= smth.inc.m[[5]][[5]][19] & sig.f.m[[2]]$x[i] <= smth.inc.m[[5]][[5]][44],
    sig.f.m[[2]]$inc[i]<-2, 
    ifelse(sig.f.m[[2]]$x[i] >= smth.inc.m[[5]][[5]][45] & sig.f.m[[2]]$x[i] <= smth.inc.m[[5]][[5]][138],
    sig.f.m[[2]]$inc[i]<-3, sig.f.m[[2]]$inc[i]<-NA)))}
  
  if (sig.f.m[[2]]$Region[i]==6)
    {ifelse(sig.f.m[[2]]$x[i] >= smth.inc.m[[5]][[6]][1] & sig.f.m[[2]]$x[i] <= smth.inc.m[[5]][[6]][29],
    sig.f.m[[2]]$inc[i]<-1, 
    ifelse(sig.f.m[[2]]$x[i] >= smth.inc.m[[5]][[6]][30] & sig.f.m[[2]]$x[i] <= smth.inc.m[[5]][[6]][49],  
    sig.f.m[[2]]$inc[i]<-2, sig.f.m[[2]]$inc[i]<-NA))}

  ######fq2
  if (sig.f.m[[3]]$Region[i]==1)
    {ifelse(sig.f.m[[3]]$x[i] >= smth.inc.m[[6]][[1]][1] & sig.f.m[[3]]$x[i] <= smth.inc.m[[6]][[1]][140],  
    sig.f.m[[3]]$inc[i]<-1, sig.f.m[[3]]$inc[i]<-NA)}
  
  if (sig.f.m[[3]]$Region[i]==2)
    {ifelse(sig.f.m[[3]]$x[i] >= smth.inc.m[[6]][[2]][1] & sig.f.m[[3]]$x[i] <= smth.inc.m[[6]][[2]][17],
    sig.f.m[[3]]$inc[i]<-1, 
    ifelse(sig.f.m[[3]]$x[i] >= smth.inc.m[[6]][[2]][18] & sig.f.m[[3]]$x[i] <= smth.inc.m[[6]][[2]][131],
    sig.f.m[[3]]$inc[i]<-2, sig.f.m[[3]]$inc[i]<-NA))}
  
  if (sig.f.m[[3]]$Region[i]==3)
    {ifelse(sig.f.m[[3]]$x[i] >= smth.inc.m[[6]][[3]][1] & sig.f.m[[3]]$x[i] <= smth.inc.m[[6]][[3]][7],  
    sig.f.m[[3]]$inc[i]<-1, 
    ifelse(sig.f.m[[3]]$x[i] >= smth.inc.m[[6]][[3]][8] & sig.f.m[[3]]$x[i] <= smth.inc.m[[6]][[3]][21], 
    sig.f.m[[3]]$inc[i]<-2, sig.f.m[[3]]$inc[i]<-NA))}
  
  if (sig.f.m[[3]]$Region[i]==4)
    {ifelse(sig.f.m[[3]]$x[i] >= smth.inc.m[[6]][[4]][1] & sig.f.m[[3]]$x[i] <= smth.inc.m[[6]][[4]][33],  
    sig.f.m[[3]]$inc[i]<-1, 
    ifelse(sig.f.m[[3]]$x[i] >= smth.inc.m[[6]][[4]][34] & sig.f.m[[3]]$x[i] <= smth.inc.m[[6]][[4]][49],
    sig.f.m[[3]]$inc[i]<-2, 
    ifelse(sig.f.m[[3]]$x[i] >= smth.inc.m[[6]][[4]][50] & sig.f.m[[3]]$x[i] <= smth.inc.m[[6]][[4]][64],
    sig.f.m[[3]]$inc[i]<-3, sig.f.m[[3]]$inc[i]<-NA)))}
  
  if (sig.f.m[[3]]$Region[i]==5)
    {ifelse(sig.f.m[[3]]$x[i] >= smth.inc.m[[6]][[5]][1] & sig.f.m[[3]]$x[i] <= smth.inc.m[[6]][[5]][10],  
    sig.f.m[[3]]$inc[i]<-1, 
    ifelse(sig.f.m[[3]]$x[i] >= smth.inc.m[[6]][[5]][11] & sig.f.m[[3]]$x[i] <= smth.inc.m[[6]][[5]][28],
    sig.f.m[[3]]$inc[i]<-2,
    ifelse(sig.f.m[[3]]$x[i] >= smth.inc.m[[6]][[5]][29] & sig.f.m[[3]]$x[i] <= smth.inc.m[[6]][[5]][121],
    sig.f.m[[3]]$inc[i]<-3, sig.f.m[[3]]$inc[i]<-NA)))}
  
  if (sig.f.m[[3]]$Region[i]==6)
    {ifelse(sig.f.m[[3]]$x[i] >= smth.inc.m[[6]][[6]][1] & sig.f.m[[3]]$x[i] <= smth.inc.m[[6]][[6]][28],  
    sig.f.m[[3]]$inc[i]<-1, 
    ifelse(sig.f.m[[3]]$x[i] >= smth.inc.m[[6]][[6]][29] & sig.f.m[[3]]$x[i] <= smth.inc.m[[6]][[6]][47],
    sig.f.m[[3]]$inc[i]<-2, sig.f.m[[3]]$inc[i]<-NA))}
}
 #end of the loop through the functional diversity
```

# Data prep for ArcGIS Pro Maps
Below is the code used to create the dataframes that were imported into ArcGIS Pro and used in the map making for figures 1 and 6 in our paper. We create an MIS column to label which MIS each row of sig.t and sig.f fall within and then calculate the MIS averages.

### MIS labels
The code below is used to label each row of sig.t and sig.f with the MIS it falls within
```{r}
#looping through the three q values
for (q in 1:3){
  sig.t[[q]]$mis<-NA #for each q value create a column called MIS and fill with NA
  #loop through each row of sig.t
  for (i in 1:nrow(sig.t[[q]])){
    ifelse(11.7 >= sig.t[[q]]$x[i], sig.t[[q]]$mis[i]<-"1", NA) #if the x values of the current row i fall with the numeric range given, mis is given a value of 1, indicating MIS 1, if not then do nothing (NA)
    ifelse(29 >= sig.t[[q]]$x[i] & sig.t[[q]]$x[i] > 11.7, sig.t[[q]]$mis[i]<-"2", NA) #MIS 2 range
    ifelse(57 >= sig.t[[q]]$x[i] & sig.t[[q]]$x[i] > 29, sig.t[[q]]$mis[i]<-"3", NA) #MIS 3 range
    ifelse(71 >= sig.t[[q]]$x[i] & sig.t[[q]]$x[i] > 57, sig.t[[q]]$mis[i]<-"4", NA) #MIS 4 range
    ifelse(78 >= sig.t[[q]]$x[i] & sig.t[[q]]$x[i] > 71, sig.t[[q]]$mis[i]<-"5a", NA) #MIS 5a range
    ifelse(88 >= sig.t[[q]]$x[i] & sig.t[[q]]$x[i] > 78, sig.t[[q]]$mis[i]<-"5b", NA) #MIS 5b range
    ifelse(106.5 >= sig.t[[q]]$x[i] & sig.t[[q]]$x[i] > 88, sig.t[[q]]$mis[i]<-"5c", NA) #MIS 5c range
    ifelse(116 >= sig.t[[q]]$x[i] & sig.t[[q]]$x[i] > 106.5, sig.t[[q]]$mis[i]<-"5d", NA) #MIS 5d range
    ifelse(130 >= sig.t[[q]]$x[i] & sig.t[[q]]$x[i] > 116, sig.t[[q]]$mis[i]<-"5e", NA) #MIS 5e range
    ifelse(sig.t[[q]]$x[i] > 130, sig.t[[q]]$mis[i]<-"6", NA) #MIS 6 range
  }
  #the same is done for sig.f for all the functional values
  sig.f[[q]]$mis<-NA
  for (i in 1:nrow(sig.f[[q]])){
    ifelse(sig.f[[q]]$x[i] > 130, sig.f[[q]]$mis[i]<-"6", NA)
    ifelse(130 >= sig.f[[q]]$x[i] & sig.f[[q]]$x[i] > 116, sig.f[[q]]$mis[i]<-"5e", NA)
    ifelse(116 >= sig.f[[q]]$x[i] & sig.f[[q]]$x[i] > 106.5, sig.f[[q]]$mis[i]<-"5d", NA)
    ifelse(106.5 >= sig.f[[q]]$x[i] & sig.f[[q]]$x[i] > 88, sig.f[[q]]$mis[i]<-"5c", NA)
    ifelse(88 >= sig.f[[q]]$x[i] & sig.f[[q]]$x[i] > 78, sig.f[[q]]$mis[i]<-"5b", NA)
    ifelse(78 >= sig.f[[q]]$x[i] & sig.f[[q]]$x[i] > 71, sig.f[[q]]$mis[i]<-"5a", NA)
    ifelse(71 >= sig.f[[q]]$x[i] & sig.f[[q]]$x[i] > 57, sig.f[[q]]$mis[i]<-"4", NA)
    ifelse(57 >= sig.f[[q]]$x[i] & sig.f[[q]]$x[i] > 29, sig.f[[q]]$mis[i]<-"3", NA)
    ifelse(29 >= sig.f[[q]]$x[i] & sig.f[[q]]$x[i] > 11.7, sig.f[[q]]$mis[i]<-"2", NA)
    ifelse(11.7 >= sig.f[[q]]$x[i], sig.f[[q]]$mis[i]<-"1", NA)
  }
}
```

### MIS Averages
The below code is used to calculate the average diversity value for each MIS.
```{r}
#creating a vector called mis.val with the MIS labels
mis.val<-c("1","2","3","4","5a","5b","5c","5d","5e","6")

#looping through the three q values
for (q in 1:3){
  #read in the site coordinate data frame containing the GPS coordinates for each site in our study. The .csv file is within the composite folder of the working directory
  coord<-read.csv("./geog/site_coord.csv")

  #create 4 empty data frames, 2 for the taxonomic and functional MIS averages and 2 for the taxonomic and functional p values from the Kruskal-Wallis tests
  avgs.t<-data.frame()
  avgs.f<-data.frame()
  
  #loop through the 6 regions
  for (r in 1:6){
    
    #store only the trend data for the current region as reg.trend.t for taxonomic and reg.trend.f for functional
    reg.trend.t<-sig.t[[q]] %>% filter(.$Region==r)
    reg.trend.f<-sig.f[[q]] %>% filter(.$Region==r)
    
    #loop through the number of MIS stages present in the current region (r)
    for (i in 1:length(unique(reg.trend.t$mis))){
      #take the average of the taxonomic diversity values for all the rows that are in the same MIS as the current MIS (i) and save as a single value in row r and column i of avs.t. The result is avgs.t has a row for each region and column for each MIS
      avgs.t[r,i]<-mean(reg.trend.t %>% filter(.$mis==mis.val[i]) %>% .$y, na.rm=T)}
    
    #repeat the same loop but for the functional diversity instead of the taxonomic
    for (i in 1:length(unique(reg.trend.f$mis))){
      avgs.f[r,i]<-mean(reg.trend.f %>% filter(.$mis==mis.val[i]) %>% .$y, na.rm=T)}
  }
  #We rename the columns of avgs.t to the mis stages and make a new column called Region with the region numbers (1 through 7)
  avgs.t<-avgs.t %>%
    `colnames<-`(., c("MIS_1","MIS_2","MIS_3","MIS_4","MIS_5a","MIS_5b","MIS_5c","MIS_5d","MIS_5e","MIS_6")) %>%
    mutate(Region = 1:6)
  
  #merging the averages with the site coordinate file
  coord.avgs.t<-coord %>%
  left_join(avgs.t) 
  
  #saving the coordinate file with the averages in the composites folder of the working directory and naming it qx_t_means.csv, the x is either 0, 1, or 2 based on which iteration of q the loop is on.
  write.csv(coord.avgs.t, paste("./geog/q",q-1,"_t_means.csv", sep=''), row.names = F, na="")
  
  #repeating for functional diversity
  avgs.f<-avgs.f %>%
    `colnames<-`(., c("MIS_1","MIS_2","MIS_3","MIS_4","MIS_5a","MIS_5b","MIS_5c","MIS_5d","MIS_5e","MIS_6")) %>%
    mutate(Region = 1:6)
  
  coord.avgs.f<-coord %>%
    left_join(avgs.f)
  
  write.csv(coord.avgs.f, paste("./geog/q",q-1,"_f_means.csv", sep=''), row.names = F, na = "")
}
```

#Region Trend plots
Below is the code used to generate figures 3, 4, and 5. Plotting the GAM splines along with regional and global climate data.
```{r}
#Here we create a dataframe called dat_text that has two columns, label and Region, the Region column is numbered 1 through 6 in line with region numbers in tot.sm. The label column contains the abbreviations for each region to be added to the plot

dat_text <- data.frame(
  label= c("ARCT", "NW", "SE", "IMW", "MEX", "YUC"),
  Region= c(1, 2, 3, 4, 5, 6)
)
```

```{r}
Arct<-read.csv("./clim/Arctic_18O.csv") #bringing in arctic climate data from Cronin et al., 2019
Arct <- Arct %>%
  filter(.$Age..ka. <= 150 & .$Age..ka. >= 0) %>%
  mutate(KyrBP = .$Age..ka.)
Arct$d18Ob <- Arct$d18Ob %>% as.numeric()

Cari<-read.csv("./clim/odp999a-tab.csv") #bringing in Caribbean climate data from Schmidt et al., 2004
Cari <- Cari %>%
  filter(.$calyrBP <= 150000 & .$calyrBP >= 0) %>%
  mutate(KyrBP = .$calyrBP/1000)
Cari$d18Owater <- Cari$d18Owater %>% as.numeric()

Paci<-read.csv("./clim/ODP1020-tab.csv") #bringing in Pacific (California) climate data from Herbert et al., 2001
Paci <- Paci %>%
  filter(.$calyrBP <= 150000 & .$calyrBP >= 0) %>%
  mutate(KyrBP = .$calyrBP/1000)
Paci$d18Oforams.b <- Paci$d18Oforams.b %>% as.numeric()

Atla<-read.csv("./clim/Atlan_18O.csv") #bring in Mid-Atlantic (Bermuda) climate data from Henry et al., 2016
Atla <- Atla %>%
  filter(.$Age <= 150 & .$Age >= 0) %>%
  mutate(KyrBP = .$Age)
Atla$Mean.d18O.ruber <- Atla$Mean.d18O.ruber %>% as.numeric()


Ice_CO2 <- read.csv("./clim/CO2_conc.csv")
#filter the Zachos data to only include samples from our age range of 0 to 150000 years and create a new KyrBP column and convert years to thousands of years. 
Ice_CO2 <- Ice_CO2 %>%
  filter(.$Gasage_yr_BP <= 150000 & .$Gasage_yr_BP >= 0) %>%
  mutate(KyrBP = .$Gasage_yr_BP/1000)
```

```{r}
#creating an empty vector called yr
yr<-vector()

for (r in 1:6){ #looping through the 6 regions
  yr[r]<-tot.sm %>% #the maximum KyrBP value for each region is stored within the yr vector. This givens up the start date for each region
  filter(.$Region == r & rowSums(!is.na(.[3:144])) !=0) %>%
  .$KyrBP %>%
  max()
}
yr[4]<-NA #because the start date of region 5 (Intermountain West) is older than 150, we replace it with NA to show it extends beyond our time frame. 

#creating a start year dataframe with a column for the start year and a column for which region it is for
st.year <- data.frame(
  Region = c(1, 2, 3, 4, 5, 6),
  yr = yr
)

#again we want to label the MIS on the plot which is done here, this time it is not split into odd and even stages
mis_lab_sig <- data.frame(
  label = c("MIS 1", "MIS 2", "MIS 3", "MIS 4", "MIS 5a", "MIS 5b", "MIS 5c", "MIS 5d", "MIS 5e", "MIS 6"),
  x = c(5.85, 20.35, 43, 64, 74.5, 83, 97.25, 111.25, 123, 140),
  y = c(12, 12, 12, 12, 13.5, 12, 12, 13.5, 12, 12), #the y value differs for some labels to prevent overlap
  Region = c(1, 1, 1, 1, 1, 1, 1, 1, 1, 1) #all are being plotted above region 1
)
```

```{r}
Arctic18O<-ggplot(Arct, aes(KyrBP, d18Ob))+ #data is set to GRIP and the x values are KyrBP and y values are del18O
 #adding the same shaded rectangles to show the different MIS
  geom_rect(aes(xmin=11.7, xmax=29, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS2
  geom_rect(aes(xmin=57, xmax=71, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS4
  geom_rect(aes(xmin=78, xmax=88, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS5b
  geom_rect(aes(xmin=106.5, xmax=116, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS5d
  geom_rect(aes(xmin=130, xmax=Inf, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS6
  geom_point(alpha=0.5, size=0.4, shape=18) +
  #smooth the oxygen isotope data with a spline
  geom_spline(col="#000000", linewidth=0.4, na.rm=T, spar=0.25, alpha=0.8)+
  geom_point(data=Ice_CO2, 
             mapping=aes(KyrBP,-(((CO2_ppmv-min(CO2_ppmv, na.rm=T))*(max(Arct$d18Ob, na.rm=T)-min(Arct$d18Ob, na.rm=T)))/(max(CO2_ppmv, na.rm=T)-min(CO2_ppmv, na.rm=T))+min(Arct$d18Ob, na.rm=T))+(min(Arct$d18Ob, na.rm=T)+max(Arct$d18Ob, na.rm=T))), 
             alpha=0.5, size=0.2, shape=17, col="#1B7AE4") +
  #smooth the oxygen isotope data with a spline
  geom_spline(data=Ice_CO2, 
              mapping=aes(KyrBP, -(((CO2_ppmv-min(CO2_ppmv, na.rm=T))*(max(Arct$d18Ob, na.rm=T)-min(Arct$d18Ob, na.rm=T)))/(max(CO2_ppmv, na.rm=T)-min(CO2_ppmv, na.rm=T))+min(Arct$d18Ob, na.rm=T))+(min(Arct$d18Ob, na.rm=T)+max(Arct$d18Ob, na.rm=T))), 
              col="#1B7AE4", linewidth=0.4, na.rm=T, spar=0.25, alpha = 0.8)+
  scale_y_reverse(limits = c(
    max(Arct$d18Ob, na.rm=T), 
    min(Arct$d18Ob, na.rm=T)),
    sec.axis=sec_axis(~-(((.-min(Arct$d18Ob, na.rm=T))*(max(Ice_CO2$CO2_ppmv, na.rm=T)-min(Ice_CO2$CO2_ppmv, na.rm=T)))/(max(Arct$d18Ob, na.rm=T)-min(Arct$d18Ob, na.rm=T))+min(Ice_CO2$CO2_ppmv, na.rm=T))+(min(Ice_CO2$CO2_ppmv, na.rm=T)+max(Ice_CO2$CO2_ppmv, na.rm=T)), name=expression(CO[2]~(ppmv)))) +  
  theme_linedraw() + 
  theme(
    strip.text.x = element_blank(),
    axis.title = element_text(size=7, family = "sans"),
    axis.title.y = element_text(vjust=-1.5, hjust = 0.5), #give the y axis title a large right margin to make room to add text beneath it
    axis.text.x = element_blank(),
    axis.ticks.x=element_blank(),
    axis.text.y= element_text(size=4, family="sans"),
    axis.title.y.right = element_text(hjust =0.5, color = "#1B7AE4"),
    axis.text.y.right = element_text(color = "#1B7AE4"),
    panel.grid = element_blank(), 
    panel.spacing = unit(-0.01, "lines"),
    panel.border = element_rect(colour = "#000000", fill=NA, linewidth=0.25),
    legend.position = "none",
    plot.margin = margin(5,5,0,5, unit="pt") #change the plot margins so there is no bottom margin, allowing the plot to be stacked atop p.sig
    ) +
  labs(x = "", y = expression(delta^18*O~("\u2030"))) + #create the axis labels
  # create an arrow that is plotted outside of the plot but along the y axis
  geom_segment(aes(x = 151, xend = 151, 
                   y = min(d18Ob, na.rm=T), 
                   yend = max(d18Ob, na.rm=T)), 
               linewidth=0.25, 
               arrow = arrow(length = unit(4,"pt"), ends = "both", type = "closed")) +
  #add a label of cooler and warmer to be added to the ends of the arrow and rotate 90 degrees to be in line with the y axis title
  annotate("text", x= 154, y= max(Arct$d18Ob, na.rm=T)-0.25, label="cooler", angle = 90, size = 1.5, family = "sans")+
  annotate("text", x= 154, y= min(Arct$d18Ob, na.rm=T)+0.25, label="warmer", angle = 90, size = 1.5, family = "sans")+
  annotate("text", x = 10, y = 3-0.1, label= "A", size = 7, family = "sans", fontface="bold")+
  coord_cartesian(xlim = c(150, 0), clip = "off") #define the x axis limits and allow data to be plotted beyond the x axis range

Arc.div<-tot.sm %>%
  filter(.$Region==1)

Arc.sig.t.m <- list()
Arc.sig.f.m <- list()
Arc.sig.t <- list()
Arc.sig.f <- list()

for (i in 1:3){
  Arc.sig.t.m[[i]]<- sig.t.m[[i]] %>%
    filter(.$Region == 1)
  Arc.sig.f.m[[i]]<- sig.f.m[[i]] %>%
    filter(.$Region == 1)
  Arc.sig.t[[i]]<- sig.t[[i]] %>%
    filter(.$Region == 1)
  Arc.sig.f[[i]]<- sig.f[[i]] %>%
    filter(.$Region == 1)
}

Arc.sig.m<-ggplot(Arc.div, aes(KyrBP,(q0-q0.m)/q0.m))+
  geom_rect(aes(xmin=11.7, xmax=29, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS2
  geom_rect(aes(xmin=57, xmax=71, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS4
  geom_rect(aes(xmin=78, xmax=88, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS5b
  geom_rect(aes(xmin=106.5, xmax=116, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS5d
  geom_rect(aes(xmin=130, xmax=Inf, ymin=-Inf, ymax=Inf), fill="#D2D2D2") +
  geom_vline(aes(xintercept = yr[1]), st.year[1,], size=0.5, linetype = 1, col="#5a5a5a") +
  #adding horizontal line at y=0 to show the mean
  geom_hline(yintercept = 0, color="#5a5a5a", linetype=5, linewidth=0.25) +
  #here we plot the taxonomic q=0 for each site and color black
  geom_line(data=Arc.div, 
            mapping=aes(group=site),col="#000000", na.rm=T, alpha=0.5, linewidth=0.25)+
  geom_line(data=Arc.div, 
            mapping=aes(KyrBP,(fq0-fq0.m)/fq0.m, group=site),col="#e4851b", na.rm=T, alpha=0.5, 
            linewidth=0.25) +
  geom_smooth(mapping=aes(KyrBP,(q0-q0.m)/q0.m), method="gam", formula=y ~ s(x, bs="tp"), method.args = list(family = gaussian(link = "identity")), n=100, na.rm=T, col="#000000", 
             linewidth=0.5, level=0.95, alpha=0.63) +
  #plotting the taxonomic significant decreases by filtering out all of the NA values in the sig.t dec column
  geom_line(data=Arc.sig.t.m[[1]]%>%filter(!is.na(.$dec)), mapping=aes(x, y, group=dec), col="#000000", linewidth=1.5, alpha=0.7) + 
  #plotting the taxonomic significant increases by filtering out all of the NA values in the sig.t inc column
  geom_line(data=Arc.sig.t.m[[1]]%>%filter(!is.na(.$inc)), mapping=aes(x, y, group=inc), col="#000000", linewidth=1.5, alpha=0.7) +
  #smoothing all of the site functional q=0 values with a GAM and plotting in orange
  geom_smooth(mapping=aes(KyrBP,(fq0-fq0.m)/fq0.m), method="gam", formula=y ~ s(x, bs="tp"), method.args = list(family = gaussian(link = "identity")), n=100, na.rm=T, col="#e4851b", 
              linewidth=0.5, level=0.95, alpha=0.63) +
  #The same is done for the functional significant increases and decreases but they are plotted in orange 
  geom_line(data=Arc.sig.f.m[[1]]%>%filter(!is.na(.$dec)), mapping=aes(x, y, group=dec), col="#e4851b", linewidth=1.5, alpha=0.7) +
  geom_line(data=Arc.sig.f.m[[1]]%>%filter(!is.na(.$inc)), mapping=aes(x, y, group=inc), col="#e4851b", linewidth=1.5, alpha=0.7) +
  theme_linedraw() + 
  theme(
    strip.text.x = element_blank(),
    axis.title = element_text(size=7, family="sans"),
    axis.title.y = element_text(size=6, vjust=-1.5, hjust = 0.5), #give the y axis title a large right margin to make room to add text beneath it
    axis.text.y= element_text(size=4, family="sans"),
    axis.text.x = element_text(size=4, family="sans"),
    panel.grid = element_blank(), 
    panel.spacing = unit(-0.01, "lines"),
    panel.border = element_rect(colour = "black", fill=NA, size=0.25),
    plot.margin = margin(0,5,5,5, unit="pt")
    )+
  scale_x_reverse(n.breaks=15) +
  #vertical lines are added to indicate the start of the record for each region
  labs(y = "Normalized Diversity Relative to Mean", x = "Age (cal ka BP)")+
  #facet_wrap(~Region, nrow=7, ncol=1) + #the plots are arranged in 1 column with 7 rows
  geom_text( #region labels are again added
    check_overlap = T,
    data = dat_text,
    mapping = aes(x = 157, y = 0.8, label = label),
    hjust="left",
    vjust="bottom",
    fontface="bold",
    family= "sans",
    size=3
  ) +
  geom_text( #MIS labels are added
    data = mis_lab_sig,
    mapping = aes(x = x, y = (y/20)-1.6, label = label),
    hjust="middle",
    vjust="top",
    fontface = "bold",
    family="sans",
    size=1.5
  ) +
  coord_cartesian(ylim=c(-1, 0.9), xlim=c(150, 0), clip="off") #y axis limits (0,10) are defined and clip is turned off to allow labels to be placed outside of the plot

Arc.fig.m<-ggarrange(Arctic18O, NULL, Arc.sig.m, ncol=1, nrow=3, align = "v", heights = c(1, -0.15, 1.4))

ggsave("./plots/Arct_clim_mean_q0.pdf", Arc.fig.m, width=3, height=3, units = "in", device="pdf")

Arc.sig<-ggplot(Arc.div, aes(KyrBP,q0))+
  geom_rect(aes(xmin=11.7, xmax=29, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS2
  geom_rect(aes(xmin=57, xmax=71, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS4
  geom_rect(aes(xmin=78, xmax=88, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS5b
  geom_rect(aes(xmin=106.5, xmax=116, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS5d
  geom_rect(aes(xmin=130, xmax=Inf, ymin=-Inf, ymax=Inf), fill="#D2D2D2") +
  geom_vline(aes(xintercept = yr[1]), st.year[1,], size=0.5, linetype = 1, col="#5a5a5a") +
  #here we plot the taxonomic q=0 for each site and color black
  geom_line(data=Arc.div, 
            mapping=aes(group=site),col="#000000", na.rm=T, alpha=0.5, linewidth=0.25)+
  geom_line(data=Arc.div, 
            mapping=aes(KyrBP,fq0, group=site),col="#e4851b", na.rm=T, alpha=0.5, 
            linewidth=0.25) +
  geom_smooth(mapping=aes(KyrBP,q0), method="gam", formula=y ~ s(x, bs="tp"), method.args = list(family = gaussian(link = "identity")), n=100, na.rm=T, col="#000000", 
             linewidth=0.5, level=0.95, alpha=0.63) +
  #plotting the taxonomic significant decreases by filtering out all of the NA values in the sig.t dec column
  geom_line(data=Arc.sig.t[[1]]%>%filter(!is.na(.$dec)), mapping=aes(x, y, group=dec), col="#000000", 
            linewidth=1.5, alpha=0.7) + 
  #plotting the taxonomic significant increases by filtering out all of the NA values in the sig.t inc column
  geom_line(data=Arc.sig.t[[1]]%>%filter(!is.na(.$inc)), mapping=aes(x, y, group=inc), col="#000000", 
            linewidth=1.5, alpha=0.7) +
  #smoothing all of the site functional q=0 values with a GAM and plotting in orange
  geom_smooth(mapping=aes(KyrBP,fq0), method="gam", formula=y ~ s(x, bs="tp"), method.args = list(family = gaussian(link = "identity")), n=100, na.rm=T, col="#e4851b", 
              linewidth=0.5, level=0.95, alpha=0.63) +
  #The same is done for the functional significant increases and decreases but they are plotted in orange 
  geom_line(data=Arc.sig.f[[1]]%>%filter(!is.na(.$dec)), mapping=aes(x, y, group=dec), col="#e4851b", 
            linewidth=1.5, alpha=0.7) +
  geom_line(data=Arc.sig.f[[1]]%>%filter(!is.na(.$inc)), mapping=aes(x, y, group=inc), col="#e4851b", 
            linewidth=1.5, alpha=0.7) +
  theme_linedraw() + 
  theme(
    strip.text.x = element_blank(),
    axis.title = element_text(size=7, family="sans"),
    axis.title.y = element_text(size=6, vjust=-1.5, hjust = 0.5), #give the y axis title a large right margin to make room to add text beneath it
    axis.text.y= element_text(size=4, family="sans"),
    axis.text.x = element_text(size=4, family="sans"),
    panel.grid = element_blank(), 
    panel.spacing = unit(-0.01, "lines"),
    panel.border = element_rect(colour = "black", fill=NA, size=0.25),
    plot.margin = margin(0,5,5,5, unit="pt")
    )+
  scale_x_reverse(n.breaks=15) +
  #vertical lines are added to indicate the start of the record for each region
  labs(y = "Plant Diversity (Effective Number of Species)", x = "Age (cal ka BP)")+
  #facet_wrap(~Region, nrow=7, ncol=1) + #the plots are arranged in 1 column with 7 rows
  geom_text( #region labels are again added
    check_overlap = T,
    data = dat_text,
    mapping = aes(x = 157, y = 78, label = label),
    hjust="left",
    vjust="bottom",
    fontface="bold",
    family= "sans",
    size=3
  ) +
  geom_text( #MIS labels are added
    data = mis_lab_sig,
    mapping = aes(x = x, y = (y*2)-23, label = label),
    hjust="middle",
    vjust="top",
    fontface = "bold",
    family="sans",
    size=1.5
  ) +
  coord_cartesian(ylim=c(1, 82), xlim=c(150, 0), clip="off") #y axis limits (0,10) are defined and clip is turned off to allow labels to be placed outside of the plot

Arc.fig<-ggarrange(Arctic18O, NULL, Arc.sig, ncol=1, nrow=3, align = "v", heights = c(1, -0.15, 1.4))

ggsave("./supplemental plots/Arct_clim_raw_q0.pdf", Arc.fig, width=3, height=3, units = "in", device="pdf")

#q1---------------------------
Arc.sig.m.q1<-ggplot(Arc.div, aes(KyrBP,(q1-q1.m)/q1.m))+
  geom_rect(aes(xmin=11.7, xmax=29, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS2
  geom_rect(aes(xmin=57, xmax=71, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS4
  geom_rect(aes(xmin=78, xmax=88, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS5b
  geom_rect(aes(xmin=106.5, xmax=116, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS5d
  geom_rect(aes(xmin=130, xmax=Inf, ymin=-Inf, ymax=Inf), fill="#D2D2D2") +
  geom_vline(aes(xintercept = yr[1]), st.year[1,], size=0.5, linetype = 1, col="#5a5a5a") +
  #adding horizontal line at y=0 to show the mean
  geom_hline(yintercept = 0, color="#5a5a5a", linetype=5, linewidth=0.25) +
  #here we plot the taxonomic q=0 for each site and color black
  geom_line(data=Arc.div, 
            mapping=aes(group=site),col="#000000", na.rm=T, alpha=0.5, linewidth=0.25)+
  geom_line(data=Arc.div, 
            mapping=aes(KyrBP,(fq1-fq1.m)/fq1.m, group=site),col="#e4851b", na.rm=T, alpha=0.5, 
            linewidth=0.25) +
  geom_smooth(mapping=aes(KyrBP,(q1-q1.m)/q1.m), method="gam", formula=y ~ s(x, bs="tp"), method.args = list(family = gaussian(link = "identity")), n=100, na.rm=T, col="#000000", 
             linewidth=0.5, level=0.95, alpha=0.63) +
  #plotting the taxonomic significant decreases by filtering out all of the NA values in the sig.t dec column
  geom_line(data=Arc.sig.t.m[[2]]%>%filter(!is.na(.$dec)), mapping=aes(x, y, group=dec), col="#000000", 
            linewidth=1.5, alpha=0.7) + 
  #plotting the taxonomic significant increases by filtering out all of the NA values in the sig.t inc column
  geom_line(data=Arc.sig.t.m[[2]]%>%filter(!is.na(.$inc)), mapping=aes(x, y, group=inc), col="#000000", 
            linewidth=1.5, alpha=0.7) +
  #smoothing all of the site functional q=0 values with a GAM and plotting in orange
  geom_smooth(mapping=aes(KyrBP,(fq1-fq1.m)/fq1.m), method="gam", formula=y ~ s(x, bs="tp"), method.args = list(family = gaussian(link = "identity")), n=100, na.rm=T, col="#e4851b", 
              linewidth=0.5, level=0.95, alpha=0.63) +
  #The same is done for the functional significant increases and decreases but they are plotted in orange 
  geom_line(data=Arc.sig.f.m[[2]]%>%filter(!is.na(.$dec)), mapping=aes(x, y, group=dec), col="#e4851b", 
            linewidth=1.5, alpha=0.7) +
  geom_line(data=Arc.sig.f.m[[2]]%>%filter(!is.na(.$inc)), mapping=aes(x, y, group=inc), col="#e4851b", 
            linewidth=1.5, alpha=0.7) +
  theme_linedraw() + 
  theme(
    strip.text.x = element_blank(),
    axis.title = element_text(size=7, family="sans"),
    axis.title.y = element_text(size=6, vjust=-1.5, hjust = 0.5), #give the y axis title a large right margin to make room to add text beneath it
    axis.text.y= element_text(size=4, family="sans"),
    axis.text.x = element_text(size=4, family="sans"),
    panel.grid = element_blank(), 
    panel.spacing = unit(-0.01, "lines"),
    panel.border = element_rect(colour = "black", fill=NA, size=0.25),
    plot.margin = margin(0,5,5,5, unit="pt")
    )+
  scale_x_reverse(n.breaks=15) +
  #vertical lines are added to indicate the start of the record for each region
  labs(y = "Normalized Diversity Relative to Mean", x = "Age (cal ka BP)")+
  #facet_wrap(~Region, nrow=7, ncol=1) + #the plots are arranged in 1 column with 7 rows
  geom_text( #region labels are again added
    check_overlap = T,
    data = dat_text,
    mapping = aes(x = 157, y = 1.28, label = label),
    hjust="left",
    vjust="bottom",
    fontface="bold",
    family= "sans",
    size=3
  ) +
  geom_text( #MIS labels are added
    data = mis_lab_sig,
    mapping = aes(x = x, y = (y/17)-1.5, label = label),
    hjust="middle",
    vjust="top",
    fontface = "bold",
    family="sans",
    size=1.5
  ) +
  coord_cartesian(ylim=c(-0.8, 1.4), xlim=c(150, 0), clip="off") #y axis limits (0,10) are defined and clip is turned off to allow labels to be placed outside of the plot

Arc.fig.m.q1<-ggarrange(Arctic18O, NULL, Arc.sig.m.q1, ncol=1, nrow=3, align = "v", heights = c(1, -0.15, 1.4))

ggsave("./plots/Arct_clim_mean_q1.pdf", Arc.fig.m.q1, width=3, height=3, units = "in", device="pdf")

Arc.sig.q1<-ggplot(Arc.div, aes(KyrBP,q1))+
  geom_rect(aes(xmin=11.7, xmax=29, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS2
  geom_rect(aes(xmin=57, xmax=71, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS4
  geom_rect(aes(xmin=78, xmax=88, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS5b
  geom_rect(aes(xmin=106.5, xmax=116, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS5d
  geom_rect(aes(xmin=130, xmax=Inf, ymin=-Inf, ymax=Inf), fill="#D2D2D2") +
  geom_vline(aes(xintercept = yr[1]), st.year[1,], size=0.5, linetype = 1, col="#5a5a5a") +
  #here we plot the taxonomic q=0 for each site and color black
  geom_line(data=Arc.div, 
            mapping=aes(group=site),col="#000000", na.rm=T, alpha=0.5, linewidth=0.25)+
  geom_line(data=Arc.div, 
            mapping=aes(KyrBP,fq1, group=site),col="#e4851b", na.rm=T, alpha=0.5, 
            linewidth=0.25) +
  geom_smooth(mapping=aes(KyrBP,q1), method="gam", formula=y ~ s(x, bs="tp"), method.args = list(family = gaussian(link = "identity")), n=100, na.rm=T, col="#000000", 
             linewidth=0.5, level=0.95, alpha=0.63) +
  #plotting the taxonomic significant decreases by filtering out all of the NA values in the sig.t dec column
  geom_line(data=Arc.sig.t[[2]]%>%filter(!is.na(.$dec)), mapping=aes(x, y, group=dec), col="#000000", 
            linewidth=1.5, alpha=0.7) + 
  #plotting the taxonomic significant increases by filtering out all of the NA values in the sig.t inc column
  geom_line(data=Arc.sig.t[[2]]%>%filter(!is.na(.$inc)), mapping=aes(x, y, group=inc), col="#000000", 
            linewidth=1.5, alpha=0.7) +
  #smoothing all of the site functional q=0 values with a GAM and plotting in orange
  geom_smooth(mapping=aes(KyrBP,fq1), method="gam", formula=y ~ s(x, bs="tp"), method.args = list(family = gaussian(link = "identity")), n=100, na.rm=T, col="#e4851b", 
              linewidth=0.5, level=0.95, alpha=0.63) +
  #The same is done for the functional significant increases and decreases but they are plotted in orange 
  geom_line(data=Arc.sig.f[[2]]%>%filter(!is.na(.$dec)), mapping=aes(x, y, group=dec), col="#e4851b", 
            linewidth=1.5, alpha=0.7) +
  geom_line(data=Arc.sig.f[[2]]%>%filter(!is.na(.$inc)), mapping=aes(x, y, group=inc), col="#e4851b", 
            linewidth=1.5, alpha=0.7) +
  theme_linedraw() + 
  theme(
    strip.text.x = element_blank(),
    axis.title = element_text(size=7, family="sans"),
    axis.title.y = element_text(size=6, vjust=-1.5, hjust = 0.5), #give the y axis title a large right margin to make room to add text beneath it
    axis.text.y= element_text(size=4, family="sans"),
    axis.text.x = element_text(size=4, family="sans"),
    panel.grid = element_blank(), 
    panel.spacing = unit(-0.01, "lines"),
    panel.border = element_rect(colour = "black", fill=NA, size=0.25),
    plot.margin = margin(0,5,5,5, unit="pt")
    )+
  scale_x_reverse(n.breaks=15) +
  #vertical lines are added to indicate the start of the record for each region
  labs(y = "Plant Diversity (Effective Number of Species)", x = "Age (cal ka BP)")+
  #facet_wrap(~Region, nrow=7, ncol=1) + #the plots are arranged in 1 column with 7 rows
  geom_text( #region labels are again added
    check_overlap = T,
    data = dat_text,
    mapping = aes(x = 157, y = 19, label = label),
    hjust="left",
    vjust="bottom",
    fontface="bold",
    family= "sans",
    size=3
  ) +
  geom_text( #MIS labels are added
    data = mis_lab_sig,
    mapping = aes(x = x, y = (y/2)-5, label = label),
    hjust="middle",
    vjust="top",
    fontface = "bold",
    family="sans",
    size=1.5
  ) +
  coord_cartesian(ylim=c(1, 20), xlim=c(150, 0), clip="off") #y axis limits (0,10) are defined and clip is turned off to allow labels to be placed outside of the plot

Arc.fig.q1<-ggarrange(Arctic18O, NULL, Arc.sig.q1, ncol=1, nrow=3, align = "v", heights = c(1, -0.15, 1.4))

ggsave("./supplemental plots/Arct_clim_raw_q1.pdf", Arc.fig.q1, width=3, height=3, units = "in", device="pdf")

#q2------------------
Arc.sig.m.q2<-ggplot(Arc.div, aes(KyrBP,(q2-q2.m)/q2.m))+
  geom_rect(aes(xmin=11.7, xmax=29, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS2
  geom_rect(aes(xmin=57, xmax=71, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS4
  geom_rect(aes(xmin=78, xmax=88, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS5b
  geom_rect(aes(xmin=106.5, xmax=116, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS5d
  geom_rect(aes(xmin=130, xmax=Inf, ymin=-Inf, ymax=Inf), fill="#D2D2D2") +
  geom_vline(aes(xintercept = yr[1]), st.year[1,], size=0.5, linetype = 1, col="#5a5a5a") +
  #adding horizontal line at y=0 to show the mean
  geom_hline(yintercept = 0, color="#5a5a5a", linetype=5, linewidth=0.25) +
  #here we plot the taxonomic q=0 for each site and color black
  geom_line(data=Arc.div, 
            mapping=aes(group=site),col="#000000", na.rm=T, alpha=0.5, linewidth=0.25)+
  geom_line(data=Arc.div, 
            mapping=aes(KyrBP,(fq2-fq2.m)/fq2.m, group=site),col="#e4851b", na.rm=T, alpha=0.5, 
            linewidth=0.25) +
  geom_smooth(mapping=aes(KyrBP,(q2-q2.m)/q2.m), method="gam", formula=y ~ s(x, bs="tp"), method.args = list(family = gaussian(link = "identity")), n=100, na.rm=T, col="#000000", 
             linewidth=0.5, level=0.95, alpha=0.63) +
  #plotting the taxonomic significant decreases by filtering out all of the NA values in the sig.t dec column
  geom_line(data=Arc.sig.t.m[[3]]%>%filter(!is.na(.$dec)), mapping=aes(x, y, group=dec), col="#000000", 
            linewidth=1.5, alpha=0.7) + 
  #plotting the taxonomic significant increases by filtering out all of the NA values in the sig.t inc column
  geom_line(data=Arc.sig.t.m[[3]]%>%filter(!is.na(.$inc)), mapping=aes(x, y, group=inc), col="#000000", 
            linewidth=1.5, alpha=0.7) +
  #smoothing all of the site functional q=0 values with a GAM and plotting in orange
  geom_smooth(mapping=aes(KyrBP,(fq2-fq2.m)/fq2.m), method="gam", formula=y ~ s(x, bs="tp"), method.args = list(family = gaussian(link = "identity")), n=100, na.rm=T, col="#e4851b", 
              linewidth=0.5, level=0.95, alpha=0.63) +
  #The same is done for the functional significant increases and decreases but they are plotted in orange 
  geom_line(data=Arc.sig.f.m[[3]]%>%filter(!is.na(.$dec)), mapping=aes(x, y, group=dec), col="#e4851b", 
            linewidth=1.5, alpha=0.7) +
  geom_line(data=Arc.sig.f.m[[3]]%>%filter(!is.na(.$inc)), mapping=aes(x, y, group=inc), col="#e4851b", 
            linewidth=1.5, alpha=0.7) +
  theme_linedraw() + 
  theme(
    strip.text.x = element_blank(),
    axis.title = element_text(size=7, family="sans"),
    axis.title.y = element_text(size=6, vjust=-1.5, hjust = 0.5), #give the y axis title a large right margin to make room to add text beneath it
    axis.text.y= element_text(size=4, family="sans"),
    axis.text.x = element_text(size=4, family="sans"),
    panel.grid = element_blank(), 
    panel.spacing = unit(-0.01, "lines"),
    panel.border = element_rect(colour = "black", fill=NA, size=0.25),
    plot.margin = margin(0,5,5,5, unit="pt")
    )+
  scale_x_reverse(n.breaks=15) +
  scale_y_continuous(breaks=c(-0.5, 0, 0.5, 1, 1.5)) +
  #vertical lines are added to indicate the start of the record for each region
  labs(y = "Normalized Diversity Relative to Mean", x = "Age (cal ka BP)")+
  #facet_wrap(~Region, nrow=7, ncol=1) + #the plots are arranged in 1 column with 7 rows
  geom_text( #region labels are again added
    check_overlap = T,
    data = dat_text,
    mapping = aes(x = 157, y = 1.48, label = label),
    hjust="left",
    vjust="bottom",
    fontface="bold",
    family= "sans",
    size=3
  ) +
  geom_text( #MIS labels are added
    data = mis_lab_sig,
    mapping = aes(x = x, y = (y/17)-1.4, label = label),
    hjust="middle",
    vjust="top",
    fontface = "bold",
    family="sans",
    size=1.5
  ) +
  coord_cartesian(ylim=c(-0.7, 1.6), xlim=c(150, 0), clip="off") #y axis limits (0,10) are defined and clip is turned off to allow labels to be placed outside of the plot

Arc.fig.m.q2<-ggarrange(Arctic18O, NULL, Arc.sig.m.q2, ncol=1, nrow=3, align = "v", heights = c(1, -0.15, 1.4))

ggsave("./plots/Arct_clim_mean_q2.pdf", Arc.fig.m.q2, width=3, height=3, units = "in", device="pdf")

Arc.sig.q2<-ggplot(Arc.div, aes(KyrBP,q2))+
  geom_rect(aes(xmin=11.7, xmax=29, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS2
  geom_rect(aes(xmin=57, xmax=71, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS4
  geom_rect(aes(xmin=78, xmax=88, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS5b
  geom_rect(aes(xmin=106.5, xmax=116, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS5d
  geom_rect(aes(xmin=130, xmax=Inf, ymin=-Inf, ymax=Inf), fill="#D2D2D2") +
  geom_vline(aes(xintercept = yr[1]), st.year[1,], size=0.5, linetype = 1, col="#5a5a5a") +
  #here we plot the taxonomic q=0 for each site and color black
  geom_line(data=Arc.div, 
            mapping=aes(group=site),col="#000000", na.rm=T, alpha=0.5, linewidth=0.25)+
  geom_line(data=Arc.div, 
            mapping=aes(KyrBP,fq2, group=site),col="#e4851b", na.rm=T, alpha=0.5, 
            linewidth=0.25) +
  geom_smooth(mapping=aes(KyrBP,q2), method="gam", formula=y ~ s(x, bs="tp"), method.args = list(family = gaussian(link = "identity")), n=100, na.rm=T, col="#000000", 
             linewidth=0.5, level=0.95, alpha=0.63) +
  #plotting the taxonomic significant decreases by filtering out all of the NA values in the sig.t dec column
  geom_line(data=Arc.sig.t[[3]]%>%filter(!is.na(.$dec)), mapping=aes(x, y, group=dec), col="#000000", 
            linewidth=1.5, alpha=0.7) + 
  #plotting the taxonomic significant increases by filtering out all of the NA values in the sig.t inc column
  geom_line(data=Arc.sig.t[[3]]%>%filter(!is.na(.$inc)), mapping=aes(x, y, group=inc), col="#000000", 
            linewidth=1.5, alpha=0.7) +
  #smoothing all of the site functional q=0 values with a GAM and plotting in orange
  geom_smooth(mapping=aes(KyrBP,fq2), method="gam", formula=y ~ s(x, bs="tp"), method.args = list(family = gaussian(link = "identity")), n=100, na.rm=T, col="#e4851b", 
              linewidth=0.5, level=0.95, alpha=0.63) +
  #The same is done for the functional significant increases and decreases but they are plotted in orange 
  geom_line(data=Arc.sig.f[[3]]%>%filter(!is.na(.$dec)), mapping=aes(x, y, group=dec), col="#e4851b", 
            linewidth=1.5, alpha=0.7) +
  geom_line(data=Arc.sig.f[[3]]%>%filter(!is.na(.$inc)), mapping=aes(x, y, group=inc), col="#e4851b", 
            linewidth=1.5, alpha=0.7) +
  theme_linedraw() + 
  theme(
    strip.text.x = element_blank(),
    axis.title = element_text(size=7, family="sans"),
    axis.title.y = element_text(size=6, vjust=-1.5, hjust = 0.5), #give the y axis title a large right margin to make room to add text beneath it
    axis.text.y= element_text(size=4, family="sans"),
    axis.text.x = element_text(size=4, family="sans"),
    panel.grid = element_blank(), 
    panel.spacing = unit(-0.01, "lines"),
    panel.border = element_rect(colour = "black", fill=NA, size=0.25),
    plot.margin = margin(0,5,5,5, unit="pt")
    )+
  scale_x_reverse(n.breaks=15) +
  #vertical lines are added to indicate the start of the record for each region
  labs(y = "Plant Diversity (Effective Number of Species)", x = "Age (cal ka BP)")+
  #facet_wrap(~Region, nrow=7, ncol=1) + #the plots are arranged in 1 column with 7 rows
  geom_text( #region labels are again added
    check_overlap = T,
    data = dat_text,
    mapping = aes(x = 157, y = 12.4, label = label),
    hjust="left",
    vjust="bottom",
    fontface="bold",
    family= "sans",
    size=3
  ) +
  geom_text( #MIS labels are added
    data = mis_lab_sig,
    mapping = aes(x = x, y = (y/3)-3, label = label),
    hjust="middle",
    vjust="top",
    fontface = "bold",
    family="sans",
    size=1.5
  ) +
  coord_cartesian(ylim=c(1, 13), xlim=c(150, 0), clip="off") #y axis limits (0,10) are defined and clip is turned off to allow labels to be placed outside of the plot

Arc.fig.q2<-ggarrange(Arctic18O, NULL, Arc.sig.q2, ncol=1, nrow=3, align = "v", heights = c(1, -0.15, 1.4))

ggsave("./supplemental plots/Arct_clim_raw_q2.pdf", Arc.fig.q2, width=3, height=3, units = "in", device="pdf")
```

```{r}
Car18O<-ggplot(Cari, aes(KyrBP, d18Owater))+ #data is set to GRIP and the x values are KyrBP and y values are del18O
 #adding the same shaded rectangles to show the different MIS
  geom_rect(aes(xmin=11.7, xmax=29, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS2
  geom_rect(aes(xmin=57, xmax=71, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS4
  geom_rect(aes(xmin=78, xmax=88, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS5b
  geom_rect(aes(xmin=106.5, xmax=116, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS5d
  geom_rect(aes(xmin=130, xmax=Inf, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS6
  geom_point(alpha=0.5, size=0.4, shape=18) +
  #smooth the oxygen isotope data with a spline
  geom_spline(col="#000000", linewidth=0.4, na.rm=T, spar=0.25, alpha = 0.8)+
  geom_point(data=Ice_CO2, 
             mapping=aes(KyrBP,-(((CO2_ppmv-min(CO2_ppmv, na.rm=T))*(max(Cari$d18Owater, na.rm=T)-min(Cari$d18Owater, na.rm=T)))/(max(CO2_ppmv, na.rm=T)-min(CO2_ppmv, na.rm=T))+min(Cari$d18Owater, na.rm=T))+(min(Cari$d18Owater, na.rm=T)+max(Cari$d18Owater, na.rm=T))), alpha=0.5, size=0.2, shape=17, col="#1b7ae4") +
  #smooth the oxygen isotope data with a spline
  geom_spline(data=Ice_CO2, 
              mapping=aes(KyrBP, -(((CO2_ppmv-min(CO2_ppmv, na.rm=T))*(max(Cari$d18Owater, na.rm=T)-min(Cari$d18Owater, na.rm=T)))/(max(CO2_ppmv, na.rm=T)-min(CO2_ppmv, na.rm=T))+min(Cari$d18Owater, na.rm=T))+(min(Cari$d18Owater, na.rm=T)+max(Cari$d18Owater, na.rm=T))), 
              col="#1b7ae4", linewidth=0.4, na.rm=T, spar=0.25, alpha = 0.8)+
  scale_y_reverse(limits = c(
    max(Cari$d18Owater, na.rm=T), 
    min(Cari$d18Owater, na.rm=T)),
    sec.axis=sec_axis(~-(((.-min(Cari$d18Owater, na.rm=T))*(max(Ice_CO2$CO2_ppmv, na.rm=T)-min(Ice_CO2$CO2_ppmv, na.rm=T)))/(max(Cari$d18Owater, na.rm=T)-min(Cari$d18Owater, na.rm=T))+min(Ice_CO2$CO2_ppmv, na.rm=T))+(min(Ice_CO2$CO2_ppmv, na.rm=T)+max(Ice_CO2$CO2_ppmv, na.rm=T)), name=expression(CO[2]~(ppmv)))) +  
  theme_linedraw() + 
   theme(
    strip.text.x = element_blank(),
    axis.title = element_text(size=7, family = "sans"),
    axis.title.y = element_text(vjust=-1.5, hjust = 0.5), #give the y axis title a large right margin to make room to add text beneath it
    axis.text.x = element_blank(),
    axis.ticks.x=element_blank(),
    axis.text.y= element_text(size=4, family="sans"),
    axis.title.y.right = element_text(hjust =0.5, color = "#1B7AE4"),
    axis.text.y.right = element_text(color = "#1B7AE4"),
    panel.grid = element_blank(), 
    panel.spacing = unit(-0.01, "lines"),
    panel.border = element_rect(colour = "#000000", fill=NA, linewidth=0.25),
    legend.position = "none",
    plot.margin = margin(5,5,0,5, unit="pt") #change the plot margins so there is no bottom margin, allowing the plot to be stacked atop p.sig
    ) +
  labs(x = "", y = expression(delta^18*O~("\u2030"))) + #create the axis labels
  # create an arrow that is plotted outside of the plot but along the y axis
  geom_segment(aes(x = 151, xend = 151, 
                   y = min(d18Owater, na.rm=T), 
                   yend = max(d18Owater, na.rm=T)), 
               size=0.25, 
               arrow = arrow(length = unit(4,"pt"), ends = "both", type = "closed")) +
  #add a label of cooler and warmer to be added to the ends of the arrow and rotate 90 degrees to be in line with the y axis title
  annotate("text", x= 154, y= max(Cari$d18Owater, na.rm=T)-0.29, label="cooler", angle = 90, size = 1.5, family = "sans")+
  annotate("text", x= 154, y= min(Cari$d18Owater, na.rm=T)+0.29, label="warmer", angle = 90, size = 1.5, family = "sans")+
  annotate("text", x=10, y=0.62, label="C", size = 7, family="sans", fontface="bold")+
  coord_cartesian(xlim = c(150, 0), clip = "off") #define the x axis limits and allow data to be plotted beyond the x axis range

Car.div<-tot.sm %>%
  filter(.$Region==3 | .$Region==6)

Car.sig.t.m <- list()
Car.sig.f.m <- list()
Car.sig.t <- list()
Car.sig.f <- list()

for (i in 1:3){
  Car.sig.t.m[[i]]<- sig.t.m[[i]] %>%
    filter(.$Region == 3 | .$Region == 6)
  Car.sig.f.m[[i]]<- sig.f.m[[i]] %>%
    filter(.$Region == 3 | .$Region == 6)
  Car.sig.t[[i]]<- sig.t[[i]] %>%
    filter(.$Region == 3 | .$Region == 6)
  Car.sig.f[[i]]<- sig.f[[i]] %>%
    filter(.$Region == 3 | .$Region == 6)
}

Car.mis_lab_sig <- mis_lab_sig %>%
  mutate(Region = 6)

Car.dat_text <- dat_text %>%
  filter(.$Region==3 | .$Region==6)

car.st.year <- st.year %>%
  filter(.$Region==3 | .$Region==6)

Car.sig.m<-ggplot(Car.div, aes(KyrBP,(q0-q0.m)/q0.m))+
  geom_rect(aes(xmin=11.7, xmax=29, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS2
  geom_rect(aes(xmin=57, xmax=71, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS4
  geom_rect(aes(xmin=78, xmax=88, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS5b
  geom_rect(aes(xmin=106.5, xmax=116, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS5d
  geom_rect(aes(xmin=130, xmax=Inf, ymin=-Inf, ymax=Inf), fill="#D2D2D2") +
  geom_vline(aes(xintercept = yr), car.st.year, size=0.5, linetype = 1, col="#5a5a5a") +
  theme_linedraw() + 
  theme(
    strip.text.x = element_blank(),
    axis.title = element_text(size=7, family="sans"),
    axis.title.y = element_text(size=6, vjust=-1.5, hjust = 0.5), #give the y axis title a large right margin to make room to add text beneath it
    axis.text.y= element_text(size=4, family="sans"),
    axis.text.x = element_text(size=4, family="sans"),
    panel.grid = element_blank(), 
    panel.spacing = unit(-0.01, "lines"),
    panel.border = element_rect(colour = "black", fill=NA, size=0.25),
    plot.margin = margin(0,5,5,5, unit="pt")
    )+
  scale_x_reverse(n.breaks=15) +
  geom_hline(yintercept = 0, color="#5a5a5a", linetype=5, linewidth=0.25) +
  #here we plot the taxonomic q=0 for each site and color black
  geom_line(data=Car.div, 
            mapping=aes(group=site),col="#000000", na.rm=T, alpha=0.5, linewidth=0.25)+
  geom_line(data=Car.div, 
            mapping=aes(KyrBP,(fq0-fq0.m)/fq0.m, group=site),col="#e4851b", na.rm=T, alpha=0.5, 
            linewidth=0.25) +
  geom_smooth(mapping=aes(KyrBP,(q0-q0.m)/q0.m), method="gam", formula=y ~ s(x, bs="tp"), method.args = list(family = gaussian(link = "identity")), n=100, na.rm=T, col="#000000", 
             linewidth=0.5, level=0.95, alpha=0.63) +
  #plotting the taxonomic significant decreases by filtering out all of the NA values in the sig.t dec column
  geom_line(data=Car.sig.t.m[[1]]%>%filter(!is.na(.$dec)), mapping=aes(x, y, group=dec), col="#000000", 
            linewidth=1.5, alpha=0.7) + 
  #plotting the taxonomic significant increases by filtering out all of the NA values in the sig.t inc column
  geom_line(data=Car.sig.t.m[[1]]%>%filter(!is.na(.$inc)), mapping=aes(x, y, group=inc), col="#000000", 
            linewidth=1.5, alpha=0.7) +
  #smoothing all of the site functional q=0 values with a GAM and plotting in orange
  geom_smooth(mapping=aes(KyrBP,(fq0-fq0.m)/fq0.m), method="gam", formula=y ~ s(x, bs="tp"), method.args = list(family = gaussian(link = "identity")), n=100, na.rm=T, col="#e4851b", 
              linewidth=0.5, level=0.95, alpha=0.63) +
  #The same is done for the functional significant increases and decreases but they are plotted in orange 
  geom_line(data=Car.sig.f.m[[1]]%>%filter(!is.na(.$dec)), mapping=aes(x, y, group=dec), col="#e4851b", 
            linewidth=1.5, alpha=0.7) +
  geom_line(data=Car.sig.f.m[[1]]%>%filter(!is.na(.$inc)), mapping=aes(x, y, group=inc), col="#e4851b", 
            linewidth=1.5, alpha=0.7) +
  #vertical lines are added to indicate the start of the record for each region
  labs(y = "Normalized Diversity Relative to Mean", x = "Age (cal ka BP)")+
  facet_wrap(~Region, nrow=2, ncol=1) + #the plots are arranged in 1 column with 7 rows
  geom_text( #region labeles are again added
    check_overlap = T,
    data = Car.dat_text,
    mapping = aes(x = 157, y = 0.8, label = label),
    hjust="left",
    vjust="bottom",
    fontface="bold",
    family= "sans",
    size=3
  ) +
  geom_text( #MIS labels are added
    data = Car.mis_lab_sig,
    mapping = aes(x = x, y = (y/20)-1.6, label = label),
    hjust="middle",
    vjust="top",
    fontface = "bold",
    family="sans",
    size=1.5
  ) +
  coord_cartesian(ylim=c(-1, 0.9), xlim=c(150, 0), clip="off") #y axis limits (0,10) are defined and clip is turned off to allow labels to be placed outside of the plot

Car.fig.m<-ggarrange(Car18O, NULL, Car.sig.m, ncol=1, nrow=3, align = "v", heights = c(1, -0.15, 2.55))

ggsave("./plots/Carb_clim_mean_q0.pdf", Car.fig.m, width=3, height=4.55, units = "in", device="pdf")

Car.sig<-ggplot(Car.div, aes(KyrBP, q0))+
  geom_rect(aes(xmin=11.7, xmax=29, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS2
  geom_rect(aes(xmin=57, xmax=71, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS4
  geom_rect(aes(xmin=78, xmax=88, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS5b
  geom_rect(aes(xmin=106.5, xmax=116, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS5d
  geom_rect(aes(xmin=130, xmax=Inf, ymin=-Inf, ymax=Inf), fill="#D2D2D2") +
  geom_vline(aes(xintercept = yr), car.st.year, size=0.5, linetype = 1, col="#5a5a5a") +
  theme_linedraw() + 
  theme(
    strip.text.x = element_blank(),
    axis.title = element_text(size=7, family="sans"),
    axis.title.y = element_text(size=6, vjust=-1.5, hjust = 0.5), #give the y axis title a large right margin to make room to add text beneath it
    axis.text.y= element_text(size=4, family="sans"),
    axis.text.x = element_text(size=4, family="sans"),
    panel.grid = element_blank(), 
    panel.spacing = unit(-0.01, "lines"),
    panel.border = element_rect(colour = "black", fill=NA, size=0.25),
    plot.margin = margin(0,5,5,5, unit="pt")
    )+
  scale_x_reverse(n.breaks=15) +
  #here we plot the taxonomic q=0 for each site and color black
  geom_line(data=Car.div, 
            mapping=aes(group=site),col="#000000", na.rm=T, alpha=0.5, linewidth=0.25)+
  geom_line(data=Car.div, 
            mapping=aes(KyrBP, fq0, group=site),col="#e4851b", na.rm=T, alpha=0.5, 
            linewidth=0.25) +
  geom_smooth(mapping=aes(KyrBP,q0), method="gam", formula=y ~ s(x, bs="tp"), method.args = list(family = gaussian(link = "identity")), n=100, na.rm=T, col="#000000", 
             linewidth=0.5, level=0.95, alpha=0.63) +
  #plotting the taxonomic significant decreases by filtering out all of the NA values in the sig.t dec column
  geom_line(data=Car.sig.t[[1]]%>%filter(!is.na(.$dec)), mapping=aes(x, y, group=dec), col="#000000", 
            linewidth=1.5, alpha=0.7) + 
  #plotting the taxonomic significant increases by filtering out all of the NA values in the sig.t inc column
  geom_line(data=Car.sig.t[[1]]%>%filter(!is.na(.$inc)), mapping=aes(x, y, group=inc), col="#000000", 
            linewidth=1.5, alpha=0.7) +
  #smoothing all of the site functional q=0 values with a GAM and plotting in orange
  geom_smooth(mapping=aes(KyrBP,fq0), method="gam", formula=y ~ s(x, bs="tp"), method.args = list(family = gaussian(link = "identity")), n=100, na.rm=T, col="#e4851b", 
              linewidth=0.5, level=0.95, alpha=0.63) +
  #The same is done for the functional significant increases and decreases but they are plotted in orange 
  geom_line(data=Car.sig.f[[1]]%>%filter(!is.na(.$dec)), mapping=aes(x, y, group=dec), col="#e4851b", 
            linewidth=1.5, alpha=0.7) +
  geom_line(data=Car.sig.f[[1]]%>%filter(!is.na(.$inc)), mapping=aes(x, y, group=inc), col="#e4851b", 
            linewidth=1.5, alpha=0.7) +
  #vertical lines are added to indicate the start of the record for each region
  labs(y = "Plant Diversity (Effective Number of Species)", x = "Age (cal ka BP)")+
  facet_wrap(~Region, nrow=2, ncol=1) + #the plots are arranged in 1 column with 7 rows
  geom_text( #region labeles are again added
    check_overlap = T,
    data = Car.dat_text,
    mapping = aes(x = 157, y = 78, label = label),
    hjust="left",
    vjust="bottom",
    fontface="bold",
    family= "sans",
    size=3
  ) +
  geom_text( #MIS labels are added
    data = Car.mis_lab_sig,
    mapping = aes(x = x, y = (y*2)-23, label = label),
    hjust="middle",
    vjust="top",
    fontface = "bold",
    family="sans",
    size=1.5
  ) +
  coord_cartesian(ylim=c(1, 82), xlim=c(150, 0), clip="off") #y axis limits (0,10) are defined and clip is turned off to allow labels to be placed outside of the plot

Car.fig<-ggarrange(Car18O, NULL, Car.sig, ncol=1, nrow=3, align = "v", heights = c(1, -0.15, 2.55))

ggsave("./supplemental plots/Carb_clim_raw_q0.pdf", Car.fig, width=3, height=4.55, units = "in", device="pdf")

Car.sig.m.q1<-ggplot(Car.div, aes(KyrBP,(q1-q1.m)/q1.m))+
  geom_rect(aes(xmin=11.7, xmax=29, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS2
  geom_rect(aes(xmin=57, xmax=71, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS4
  geom_rect(aes(xmin=78, xmax=88, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS5b
  geom_rect(aes(xmin=106.5, xmax=116, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS5d
  geom_rect(aes(xmin=130, xmax=Inf, ymin=-Inf, ymax=Inf), fill="#D2D2D2") +
  geom_vline(aes(xintercept = yr), car.st.year, size=0.5, linetype = 1, col="#5a5a5a") +
  theme_linedraw() + 
  theme(
    strip.text.x = element_blank(),
    axis.title = element_text(size=7, family="sans"),
    axis.title.y = element_text(size=6, vjust=-1.5, hjust = 0.5), #give the y axis title a large right margin to make room to add text beneath it
    axis.text.y= element_text(size=4, family="sans"),
    axis.text.x = element_text(size=4, family="sans"),
    panel.grid = element_blank(), 
    panel.spacing = unit(-0.01, "lines"),
    panel.border = element_rect(colour = "black", fill=NA, size=0.25),
    plot.margin = margin(0,5,5,5, unit="pt")
    )+
  scale_x_reverse(n.breaks=15) +
  geom_hline(yintercept = 0, color="#5a5a5a", linetype=5, linewidth=0.25) +
  #here we plot the taxonomic q=0 for each site and color black
  geom_line(data=Car.div, 
            mapping=aes(group=site),col="#000000", na.rm=T, alpha=0.5, linewidth=0.25)+
  geom_line(data=Car.div, 
            mapping=aes(KyrBP,(fq1-fq1.m)/fq1.m, group=site),col="#e4851b", na.rm=T, alpha=0.5, 
            linewidth=0.25) +
  geom_smooth(mapping=aes(KyrBP,(q1-q1.m)/q1.m), method="gam", formula=y ~ s(x, bs="tp"), method.args = list(family = gaussian(link = "identity")), n=100, na.rm=T, col="#000000", 
             linewidth=0.5, level=0.95, alpha=0.63) +
  #plotting the taxonomic significant decreases by filtering out all of the NA values in the sig.t dec column
  geom_line(data=Car.sig.t.m[[2]]%>%filter(!is.na(.$dec)), mapping=aes(x, y, group=dec), col="#000000", 
            linewidth=1.5, alpha=0.7) + 
  #plotting the taxonomic significant increases by filtering out all of the NA values in the sig.t inc column
  geom_line(data=Car.sig.t.m[[2]]%>%filter(!is.na(.$inc)), mapping=aes(x, y, group=inc), col="#000000", 
            linewidth=1.5, alpha=0.7) +
  #smoothing all of the site functional q=0 values with a GAM and plotting in orange
  geom_smooth(mapping=aes(KyrBP,(fq1-fq1.m)/fq1.m), method="gam", formula=y ~ s(x, bs="tp"), method.args = list(family = gaussian(link = "identity")), n=100, na.rm=T, col="#e4851b", 
              linewidth=0.5, level=0.95, alpha=0.63) +
  #The same is done for the functional significant increases and decreases but they are plotted in orange 
  geom_line(data=Car.sig.f.m[[2]]%>%filter(!is.na(.$dec)), mapping=aes(x, y, group=dec), col="#e4851b", 
            linewidth=1.5, alpha=0.7) +
  geom_line(data=Car.sig.f.m[[2]]%>%filter(!is.na(.$inc)), mapping=aes(x, y, group=inc), col="#e4851b", 
            linewidth=1.5, alpha=0.7) +
  #vertical lines are added to indicate the start of the record for each region
  labs(y = "Normalized Diversity Relative to Mean", x = "Age (cal ka BP)")+
  facet_wrap(~Region, nrow=2, ncol=1) + #the plots are arranged in 1 column with 7 rows
  geom_text( #region labeles are again added
    check_overlap = T,
    data = Car.dat_text,
    mapping = aes(x = 157, y = 1.28, label = label),
    hjust="left",
    vjust="bottom",
    fontface="bold",
    family= "sans",
    size=3
  ) +
  geom_text( #MIS labels are added
    data = Car.mis_lab_sig,
    mapping = aes(x = x, y = (y/17)-1.5, label = label),
    hjust="middle",
    vjust="top",
    fontface = "bold",
    family="sans",
    size=1.5
  ) +
  coord_cartesian(ylim=c(-0.8, 1.4), xlim=c(150, 0), clip="off") #y axis limits (0,10) are defined and clip is turned off to allow labels to be placed outside of the plot

Car.fig.m.q1<-ggarrange(Car18O, NULL, Car.sig.m.q1, ncol=1, nrow=3, align = "v", heights = c(1, -0.15, 2.55))

ggsave("./plots/Carb_clim_mean_q1.pdf", Car.fig.m.q1, width=3, height=4.55, units = "in", device="pdf")

Car.sig.q1<-ggplot(Car.div, aes(KyrBP, q1))+
  geom_rect(aes(xmin=11.7, xmax=29, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS2
  geom_rect(aes(xmin=57, xmax=71, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS4
  geom_rect(aes(xmin=78, xmax=88, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS5b
  geom_rect(aes(xmin=106.5, xmax=116, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS5d
  geom_rect(aes(xmin=130, xmax=Inf, ymin=-Inf, ymax=Inf), fill="#D2D2D2") +
  geom_vline(aes(xintercept = yr), car.st.year, size=0.5, linetype = 1, col="#5a5a5a") +
  theme_linedraw() + 
  theme(
    strip.text.x = element_blank(),
    axis.title = element_text(size=7, family="sans"),
    axis.title.y = element_text(size=6, vjust=-1.5, hjust = 0.5), #give the y axis title a large right margin to make room to add text beneath it
    axis.text.y= element_text(size=4, family="sans"),
    axis.text.x = element_text(size=4, family="sans"),
    panel.grid = element_blank(), 
    panel.spacing = unit(-0.01, "lines"),
    panel.border = element_rect(colour = "black", fill=NA, size=0.25),
    plot.margin = margin(0,5,5,5, unit="pt")
    )+
  scale_x_reverse(n.breaks=15) +
  #here we plot the taxonomic q=0 for each site and color black
  geom_line(data=Car.div, 
            mapping=aes(group=site),col="#000000", na.rm=T, alpha=0.5, linewidth=0.25)+
  geom_line(data=Car.div, 
            mapping=aes(KyrBP, fq1, group=site),col="#e4851b", na.rm=T, alpha=0.5, 
            linewidth=0.25) +
  geom_smooth(mapping=aes(KyrBP,q1), method="gam", formula=y ~ s(x, bs="tp"), method.args = list(family = gaussian(link = "identity")), n=100, na.rm=T, col="#000000", 
             linewidth=0.5, level=0.95, alpha=0.63) +
  #plotting the taxonomic significant decreases by filtering out all of the NA values in the sig.t dec column
  geom_line(data=Car.sig.t[[2]]%>%filter(!is.na(.$dec)), mapping=aes(x, y, group=dec), col="#000000", 
            linewidth=1.5, alpha=0.7) + 
  #plotting the taxonomic significant increases by filtering out all of the NA values in the sig.t inc column
  geom_line(data=Car.sig.t[[2]]%>%filter(!is.na(.$inc)), mapping=aes(x, y, group=inc), col="#000000", 
            linewidth=1.5, alpha=0.7) +
  #smoothing all of the site functional q=0 values with a GAM and plotting in orange
  geom_smooth(mapping=aes(KyrBP,fq1), method="gam", formula=y ~ s(x, bs="tp"), method.args = list(family = gaussian(link = "identity")), n=100, na.rm=T, col="#e4851b", 
              linewidth=0.5, level=0.95, alpha=0.63) +
  #The same is done for the functional significant increases and decreases but they are plotted in orange 
  geom_line(data=Car.sig.f[[2]]%>%filter(!is.na(.$dec)), mapping=aes(x, y, group=dec), col="#e4851b", 
            linewidth=1.5, alpha=1) +
  geom_line(data=Car.sig.f[[2]]%>%filter(!is.na(.$inc)), mapping=aes(x, y, group=inc), col="#e4851b", 
            linewidth=1.5, alpha=1) +
  #vertical lines are added to indicate the start of the record for each region
  labs(y = "Plant Diversity (Effective Number of Species)", x = "Age (cal ka BP)")+
  facet_wrap(~Region, nrow=2, ncol=1) + #the plots are arranged in 1 column with 7 rows
  geom_text( #region labeles are again added
    check_overlap = T,
    data = Car.dat_text,
    mapping = aes(x = 157, y = 19, label = label),
    hjust="left",
    vjust="bottom",
    fontface="bold",
    family= "sans",
    size=3
  ) +
  geom_text( #MIS labels are added
    data = Car.mis_lab_sig,
    mapping = aes(x = x, y = (y/2)-5, label = label),
    hjust="middle",
    vjust="top",
    fontface = "bold",
    family="sans",
    size=1.5
  ) +
  coord_cartesian(ylim=c(1, 20), xlim=c(150, 0), clip="off") #y axis limits (0,10) are defined and clip is turned off to allow labels to be placed outside of the plot

Car.fig.q1<-ggarrange(Car18O, NULL, Car.sig.q1, ncol=1, nrow=3, align = "v", heights = c(1, -0.15, 2.55))

ggsave("./supplemental plots/Carb_clim_raw_q1.pdf", Car.fig.q1, width=3, height=4.55, units = "in", device="pdf")

#q2------------------------------------
Car.sig.m.q2<-ggplot(Car.div, aes(KyrBP,(q2-q2.m)/q2.m))+
  geom_rect(aes(xmin=11.7, xmax=29, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS2
  geom_rect(aes(xmin=57, xmax=71, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS4
  geom_rect(aes(xmin=78, xmax=88, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS5b
  geom_rect(aes(xmin=106.5, xmax=116, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS5d
  geom_rect(aes(xmin=130, xmax=Inf, ymin=-Inf, ymax=Inf), fill="#D2D2D2") +
  geom_vline(aes(xintercept = yr), car.st.year, size=0.5, linetype = 1, col="#5a5a5a") +
  theme_linedraw() + 
  theme(
    strip.text.x = element_blank(),
    axis.title = element_text(size=7, family="sans"),
    axis.title.y = element_text(size=6, vjust=-1.5, hjust = 0.5), #give the y axis title a large right margin to make room to add text beneath it
    axis.text.y= element_text(size=4, family="sans"),
    axis.text.x = element_text(size=4, family="sans"),
    panel.grid = element_blank(), 
    panel.spacing = unit(-0.01, "lines"),
    panel.border = element_rect(colour = "black", fill=NA, size=0.25),
    plot.margin = margin(0,5,5,5, unit="pt")
    )+
  scale_x_reverse(n.breaks=15) +
  scale_y_continuous(breaks=c(-0.5, 0, 0.5, 1, 1.5)) +
  geom_hline(yintercept = 0, color="#5a5a5a", linetype=5, linewidth=0.25) +
  #here we plot the taxonomic q=0 for each site and color black
  geom_line(data=Car.div, 
            mapping=aes(group=site),col="#000000", na.rm=T, alpha=0.5, linewidth=0.25)+
  geom_line(data=Car.div, 
            mapping=aes(KyrBP,(fq2-fq2.m)/fq2.m, group=site),col="#e4851b", na.rm=T, alpha=0.5, 
            linewidth=0.25) +
  geom_smooth(mapping=aes(KyrBP,(q2-q2.m)/q2.m), method="gam", formula=y ~ s(x, bs="tp"), method.args = list(family = gaussian(link = "identity")), n=100, na.rm=T, col="#000000", 
             linewidth=0.5, level=0.95, alpha=0.63) +
  #plotting the taxonomic significant decreases by filtering out all of the NA values in the sig.t dec column
  geom_line(data=Car.sig.t.m[[3]]%>%filter(!is.na(.$dec)), mapping=aes(x, y, group=dec), col="#000000", 
            linewidth=1.5, alpha=0.7) + 
  #plotting the taxonomic significant increases by filtering out all of the NA values in the sig.t inc column
  geom_line(data=Car.sig.t.m[[3]]%>%filter(!is.na(.$inc)), mapping=aes(x, y, group=inc), col="#000000", 
            linewidth=1.5, alpha=0.7) +
  #smoothing all of the site functional q=0 values with a GAM and plotting in orange
  geom_smooth(mapping=aes(KyrBP,(fq2-fq2.m)/fq2.m), method="gam", formula=y ~ s(x, bs="tp"), method.args = list(family = gaussian(link = "identity")), n=100, na.rm=T, col="#e4851b", 
              linewidth=0.5, level=0.95, alpha=0.63) +
  #The same is done for the functional significant increases and decreases but they are plotted in orange 
  geom_line(data=Car.sig.f.m[[3]]%>%filter(!is.na(.$dec)), mapping=aes(x, y, group=dec), col="#e4851b", 
            linewidth=1.5, alpha=0.7) +
  geom_line(data=Car.sig.f.m[[3]]%>%filter(!is.na(.$inc)), mapping=aes(x, y, group=inc), col="#e4851b", 
            linewidth=1.5, alpha=0.7) +
  #vertical lines are added to indicate the start of the record for each region
  labs(y = "Normalized Diversity Relative to Mean", x = "Age (cal ka BP)")+
  facet_wrap(~Region, nrow=2, ncol=1) + #the plots are arranged in 1 column with 7 rows
  geom_text( #region labeles are again added
    check_overlap = T,
    data = Car.dat_text,
    mapping = aes(x = 157, y = 1.48, label = label),
    hjust="left",
    vjust="bottom",
    fontface="bold",
    family= "sans",
    size=3
  ) +
  geom_text( #MIS labels are added
    data = Car.mis_lab_sig,
    mapping = aes(x = x, y = (y/17)-1.4, label = label),
    hjust="middle",
    vjust="top",
    fontface = "bold",
    family="sans",
    size=1.5
  ) +
  coord_cartesian(ylim=c(-0.7, 1.6), xlim=c(150, 0), clip="off") #y axis limits (0,10) are defined and clip is turned off to allow labels to be placed outside of the plot

Car.fig.m.q2<-ggarrange(Car18O, NULL, Car.sig.m.q2, ncol=1, nrow=3, align = "v", heights = c(1, -0.15, 2.55))

ggsave("./plots/Carb_clim_mean_q2.pdf", Car.fig.m.q2, width=3, height=4.55, units = "in", device="pdf")

Car.sig.q2<-ggplot(Car.div, aes(KyrBP, q2))+
  geom_rect(aes(xmin=11.7, xmax=29, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS2
  geom_rect(aes(xmin=57, xmax=71, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS4
  geom_rect(aes(xmin=78, xmax=88, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS5b
  geom_rect(aes(xmin=106.5, xmax=116, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS5d
  geom_rect(aes(xmin=130, xmax=Inf, ymin=-Inf, ymax=Inf), fill="#D2D2D2") +
  geom_vline(aes(xintercept = yr), car.st.year, size=0.5, linetype = 1, col="#5a5a5a") +
  theme_linedraw() + 
  theme(
    strip.text.x = element_blank(),
    axis.title = element_text(size=7, family="sans"),
    axis.title.y = element_text(size=6, vjust=-1.5, hjust = 0.5), #give the y axis title a large right margin to make room to add text beneath it
    axis.text.y= element_text(size=4, family="sans"),
    axis.text.x = element_text(size=4, family="sans"),
    panel.grid = element_blank(), 
    panel.spacing = unit(-0.01, "lines"),
    panel.border = element_rect(colour = "black", fill=NA, size=0.25),
    plot.margin = margin(0,5,5,5, unit="pt")
    )+
  scale_x_reverse(n.breaks=15) +
  #here we plot the taxonomic q=0 for each site and color black
  geom_line(data=Car.div, 
            mapping=aes(group=site),col="#000000", na.rm=T, alpha=0.5, linewidth=0.25)+
  geom_line(data=Car.div, 
            mapping=aes(KyrBP, fq2, group=site),col="#e4851b", na.rm=T, alpha=0.5, 
            linewidth=0.25) +
  geom_smooth(mapping=aes(KyrBP,q2), method="gam", formula=y ~ s(x, bs="tp"), method.args = list(family = gaussian(link = "identity")), n=100, na.rm=T, col="#000000", 
             linewidth=0.5, level=0.95, alpha=0.63) +
  #plotting the taxonomic significant decreases by filtering out all of the NA values in the sig.t dec column
  geom_line(data=Car.sig.t[[3]]%>%filter(!is.na(.$dec)), mapping=aes(x, y, group=dec), col="#000000", 
            linewidth=1.5, alpha=0.7) + 
  #plotting the taxonomic significant increases by filtering out all of the NA values in the sig.t inc column
  geom_line(data=Car.sig.t[[3]]%>%filter(!is.na(.$inc)), mapping=aes(x, y, group=inc), col="#000000", 
            linewidth=1.5, alpha=0.7) +
  #smoothing all of the site functional q=0 values with a GAM and plotting in orange
  geom_smooth(mapping=aes(KyrBP,fq2), method="gam", formula=y ~ s(x, bs="tp"), method.args = list(family = gaussian(link = "identity")), n=100, na.rm=T, col="#e4851b", 
              linewidth=0.5, level=0.95, alpha=0.63) +
  #The same is done for the functional significant increases and decreases but they are plotted in orange 
  geom_line(data=Car.sig.f[[3]]%>%filter(!is.na(.$dec)), mapping=aes(x, y, group=dec), col="#e4851b", 
            linewidth=1.5, alpha=0.7) +
  geom_line(data=Car.sig.f[[3]]%>%filter(!is.na(.$inc)), mapping=aes(x, y, group=inc), col="#e4851b", 
            linewidth=1.5, alpha=0.7) +
  #vertical lines are added to indicate the start of the record for each region
  labs(y = "Plant Diversity (Effective Number of Species)", x = "Age (cal ka BP)")+
  facet_wrap(~Region, nrow=2, ncol=1) + #the plots are arranged in 1 column with 7 rows
  geom_text( #region labeles are again added
    check_overlap = T,
    data = Car.dat_text,
    mapping = aes(x = 157, y = 12.4, label = label),
    hjust="left",
    vjust="bottom",
    fontface="bold",
    family= "sans",
    size=3
  ) +
  geom_text( #MIS labels are added
    data = Car.mis_lab_sig,
    mapping = aes(x = x, y = (y/3)-3, label = label),
    hjust="middle",
    vjust="top",
    fontface = "bold",
    family="sans",
    size=1.5
  ) +
  coord_cartesian(ylim=c(1, 13), xlim=c(150, 0), clip="off") #y axis limits (0,10) are defined and clip is turned off to allow labels to be placed outside of the plot

Car.fig.q2<-ggarrange(Car18O, NULL, Car.sig.q2, ncol=1, nrow=3, align = "v", heights = c(1, -0.15, 2.55))

ggsave("./supplemental plots/Carb_clim_raw_q2.pdf", Car.fig.q2, width=3, height=4.55, units = "in", device="pdf")
```

```{r}
Pac18O<-ggplot(Paci, aes(KyrBP, d18Oforams.b))+ #data is set to GRIP and the x values are KyrBP and y values are del18O
 #adding the same shaded rectangles to show the different MIS
  geom_rect(aes(xmin=11.7, xmax=29, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS2
  geom_rect(aes(xmin=57, xmax=71, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS4
  geom_rect(aes(xmin=78, xmax=88, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS5b
  geom_rect(aes(xmin=106.5, xmax=116, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS5d
  geom_rect(aes(xmin=130, xmax=Inf, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS6
  geom_point(alpha=0.5, size=0.4, shape=18) +
  #smooth the oxygen isotope data with a spline
  geom_spline(col="#000000", linewidth=0.4, na.rm=T, spar=0.25, alpha=0.8)+
  geom_point(data=Ice_CO2, 
             mapping=aes(KyrBP,-(((CO2_ppmv-min(CO2_ppmv, na.rm=T))*(max(Paci$d18Oforams.b, na.rm=T)-min(Paci$d18Oforams.b, na.rm=T)))/(max(CO2_ppmv, na.rm=T)-min(CO2_ppmv, na.rm=T))+min(Paci$d18Oforams.b, na.rm=T))+(min(Paci$d18Oforams.b, na.rm=T)+max(Paci$d18Oforams.b, na.rm=T))), 
             alpha=0.5, size=0.2, shape=17, col="#1b7ae4") +
  #smooth the oxygen isotope data with a spline
  geom_spline(data=Ice_CO2, 
              mapping=aes(KyrBP, -(((CO2_ppmv-min(CO2_ppmv, na.rm=T))*(max(Paci$d18Oforams.b, na.rm=T)-min(Paci$d18Oforams.b, na.rm=T)))/(max(CO2_ppmv, na.rm=T)-min(CO2_ppmv, na.rm=T))+min(Paci$d18Oforams.b, na.rm=T))+(min(Paci$d18Oforams.b, na.rm=T)+max(Paci$d18Oforams.b, na.rm=T))), 
              col="#1b7ae4", linewidth=0.4, na.rm=T, spar=0.25, alpha = 0.8)+
  scale_y_reverse(limits = c(
    max(Paci$d18Oforams.b, na.rm=T), 
    min(Paci$d18Oforams.b, na.rm=T)),
    sec.axis=sec_axis(~-(((.-min(Paci$d18Oforams.b, na.rm=T))*(max(Ice_CO2$CO2_ppmv, na.rm=T)-min(Ice_CO2$CO2_ppmv, na.rm=T)))/(max(Paci$d18Oforams.b, na.rm=T)-min(Paci$d18Oforams.b, na.rm=T))+min(Ice_CO2$CO2_ppmv, na.rm=T))+(min(Ice_CO2$CO2_ppmv, na.rm=T)+max(Ice_CO2$CO2_ppmv, na.rm=T)), name=expression(CO[2]~(ppmv)))) +  
  theme_linedraw() + 
  theme(
    strip.text.x = element_blank(),
    axis.title = element_text(size=7, family = "sans"),
    axis.title.y = element_text(vjust=-1.5, hjust = 0.5), #give the y axis title a large right margin to make room to add text beneath it
    axis.text.x = element_blank(),
    axis.ticks.x=element_blank(),
    axis.text.y= element_text(size=4, family="sans"),
    axis.title.y.right = element_text(hjust =0.5, color = "#1B7AE4"),
    axis.text.y.right = element_text(color = "#1B7AE4"),
    panel.grid = element_blank(), 
    panel.spacing = unit(-0.01, "lines"),
    panel.border = element_rect(colour = "#000000", fill=NA, linewidth=0.25),
    legend.position = "none",
    plot.margin = margin(5,5,0,5, unit="pt") #change the plot margins so there is no bottom margin, allowing the plot to be stacked atop p.sig
    ) +
  labs(x = "", y = expression(delta^18*O~("\u2030"))) + #create the axis labels
  # create an arrow that is plotted outside of the plot but along the y axis
  geom_segment(aes(x = 151, xend = 151, 
                   y = min(d18Oforams.b, na.rm=T), 
                   yend = max(d18Oforams.b, na.rm=T)), 
               size=0.25, 
               arrow = arrow(length = unit(4,"pt"), ends = "both", type = "closed")) +
  #add a label of cooler and warmer to be added to the ends of the arrow and rotate 90 degrees to be in line with the y axis title
  annotate("text", x= 154, y= max(Paci$d18Oforams.b, na.rm=T)-0.36, label="cooler", angle = 90, size = 1.5, family = "sans")+
  annotate("text", x= 154, y= min(Paci$d18Oforams.b, na.rm=T)+0.36, label="warmer", angle = 90, size = 1.5, family = "sans")+
  annotate("text", x=10, y=3.15, label="B", size=7, family="sans", fontface="bold")+
  coord_cartesian(xlim = c(150, 0), clip = "off") #define the x axis limits and allow data to be plotted beyond the x axis range

Pac.div<-tot.sm %>%
  filter(.$Region==2 | .$Region == 4 | .$Region==5)

Pac.sig.t.m <- list()
Pac.sig.f.m <- list()
Pac.sig.t <- list()
Pac.sig.f <- list()

for (i in 1:3){
  Pac.sig.t.m[[i]]<- sig.t.m[[i]] %>%
    filter(.$Region == 2 | .$Region == 4 | .$Region == 5)
  Pac.sig.f.m[[i]]<- sig.f.m[[i]] %>%
    filter(.$Region == 2 | .$Region == 4 | .$Region == 5)
  Pac.sig.t[[i]]<- sig.t[[i]] %>%
    filter(.$Region == 2 | .$Region == 4 | .$Region == 5)
  Pac.sig.f[[i]]<- sig.f[[i]] %>%
    filter(.$Region == 2 | .$Region == 4 | .$Region == 5)
}


Pac.mis_lab_sig <- mis_lab_sig %>%
  mutate(Region = 5)

Pac.dat_text <- dat_text %>%
  filter(.$Region==2 | .$Region == 4 | .$Region==5)

Pac.st.year <- st.year %>%
  filter(.$Region==2 | .$Region == 4 | .$Region==5)

Pac.sig.m<-ggplot(Pac.div, aes(KyrBP,(q0-q0.m)/q0.m))+
  geom_rect(aes(xmin=11.7, xmax=29, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS2
  geom_rect(aes(xmin=57, xmax=71, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS4
  geom_rect(aes(xmin=78, xmax=88, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS5b
  geom_rect(aes(xmin=106.5, xmax=116, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS5d
  geom_rect(aes(xmin=130, xmax=Inf, ymin=-Inf, ymax=Inf), fill="#D2D2D2") +
  geom_vline(aes(xintercept = yr), Pac.st.year, size=0.5, linetype = 1, col="#5a5a5a") +
  theme_linedraw() + 
  theme(
    strip.text.x = element_blank(),
    axis.title = element_text(size=7, family="sans"),
    axis.title.y = element_text(size=6, vjust=-1.5, hjust = 0.5), #give the y axis title a large right margin to make room to add text beneath it
    axis.text.y= element_text(size=4, family="sans"),
    axis.text.x = element_text(size=4, family="sans"),
    panel.grid = element_blank(), 
    panel.spacing = unit(-0.01, "lines"),
    panel.border = element_rect(colour = "black", fill=NA, size=0.25),
    plot.margin = margin(0,5,5,5, unit="pt")
    )+
  scale_x_reverse(n.breaks=15) +
  geom_hline(yintercept = 0, color="#5a5a5a", linetype=5, linewidth=0.25) +
  #here we plot the taxonomic q=0 for each site and color black
  geom_line(data=Pac.div, 
            mapping=aes(group=site),col="#000000", na.rm=T, alpha=0.5, linewidth=0.25)+
  geom_line(data=Pac.div, 
            mapping=aes(KyrBP,(fq0-fq0.m)/fq0.m, group=site),col="#e4851b", na.rm=T, alpha=0.5, 
            linewidth=0.25) +
  geom_smooth(mapping=aes(KyrBP,(q0-q0.m)/q0.m), method="gam", formula=y ~ s(x, bs="tp"), method.args = list(family = gaussian(link = "identity")), n=100, na.rm=T, col="#000000", 
             linewidth=0.5, level=0.95, alpha=0.63) +
  #plotting the taxonomic significant decreases by filtering out all of the NA values in the sig.t dec column
  geom_line(data=Pac.sig.t.m[[1]]%>%filter(!is.na(.$dec)), mapping=aes(x, y, group=dec), col="#000000", 
            linewidth=1.5, alpha=0.7) + 
  #plotting the taxonomic significant increases by filtering out all of the NA values in the sig.t inc column
  geom_line(data=Pac.sig.t.m[[1]]%>%filter(!is.na(.$inc)), mapping=aes(x, y, group=inc), col="#000000", 
            linewidth=1.5, alpha=0.7) +
  #smoothing all of the site functional q=0 values with a GAM and plotting in orange
  geom_smooth(mapping=aes(KyrBP,(fq0-fq0.m)/fq0.m), method="gam", formula=y ~ s(x, bs="tp"), method.args = list(family = gaussian(link = "identity")), n=100, na.rm=T, col="#e4851b", 
              linewidth=0.5, level=0.95, alpha=0.63) +
  #The same is done for the functional significant increases and decreases but they are plotted in orange 
  geom_line(data=Pac.sig.f.m[[1]]%>%filter(!is.na(.$dec)), mapping=aes(x, y, group=dec), col="#e4851b", 
            linewidth=1.5, alpha=0.7) +
  geom_line(data=Pac.sig.f.m[[1]]%>%filter(!is.na(.$inc)), mapping=aes(x, y, group=inc), col="#e4851b", 
            linewidth=1.5, alpha=0.7) +
  #vertical lines are added to indicate the start of the record for each region
  labs(y = "Normalized Diversity Relative to Mean", x = "Age (cal ka BP)")+
  facet_wrap(~Region, nrow=3, ncol=1) + #the plots are arranged in 1 column with 7 rows
  geom_text( #region labeles are again added
    check_overlap = T,
    data = Pac.dat_text,
    mapping = aes(x = 157, y = 0.8, label = label),
    hjust="left",
    vjust="bottom",
    fontface="bold",
    family= "sans",
    size=3
  ) +
  geom_text( #MIS labels are added
    data = Pac.mis_lab_sig,
    mapping = aes(x = x, y = (y/20)-1.6, label = label),
    hjust="middle",
    vjust="top",
    fontface = "bold",
    family="sans",
    size=1.5
  ) +
  coord_cartesian(ylim=c(-1, 0.9), xlim=c(150, 0), clip="off") #y axis limits (0,10) are defined and clip is turned off to allow labels to be placed outside of the plot

Pac.fig.m<-ggarrange(Pac18O, NULL, Pac.sig.m, ncol=1, nrow=3, align = "v", heights = c(1, -0.15, 3.7))

ggsave("./plots/Paci_clim_mean_q0.pdf", Pac.fig.m, width=3, height=6.1, units = "in", device="pdf")

Pac.sig<-ggplot(Pac.div, aes(KyrBP,q0))+
  geom_rect(aes(xmin=11.7, xmax=29, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS2
  geom_rect(aes(xmin=57, xmax=71, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS4
  geom_rect(aes(xmin=78, xmax=88, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS5b
  geom_rect(aes(xmin=106.5, xmax=116, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS5d
  geom_rect(aes(xmin=130, xmax=Inf, ymin=-Inf, ymax=Inf), fill="#D2D2D2") +
  geom_vline(aes(xintercept = yr), Pac.st.year, size=0.5, linetype = 1, col="#5a5a5a") +
  theme_linedraw() + 
  theme(
    strip.text.x = element_blank(),
    axis.title = element_text(size=7, family="sans"),
    axis.title.y = element_text(size=6, vjust=-1.5, hjust = 0.5), #give the y axis title a large right margin to make room to add text beneath it
    axis.text.y= element_text(size=4, family="sans"),
    axis.text.x = element_text(size=4, family="sans"),
    panel.grid = element_blank(), 
    panel.spacing = unit(-0.01, "lines"),
    panel.border = element_rect(colour = "black", fill=NA, size=0.25),
    plot.margin = margin(0,5,5,5, unit="pt")
    )+
  scale_x_reverse(n.breaks=15) +
  #here we plot the taxonomic q=0 for each site and color black
  geom_line(data=Pac.div, 
            mapping=aes(group=site),col="#000000", na.rm=T, alpha=0.5, linewidth=0.25)+
  geom_line(data=Pac.div, 
            mapping=aes(KyrBP,fq0, group=site),col="#e4851b", na.rm=T, alpha=0.5, 
            linewidth=0.25) +
  geom_smooth(mapping=aes(KyrBP,q0), method="gam", formula=y ~ s(x, bs="tp"), method.args = list(family = gaussian(link = "identity")), n=100, na.rm=T, col="#000000", 
             linewidth=0.5, level=0.95, alpha=0.63) +
  #plotting the taxonomic significant decreases by filtering out all of the NA values in the sig.t dec column
  geom_line(data=Pac.sig.t[[1]]%>%filter(!is.na(.$dec)), mapping=aes(x, y, group=dec), col="#000000", 
            linewidth=1.5, alpha=0.7) + 
  #plotting the taxonomic significant increases by filtering out all of the NA values in the sig.t inc column
  geom_line(data=Pac.sig.t[[1]]%>%filter(!is.na(.$inc)), mapping=aes(x, y, group=inc), col="#000000", 
            linewidth=1.5, alpha=0.7) +
  #smoothing all of the site functional q=0 values with a GAM and plotting in orange
  geom_smooth(mapping=aes(KyrBP,fq0), method="gam", formula=y ~ s(x, bs="tp"), method.args = list(family = gaussian(link = "identity")), n=100, na.rm=T, col="#e4851b", 
              linewidth=0.5, level=0.95, alpha=0.63) +
  #The same is done for the functional significant increases and decreases but they are plotted in orange 
  geom_line(data=Pac.sig.f[[1]]%>%filter(!is.na(.$dec)), mapping=aes(x, y, group=dec), col="#e4851b", 
            linewidth=1.5, alpha=0.7) +
  geom_line(data=Pac.sig.f[[1]]%>%filter(!is.na(.$inc)), mapping=aes(x, y, group=inc), col="#e4851b", 
            linewidth=1.5, alpha=0.7) +
  #vertical lines are added to indicate the start of the record for each region
  labs(y = "Plant Diversity (Effective Number of Species)", x = "Age (cal ka BP)")+
  facet_wrap(~Region, nrow=3, ncol=1) + #the plots are arranged in 1 column with 7 rows
  geom_text( #region labeles are again added
    check_overlap = T,
    data = Pac.dat_text,
    mapping = aes(x = 157, y = 78, label = label),
    hjust="left",
    vjust="bottom",
    fontface="bold",
    family= "sans",
    size=3
  ) +
  geom_text( #MIS labels are added
    data = Pac.mis_lab_sig,
    mapping = aes(x = x, y = (y*2)-23, label = label),
    hjust="middle",
    vjust="top",
    fontface = "bold",
    family="sans",
    size=1.5
  ) +
  coord_cartesian(ylim=c(1, 82), xlim=c(150, 0), clip="off") #y axis limits (0,10) are defined and clip is turned off to allow labels to be placed outside of the plot

Pac.fig<-ggarrange(Pac18O, NULL, Pac.sig, ncol=1, nrow=3, align = "v", heights = c(1, -0.15, 3.7))

ggsave("./supplemental plots/Paci_clim_raw_q0.pdf", Pac.fig, width=3, height=6.1, units = "in", device="pdf")

Pac.sig.m.q1<-ggplot(Pac.div, aes(KyrBP,(q1-q1.m)/q1.m))+
  geom_rect(aes(xmin=11.7, xmax=29, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS2
  geom_rect(aes(xmin=57, xmax=71, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS4
  geom_rect(aes(xmin=78, xmax=88, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS5b
  geom_rect(aes(xmin=106.5, xmax=116, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS5d
  geom_rect(aes(xmin=130, xmax=Inf, ymin=-Inf, ymax=Inf), fill="#D2D2D2") +
  geom_vline(aes(xintercept = yr), Pac.st.year, size=0.5, linetype = 1, col="#5a5a5a") +
  theme_linedraw() + 
  theme(
    strip.text.x = element_blank(),
    axis.title = element_text(size=7, family="sans"),
    axis.title.y = element_text(size=6, vjust=-1.5, hjust = 0.5), #give the y axis title a large right margin to make room to add text beneath it
    axis.text.y= element_text(size=4, family="sans"),
    axis.text.x = element_text(size=4, family="sans"),
    panel.grid = element_blank(), 
    panel.spacing = unit(-0.01, "lines"),
    panel.border = element_rect(colour = "black", fill=NA, size=0.25),
    plot.margin = margin(0,5,5,5, unit="pt")
    )+
  scale_x_reverse(n.breaks=15) +
  geom_hline(yintercept = 0, color="#5a5a5a", linetype=5, linewidth=0.25) +
  #here we plot the taxonomic q=0 for each site and color black
  geom_line(data=Pac.div, 
            mapping=aes(group=site),col="#000000", na.rm=T, alpha=0.5, linewidth=0.25)+
  geom_line(data=Pac.div, 
            mapping=aes(KyrBP,(fq1-fq1.m)/fq1.m, group=site),col="#e4851b", na.rm=T, alpha=0.5, 
            linewidth=0.25) +
  geom_smooth(mapping=aes(KyrBP,(q1-q1.m)/q1.m), method="gam", formula=y ~ s(x, bs="tp"), method.args = list(family = gaussian(link = "identity")), n=100, na.rm=T, col="#000000", 
             linewidth=0.5, level=0.95, alpha=0.63) +
  #plotting the taxonomic significant decreases by filtering out all of the NA values in the sig.t dec column
  geom_line(data=Pac.sig.t.m[[2]]%>%filter(!is.na(.$dec)), mapping=aes(x, y, group=dec), col="#000000", 
            linewidth=1.5, alpha=0.7) + 
  #plotting the taxonomic significant increases by filtering out all of the NA values in the sig.t inc column
  geom_line(data=Pac.sig.t.m[[2]]%>%filter(!is.na(.$inc)), mapping=aes(x, y, group=inc), col="#000000", 
            linewidth=1.5, alpha=0.7) +
  #smoothing all of the site functional q=0 values with a GAM and plotting in orange
  geom_smooth(mapping=aes(KyrBP,(fq1-fq1.m)/fq1.m), method="gam", formula=y ~ s(x, bs="tp"), method.args = list(family = gaussian(link = "identity")), n=100, na.rm=T, col="#e4851b", 
              linewidth=0.5, level=0.95, alpha=0.63) +
  #The same is done for the functional significant increases and decreases but they are plotted in orange 
  geom_line(data=Pac.sig.f.m[[2]]%>%filter(!is.na(.$dec)), mapping=aes(x, y, group=dec), col="#e4851b", 
            linewidth=1.5, alpha=0.7) +
  geom_line(data=Pac.sig.f.m[[2]]%>%filter(!is.na(.$inc)), mapping=aes(x, y, group=inc), col="#e4851b", 
            linewidth=1.5, alpha=0.7) +
  #vertical lines are added to indicate the start of the record for each region
  labs(y = "Normalized Diversity Relative to Mean", x = "Age (cal ka BP)")+
  facet_wrap(~Region, nrow=3, ncol=1) + #the plots are arranged in 1 column with 7 rows
  geom_text( #region labeles are again added
    check_overlap = T,
    data = Pac.dat_text,
    mapping = aes(x = 157, y = 1.28, label = label),
    hjust="left",
    vjust="bottom",
    fontface="bold",
    family= "sans",
    size=3
  ) +
  geom_text( #MIS labels are added
    data = Pac.mis_lab_sig,
    mapping = aes(x = x, y = (y/17)-1.5, label = label),
    hjust="middle",
    vjust="top",
    fontface = "bold",
    family="sans",
    size=1.5
  ) +
  coord_cartesian(ylim=c(-0.8, 1.4), xlim=c(150, 0), clip="off") #y axis limits (0,10) are defined and clip is turned off to allow labels to be placed outside of the plot

Pac.fig.m.q1<-ggarrange(Pac18O, NULL, Pac.sig.m.q1, ncol=1, nrow=3, align = "v", heights = c(1, -0.15, 3.7))

ggsave("./plots/Paci_clim_mean_q1.pdf", Pac.fig.m.q1, width=3, height=6.1, units = "in", device="pdf")

Pac.sig.q1<-ggplot(Pac.div, aes(KyrBP,q1))+
  geom_rect(aes(xmin=11.7, xmax=29, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS2
  geom_rect(aes(xmin=57, xmax=71, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS4
  geom_rect(aes(xmin=78, xmax=88, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS5b
  geom_rect(aes(xmin=106.5, xmax=116, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS5d
  geom_rect(aes(xmin=130, xmax=Inf, ymin=-Inf, ymax=Inf), fill="#D2D2D2") +
  geom_vline(aes(xintercept = yr), Pac.st.year, size=0.5, linetype = 1, col="#5a5a5a") +
  theme_linedraw() + 
  theme(
    strip.text.x = element_blank(),
    axis.title = element_text(size=7, family="sans"),
    axis.title.y = element_text(size=6, vjust=-1.5, hjust = 0.5), #give the y axis title a large right margin to make room to add text beneath it
    axis.text.y= element_text(size=4, family="sans"),
    axis.text.x = element_text(size=4, family="sans"),
    panel.grid = element_blank(), 
    panel.spacing = unit(-0.01, "lines"),
    panel.border = element_rect(colour = "black", fill=NA, size=0.25),
    plot.margin = margin(0,5,5,5, unit="pt")
    )+
  scale_x_reverse(n.breaks=15) +
  #here we plot the taxonomic q=0 for each site and color black
  geom_line(data=Pac.div, 
            mapping=aes(group=site),col="#000000", na.rm=T, alpha=0.5, linewidth=0.25)+
  geom_line(data=Pac.div, 
            mapping=aes(KyrBP,fq1, group=site),col="#e4851b", na.rm=T, alpha=0.5, 
            linewidth=0.25) +
  geom_smooth(mapping=aes(KyrBP,q1), method="gam", formula=y ~ s(x, bs="tp"), method.args = list(family = gaussian(link = "identity")), n=100, na.rm=T, col="#000000", 
             linewidth=0.5, level=0.95, alpha=0.63) +
  #plotting the taxonomic significant decreases by filtering out all of the NA values in the sig.t dec column
  geom_line(data=Pac.sig.t[[2]]%>%filter(!is.na(.$dec)), mapping=aes(x, y, group=dec), col="#000000", 
            linewidth=1.5, alpha=0.7) + 
  #plotting the taxonomic significant increases by filtering out all of the NA values in the sig.t inc column
  geom_line(data=Pac.sig.t[[2]]%>%filter(!is.na(.$inc)), mapping=aes(x, y, group=inc), col="#000000", 
            linewidth=1.5, alpha=0.7) +
  #smoothing all of the site functional q=0 values with a GAM and plotting in orange
  geom_smooth(mapping=aes(KyrBP,fq1), method="gam", formula=y ~ s(x, bs="tp"), method.args = list(family = gaussian(link = "identity")), n=100, na.rm=T, col="#e4851b", 
              linewidth=0.5, level=0.95, alpha=0.63) +
  #The same is done for the functional significant increases and decreases but they are plotted in orange 
  geom_line(data=Pac.sig.f[[2]]%>%filter(!is.na(.$dec)), mapping=aes(x, y, group=dec), col="#e4851b", 
            linewidth=1.5, alpha=0.7) +
  geom_line(data=Pac.sig.f[[2]]%>%filter(!is.na(.$inc)), mapping=aes(x, y, group=inc), col="#e4851b", 
            linewidth=1.5, alpha=0.7) +
  #vertical lines are added to indicate the start of the record for each region
  labs(y = "Plant Diversity (Effective Number of Species)", x = "Age (cal ka BP)")+
  facet_wrap(~Region, nrow=3, ncol=1) + #the plots are arranged in 1 column with 7 rows
  geom_text( #region labeles are again added
    check_overlap = T,
    data = Pac.dat_text,
    mapping = aes(x = 157, y = 19, label = label),
    hjust="left",
    vjust="bottom",
    fontface="bold",
    family= "sans",
    size=3
  ) +
  geom_text( #MIS labels are added
    data = Pac.mis_lab_sig,
    mapping = aes(x = x, y = (y/2)-5, label = label),
    hjust="middle",
    vjust="top",
    fontface = "bold",
    family="sans",
    size=1.5
  ) +
  coord_cartesian(ylim=c(1, 20), xlim=c(150, 0), clip="off") #y axis limits (0,10) are defined and clip is turned off to allow labels to be placed outside of the plot

Pac.fig.q1<-ggarrange(Pac18O, NULL, Pac.sig.q1, ncol=1, nrow=3, align = "v", heights = c(1, -0.15, 3.7))

ggsave("./supplemental plots/Paci_clim_raw_q1.pdf", Pac.fig.q1, width=3, height=6.1, units = "in", device="pdf")

#q2----------------------
Pac.sig.m.q2<-ggplot(Pac.div, aes(KyrBP,(q2-q2.m)/q2.m))+
  geom_rect(aes(xmin=11.7, xmax=29, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS2
  geom_rect(aes(xmin=57, xmax=71, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS4
  geom_rect(aes(xmin=78, xmax=88, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS5b
  geom_rect(aes(xmin=106.5, xmax=116, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS5d
  geom_rect(aes(xmin=130, xmax=Inf, ymin=-Inf, ymax=Inf), fill="#D2D2D2") +
  geom_vline(aes(xintercept = yr), Pac.st.year, size=0.5, linetype = 1, col="#5a5a5a") +
  theme_linedraw() + 
  theme(
    strip.text.x = element_blank(),
    axis.title = element_text(size=7, family="sans"),
    axis.title.y = element_text(size=6, vjust=-1.5, hjust = 0.5), #give the y axis title a large right margin to make room to add text beneath it
    axis.text.y= element_text(size=4, family="sans"),
    axis.text.x = element_text(size=4, family="sans"),
    panel.grid = element_blank(), 
    panel.spacing = unit(-0.01, "lines"),
    panel.border = element_rect(colour = "black", fill=NA, size=0.25),
    plot.margin = margin(0,5,5,5, unit="pt")
    )+
  scale_x_reverse(n.breaks=15) +
  scale_y_continuous(breaks=c(-0.5, 0, 0.5, 1, 1.5)) +
  geom_hline(yintercept = 0, color="#5a5a5a", linetype=5, linewidth=0.25) +
  #here we plot the taxonomic q=0 for each site and color black
  geom_line(data=Pac.div, 
            mapping=aes(group=site),col="#000000", na.rm=T, alpha=0.5, linewidth=0.25)+
  geom_line(data=Pac.div, 
            mapping=aes(KyrBP,(fq2-fq2.m)/fq2.m, group=site),col="#e4851b", na.rm=T, alpha=0.5, 
            linewidth=0.25) +
  geom_smooth(mapping=aes(KyrBP,(q2-q2.m)/q2.m), method="gam", formula=y ~ s(x, bs="tp"), method.args = list(family = gaussian(link = "identity")), n=100, na.rm=T, col="#000000", 
             linewidth=0.5, level=0.95, alpha=0.63) +
  #plotting the taxonomic significant decreases by filtering out all of the NA values in the sig.t dec column
  geom_line(data=Pac.sig.t.m[[3]]%>%filter(!is.na(.$dec)), mapping=aes(x, y, group=dec), col="#000000", 
            linewidth=1.5, alpha=0.7) + 
  #plotting the taxonomic significant increases by filtering out all of the NA values in the sig.t inc column
  geom_line(data=Pac.sig.t.m[[3]]%>%filter(!is.na(.$inc)), mapping=aes(x, y, group=inc), col="#000000", 
            linewidth=1.5, alpha=0.7) +
  #smoothing all of the site functional q=0 values with a GAM and plotting in orange
  geom_smooth(mapping=aes(KyrBP,(fq2-fq2.m)/fq2.m), method="gam", formula=y ~ s(x, bs="tp"), method.args = list(family = gaussian(link = "identity")), n=100, na.rm=T, col="#e4851b", 
              linewidth=0.5, level=0.95, alpha=0.63) +
  #The same is done for the functional significant increases and decreases but they are plotted in orange 
  geom_line(data=Pac.sig.f.m[[3]]%>%filter(!is.na(.$dec)), mapping=aes(x, y, group=dec), col="#e4851b", 
            linewidth=1.5, alpha=0.7) +
  geom_line(data=Pac.sig.f.m[[3]]%>%filter(!is.na(.$inc)), mapping=aes(x, y, group=inc), col="#e4851b", 
            linewidth=1.5, alpha=0.7) +
  #vertical lines are added to indicate the start of the record for each region
  labs(y = "Normalized Diversity Relative to Mean", x = "Age (cal ka BP)")+
  facet_wrap(~Region, nrow=3, ncol=1) + #the plots are arranged in 1 column with 7 rows
  geom_text( #region labeles are again added
    check_overlap = T,
    data = Pac.dat_text,
    mapping = aes(x = 157, y = 1.48, label = label),
    hjust="left",
    vjust="bottom",
    fontface="bold",
    family= "sans",
    size=3
  ) +
  geom_text( #MIS labels are added
    data = Pac.mis_lab_sig,
    mapping = aes(x = x, y = (y/17)-1.4, label = label),
    hjust="middle",
    vjust="top",
    fontface = "bold",
    family="sans",
    size=1.5
  ) +
  coord_cartesian(ylim=c(-0.7, 1.6), xlim=c(150, 0), clip="off") #y axis limits (0,10) are defined and clip is turned off to allow labels to be placed outside of the plot

Pac.fig.m.q2<-ggarrange(Pac18O, NULL, Pac.sig.m.q2, ncol=1, nrow=3, align = "v", heights = c(1, -0.15, 3.7))

ggsave("./plots/Paci_clim_mean_q2.pdf", Pac.fig.m.q2, width=3, height=6.1, units = "in", device="pdf")

Pac.sig.q2<-ggplot(Pac.div, aes(KyrBP,q2))+
  geom_rect(aes(xmin=11.7, xmax=29, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS2
  geom_rect(aes(xmin=57, xmax=71, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS4
  geom_rect(aes(xmin=78, xmax=88, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS5b
  geom_rect(aes(xmin=106.5, xmax=116, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS5d
  geom_rect(aes(xmin=130, xmax=Inf, ymin=-Inf, ymax=Inf), fill="#D2D2D2") +
  geom_vline(aes(xintercept = yr), Pac.st.year, size=0.5, linetype = 1, col="#5a5a5a") +
  theme_linedraw() + 
  theme(
    strip.text.x = element_blank(),
    axis.title = element_text(size=7, family="sans"),
    axis.title.y = element_text(size=6, vjust=-1.5, hjust = 0.5), #give the y axis title a large right margin to make room to add text beneath it
    axis.text.y= element_text(size=4, family="sans"),
    axis.text.x = element_text(size=4, family="sans"),
    panel.grid = element_blank(), 
    panel.spacing = unit(-0.01, "lines"),
    panel.border = element_rect(colour = "black", fill=NA, size=0.25),
    plot.margin = margin(0,5,5,5, unit="pt")
    )+
  scale_x_reverse(n.breaks=15) +
  #here we plot the taxonomic q=0 for each site and color black
  geom_line(data=Pac.div, 
            mapping=aes(group=site),col="#000000", na.rm=T, alpha=0.5, linewidth=0.25)+
  geom_line(data=Pac.div, 
            mapping=aes(KyrBP,fq2, group=site),col="#e4851b", na.rm=T, alpha=0.5, 
            linewidth=0.25) +
  geom_smooth(mapping=aes(KyrBP,q2), method="gam", formula=y ~ s(x, bs="tp"), method.args = list(family = gaussian(link = "identity")), n=100, na.rm=T, col="#000000", 
             linewidth=0.5, level=0.95, alpha=0.63) +
  #plotting the taxonomic significant decreases by filtering out all of the NA values in the sig.t dec column
  geom_line(data=Pac.sig.t[[3]]%>%filter(!is.na(.$dec)), mapping=aes(x, y, group=dec), col="#000000", 
            linewidth=1.5, alpha=0.7) + 
  #plotting the taxonomic significant increases by filtering out all of the NA values in the sig.t inc column
  geom_line(data=Pac.sig.t[[3]]%>%filter(!is.na(.$inc)), mapping=aes(x, y, group=inc), col="#000000", 
            linewidth=1.5, alpha=0.7) +
  #smoothing all of the site functional q=0 values with a GAM and plotting in orange
  geom_smooth(mapping=aes(KyrBP,fq2), method="gam", formula=y ~ s(x, bs="tp"), method.args = list(family = gaussian(link = "identity")), n=100, na.rm=T, col="#e4851b", 
              linewidth=0.5, level=0.95, alpha=0.63) +
  #The same is done for the functional significant increases and decreases but they are plotted in orange 
  geom_line(data=Pac.sig.f[[3]]%>%filter(!is.na(.$dec)), mapping=aes(x, y, group=dec), col="#e4851b", 
            linewidth=1.5, alpha=0.7) +
  geom_line(data=Pac.sig.f[[3]]%>%filter(!is.na(.$inc)), mapping=aes(x, y, group=inc), col="#e4851b", 
            linewidth=1.5, alpha=0.7) +
  #vertical lines are added to indicate the start of the record for each region
  labs(y = "Plant Diversity (Effective Number of Species)", x = "Age (cal ka BP)")+
  facet_wrap(~Region, nrow=3, ncol=1) + #the plots are arranged in 1 column with 7 rows
  geom_text( #region labeles are again added
    check_overlap = T,
    data = Pac.dat_text,
    mapping = aes(x = 157, y = 12.4, label = label),
    hjust="left",
    vjust="bottom",
    fontface="bold",
    family= "sans",
    size=3
  ) +
  geom_text( #MIS labels are added
    data = Pac.mis_lab_sig,
    mapping = aes(x = x, y = (y/3)-3, label = label),
    hjust="middle",
    vjust="top",
    fontface = "bold",
    family="sans",
    size=1.5
  ) +
  coord_cartesian(ylim=c(1, 13), xlim=c(150, 0), clip="off") #y axis limits (0,10) are defined and clip is turned off to allow labels to be placed outside of the plot

Pac.fig.q2<-ggarrange(Pac18O, NULL, Pac.sig.q2, ncol=1, nrow=3, align = "v", heights = c(1, -0.15, 3.7))

ggsave("./supplemental plots/Paci_clim_raw_q2.pdf", Pac.fig.q2, width=3, height=6.1, units = "in", device="pdf")
```
