---
title: "figure_script"
author: "Timothy Terlizzi"
date: "2023-01-30"
output: html_document
---
# Figure Script Context
The code within this script is used to generate all of the figures within the paper and supplemental material. It uses .csv files generated by both the smthdata_v2_Brewer.Rmd and hill_number_calculations.Rmd *Note both of these scripts must be run before the figures in this script can be generated* For the figures generated within ArcGIS Pro, the input data (such as the marine isotope stage (MIS) means and the Kruskal-Wallis tests) were also generated within this script.

#Libraries and Packages
The packages that need to be installed
```{r}
install.packages("paletteer")
```

These are the packages used in this file
```{r Required Packages}
library("vegan")
library("ggplot2")
library("ggrepel")
library("ggforce")
library("dplyr")
library("paletteer")
library("mgcv")
library("gratia")
library("ggformula")
library("ggpubr")
```

# Data Import
This code is to read in the raw composite datasheet we generated using the code in the smthdata_v2_Brewer.Rmd file.
```{r File Import, echo=TRUE}
tot<-read.csv("./composite/NAAll_raw.csv") #importing the composite raw data file for all the sites from the composite folder in the working directory

colnames(tot)[1] ="Sample" #renaming the first column in the raw data to Sample from its original name of site

tot$site<-gsub("[^a-zA-Z]", "", tot$Sample) #create a column with the name of the site for each sample; removing the numbers from the Sample column 
```

# DCA Code
The below code is used to generate a Detrended Correspondence Analysis (DCA) which was then used to create 7 regions based on the groupings of sites within the DCA. We opted to use a DCA due to its status as the preferred coordination method within the ecological community. This DCA creates a point for each row of the tot dataframe and color codes them based on the site. The placement of the points is based on the taxonomic composition of each sample. Samples with similar taxonomic compositions plot close together while samples with difference compositions plot farther apart. This enabled us to group sites together based on the taxonomic composition. The results of the DCA also confirmed our assumption that sites within geographically similar regions have similar taxonomic compositions. 

### DCA variables
These are the necessary variables to transform the data to correct for differences in number of taxa and number of samples as well as generate the DCA that is plotted in the following code chunk.
```{r Defining_DCA_variables, echo=TRUE}
tot[is.na(tot)]<-0 #replacing NA's with 0 as the DCA cannot run with NA's
mysites <- tot$site #list of sites for color coding
#standardization method for the DCA to correct for differences in the number of samples and number of taxa
tot.t1<-decostand(tot[,3:150], "total") #standardization method to divide by the total number of rows
tot.t2<-decostand(tot.t1, "max") #divide by the maximum column
tot.t2.dca<-decorana(tot.t2) #running the DCA with the transformed data

t2.dca.scores <- tot.t2.dca$rproj[ ,1:2] # Extract axis 1 & 2 sample scores 
t2.dca.scoressites <- data.frame(t2.dca1=t2.dca.scores[,1],t2.dca2=t2.dca.scores[,2],"sit"=mysites)
attach(t2.dca.scoressites) # Merge site codes and samples scores into single data frame 

#calculating the centroid for each site in the DCA (centroid is the center of the point cloud for each site; this is not the same thing as the center of the CI ellipse)
cent <- aggregate(cbind(t2.dca1, t2.dca2) ~ sit, data = t2.dca.scoressites, FUN = mean)

virid<-paletteer_c("grDevices::Viridis", 29) #creating a color palette for the 29 sites of the DCA
```

### DCA plotting
The below code is to plot the DCA with 30% CI ellipses. This means the ellipses represent 30% of the points for each site. Larger ellipses indicate a wider range of taxonomic compositions over time while smaller ellipses indicate taxonomic stability over time. 
```{r DCA_Plotting, echo=TRUE, message=FALSE}
#plotting the DCA as normal but adding CI ellipse with a level of 0.3 to the sites, this plot does the best job as visualizing where the sites are plotting in the DCA and was used to create our seven regions
dca.ellipse<-ggplot(t2.dca.scoressites, aes(t2.dca1,t2.dca2, col=sit)) +
  geom_point(alpha=0.25, aes(col=sit), size=0.5) +
  theme_classic() + 
  stat_ellipse(geom="polygon", aes(fill=sit), 
               color="#000000", 
               type="t",level=0.3,alpha=0.5) + 
  geom_text_repel(data = cent, mapping=aes(label=sit), #adding site name labels
                  max.overlaps = 20, bg.color="white", bg.r=0.05,
                  segment.colour="#000000", color="#000000",
                  box.padding = 0.75, force=3) +
  scale_color_manual(values=virid) + #coloring the points with the custom color scale
  scale_fill_manual(values=virid) + #coloring the ellipse with the custom color scale
  xlab("DCA axis 1") +
  ylab("DCA axis 2") +
  theme(
    legend.position = "none",
    panel.border = element_rect(colour = "black", fill=NA, size=0.25)
  ) + 
  ggtitle("Site DCA")

dca.ellipse #display the ellipse DCA

#save the ellipse DCA as a pdf in the supplemental_plots folder within the working directory
ggsave("DCA_ellipse.pdf", plot=dca.ellipse, path="./supplemental plots", device="pdf")
ggsave("./supplemental plots/DCA_ellipse.jpg", dca.ellipse, device="jpeg", dpi = 1000)
ggsave("./supplemental plots/DCA_ellipse.tif", dca.ellipse, device="tiff", dpi = 1000)
```

# Region classifications
We used the DCA to group similar sites together into regions. The region numbers for each site were manually determined and listed here. Sites were grouped into regions so that their diversity trends could be plotted together and smoothed with a spline.
```{r creating region groupings, echo=TRUE}
tot$reg<-0 #creating a region column

#creating a region dataframe with a row for each site and a region number associated with each site. The region grouping were determined via the DCA plotted above and manually listed
reg<-data.frame(site=unique(tot$site), region=c(4,5,5,5,2,6,2,3,1,4,3,5,1,2,5,1,3,2,5,3,5,6,7,5,5,6,1,4,1)) #region list ordered by site

#looping through each row in reg and tot to assign a region number for each sample in the tot data frame
for (j in 1:nrow(reg)){
  for (k in 1:nrow(tot)){
    if (reg$site[j]==tot$site[k]){
      tot$reg[k]<-reg$region[j]
    }
  }
}

tot$reg<-as.character(tot$reg) #converting the numeric regions to character for discrete classification
```

### DCA with regions
This code replots the DCA from above but adds ellipses grouping the sites into the 7 different regions in order to visualize the regional classifications. The Grass site is the only site that does not match its grouping. Grass on the DCA is more aligned with the Intermountain West (IMW) than the Pacific Northwest but it's location is in Northern California. We decided to include Grass in the Pacific Northwest because of its location rather than IMW due to it appearing to be an outlier in our dataset.
```{r DCA Plot with regions, echo=TRUE}
cent$reg<-reg$region #giving the centroid dataframe region classifications as well
cent$reg<-as.character(cent$reg) #converting to characters to be used in the plot

#replotting the dca to add ellipses to highlight the different region groupings
dca.region<-ggplot(t2.dca.scoressites, aes(t2.dca1,t2.dca2, col=sit)) +
  geom_point(alpha=0.25, aes(col=sit), size=0.5, color="#000000") +
  theme_classic() + 
  stat_ellipse(geom="polygon", aes(group=sit, fill=sit), 
               type="t",level=0.3,alpha=0.5, fill="#000000", color="#000000") + 
  theme(
    legend.position = "none",
    panel.border = element_rect(colour = "black", fill=NA, size=0.25)
  ) + 
  ggtitle("Transformed ellipse with Regions") +
  #the code below is used to create ellipses around the sites that have been grouped into the same region, this is for the visualization of the region classifications that were made using the DCA
  geom_mark_ellipse(data=cent, aes(group=reg, filter = sit != "grass", label=reg), #excluding the grass site as it is the only one to not fit into the region classifications
                    color="red", linetype=1, size=0.5, label.fill=NA, con.size=0.5,
                    label.buffer = unit(48.5, "pt"), fill="red", alpha=0.1) +
  xlab("DCA axis 1") +
  ylab("DCA axis 2") 
  
  dca.region #plotting the DCA with region groupings highlighted

#saving the DCA as DCA_region_classification.pdf within the supplemental plots folder in the working directory  
ggsave("DCA_region_classification.pdf", plot=dca.region, path="./supplemental plots", device="pdf")
ggsave("./supplemental plots/DCA_region_classification.jpg", dca.region, device="jpeg", dpi = 1000)
ggsave("./supplemental plots/DCA_region_classification.tif", dca.region, device="tiff", dpi = 1000)
```

# Trend line plots
The below code chunks are used to plot the diversity trend lines. The majority of the code is used to identify the significant shifts in diversity via GAM derivatives and manually filtering to only show the trends during the significant periods via ifelse statements. The trend line plots are used for figures 2, 3, and 4 in the paper. 

### Data import and Significance
The below code is used to first import the tot.sm dataframe with the hill numbers and assign the region classifications to each site manually as was done above with the DCA. The hill numbers are smoothed for each region with a GAM, creating 7 GAMs for each order of q, and both taxonomic and functional diversity, for 42 total GAMs. The GAMs are then filtered by their derivatives to only include the years that are deemed significant based on the methods of Simpson, 2018.
```{r}
tot.sm<-read.csv("./composite/hill_master.csv") #importing the master file with both taxonomic and functional Hill numbers

#creating a dateframe with the name of each site as a row and the region classicaiton in another column
reg<-data.frame(site=unique(tot.sm$site), region=c(4,5,5,5,2,6,2,3,1,4,3,5,1,2,5,1,3,2,5,3,5,6,7,5,5,6,1,4,1))

#creating a KyrBP column to put the time in thousands of years rather than just years
tot.sm<-tot.sm %>%
  mutate(KyrBP = .$YrBP/1000)

#assigning the region number to each row of tot.sm based on the site name
for (j in 1:nrow(reg)){
  for (k in 1:nrow(tot.sm)){
    if (reg$site[j]==tot.sm$site[k]){
      tot.sm$Region[k]<-reg$region[j]
    }
  }
}

#classifying the regions numbers as characters to prevent issues when plotting
tot.sm$Region<-as.character(tot.sm$Region)

#replacing rows 770 through 774 of the functional q=0, q=1, and q=2 with NA due to an artifact of the formulas having diversity approach infinity. This is because row 774 was 100% pine pollen which caused the formula to produce infinity. Removing these rows prevents the data from distorting the spline. 
tot.sm$fq0[770:774]<-NA
tot.sm$fq1[770:774]<-NA
tot.sm$fq2[770:774]<-NA
```

```{r}
#creating two empty lists, one for the identified significant decreases and one for the identified significant increases
smth.dec<-list() #decreases
smth.inc<-list() #increases 

#looping through the six different diversity measures aka the taxonomic q=0, q=1, and q=2 and the functional q=0, q=1, and q=2
for (q in 1:6){
  reg.dec<-list() #creating a temporary list in the loop to store the significant decreases for an individual region
  reg.inc<-list() #creating a temporary list in the loop to store the significant increases for an individual region
  for (i in 1:7){ #looping through the 7 different regions
    tot.reg<-tot.sm%>% #filtering tot.sm to only include record for region i 
    filter(.$Region==i)
  
    smth<-gam(tot.reg[,q+151] ~ s(KyrBP), data=tot.reg) #creating the GAM for the current (q) diversity metric and the current region i
  
    smth.d<-derivatives(smth, type="central") #taking the derivative of the generated GAM
  
    #because the x axis is time and we are looking at it in reverse (ie 150-0 rather than 0-150) decreases in the gam are actually increases when we plot them later with the reversed x axis. 
    reg.inc[[i]]<-smth.d$data[smth.d$upper<0 & smth.d$lower<0] #if the upper and lower CI are below 0 then it is deemed a signficant increase and stored within reg.inc as item [[i]] for the region number.
    reg.dec[[i]]<-smth.d$data[smth.d$upper>0 & smth.d$lower>0] #if the upper and lower CI are above 0 then it is a significant decrease and stored within reg.dec as item [[i]] for the region number
  }
  #once we've iterated through all 7 regions (i) we save the list of 7 items within smth.inc and smth.dec for the current diversity metric (q). The result is smth.inc and smth.dec have 6 items, for each q, and each of the 6 items has 7 trends.
  smth.inc[[q]]<-reg.inc
  smth.dec[[q]]<-reg.dec
}

#creating two empty lists, one for the taxonomic significant trends and one for the functional significant trends
sig.t<-list() #taxonomic trends
sig.f<-list() #functional trends

#looping through the three orders of q, q=0, q=1, and q=2
for (q in 1:3){
  sm.t<-data.frame() #creating an empty dataframe to store the taxonomic spline data for all 7 regions 
  sm.f<-data.frame() #creating an empty dataframe to store the functional spline data for all 7 regions
  #looping through all 7 regions
  for (i in 1:7){
    tot.reg<-tot.sm %>% #filtering for only the current region (i)
      filter(.$Region==i)
    
    #using the ggplot_build function to save the metadata of a geom_smooth with the method="gam". The ggplot GAM spline is the same as the mgcv GAM, however using the ggplot version makes it easier to plot in ggplot with the trend lines. This is for the taxonomic diversity
    dat.sm.t<-ggplot_build(ggplot(tot.reg, aes(KyrBP, tot.reg[,q+151]))+
    geom_smooth(mapping=aes(KyrBP, tot.reg[,q+151]),method="gam", na.rm=T))$data[[1]][1:2]
    
    dat.sm.t$Region[1:nrow(dat.sm.t)]<-i #adding a Region column with the region number (i) to the spline data
    sm.t<-rbind(sm.t, dat.sm.t) #using the rbind function the regional splines are combined into one dataframe, sm.t, that contains the taxonomic splines for all 7 regions.
 
    #we repeat the above code but for the functional diversity
    dat.sm.f<-ggplot_build(ggplot(tot.reg, aes(KyrBP, tot.reg[,q+154]))+
    geom_smooth(mapping=aes(KyrBP, tot.reg[,q+154]),method="gam", na.rm=T))$data[[1]][1:2]
    
    dat.sm.f$Region[1:nrow(dat.sm.f)]<-i
    sm.f<-rbind(sm.f, dat.sm.f)
  }
  sig.t[[q]]<-sm.t #the splines for all regions are then added to the list as item q for the diversity metric. The result is a list with 3 items for each q, and each item is a dataframe with the splines of all 7 regions. This is for taxonomic diversity.
  sig.f[[q]]<-sm.f #this is for functional diversity
}
```

### Significance Filtering
The below code is overwhelming at first but its purpose is simple. The extracted values for the ggplot GAMs need to be filtered to only include dates with the identified significant increases and decreases. To do this we use ifelse() to check to see if there are x values that fall within the range of values from smth.dec or smth.inc. This was manually done by viewing the x values for each region and q value within smth.dec and smth.inc and writing out the ifelse() statements. Many trends have multiple periods of significant trends, to prevent the inclusion of x values that fall between the significant periods, multiple iflelse() statements had to be used. Additionally, in the cases with multiple significant trends, each signficant period was given a different number, for example if there were three periods, then trends would be numbers 1, 2, and 3. This was done so when plotting, ggplot would not try and connect the periods. This was done for both significant increases and decreases for each of the seven regions, and the three q orders for both taxonomic and functional diversity. As such there are ((7 regions * 3 q values) * 2 trends(increases and decreases) * 2 metrics (taxonomic and functional)) or 84 ifelse blocks. 
```{r}
#The below code is to identify the significant increases and decreases for taxonomic diversity

#for each q within sig.t, we create a decrease column and an increase column and fill with NA's, significant periods with have their NA's replaced with sequential numbers
#for clarity, indexing through sig.t or sig.t can be through of as: sig.t[[q value]]
sig.t[[1]]$dec<-NA
sig.t[[2]]$dec<-NA
sig.t[[3]]$dec<-NA

sig.t[[1]]$inc<-NA
sig.t[[2]]$inc<-NA
sig.t[[3]]$inc<-NA

#looping through every row of sig.t[[1]] which is the same number as the other q values (sig.t[[2]] and sig.t[[3]])). This is so the if statement can be applied to every row, one at a time.
for (i in 1:nrow(sig.t[[1]])){
  
  ########q0
  
  #rather than go through each block, this will be described in detail and can be applied to any of the below.
  if (sig.t[[1]]$Region[i]==1) #This block is to identify the significant trends within region 1 so the first step is to check if the current row of sig.t is in region 1, if it is then the below code is executed and if it is not then nothing is done
    #Region 1 of q=0 has 2 significant decreases, so we set up two ifelse() statements
    {ifelse(sig.t[[1]]$x[i] >= smth.dec[[1]][[1]][1] & sig.t[[1]]$x[i] <= smth.dec[[1]][[1]][13], #if the x value falls between row 1 and 13 of smth.dec q=0 and region 1, then the dec column is given a value of 1. The indexing through the lists can be confusing so this is the key: smth.dec[[q value]][[region]][row #]. The same is true for smth.inc
    sig.t[[1]]$dec[i]<-1, #storing a value of 1 for any rows where x falls between the above values
    ifelse(sig.t[[1]]$x[i] >= smth.dec[[1]][[1]][14] & sig.t[[1]]$x[i] <= smth.dec[[1]][[1]][21], #since there is a second significant decrease, another ifelse() statement is used in the place of the else portion of the initial ifelse() statement
    sig.t[[1]]$dec[i]<-2, sig.t[[1]]$dec[i]<-NA))} #if the x values fall within the second range, then the row gets a 2 in its dec column. If the x value does not fall within either of the significant ranges, it is given a value of NA, indicating it is not significant.
  
  #this pattern is repeated for each region and q value
  if (sig.t[[1]]$Region[i]==2)
    {ifelse(sig.t[[1]]$x[i] >= smth.dec[[1]][[2]][1] & sig.t[[1]]$x[i] <= smth.dec[[1]][[2]][16],  
    sig.t[[1]]$dec[i]<-1, sig.t[[1]]$dec[i]<-NA)}
  
  if (sig.t[[1]]$Region[i]==3)
    {ifelse(sig.t[[1]]$x[i] >= smth.dec[[1]][[3]][1] & sig.t[[1]]$x[i] <= smth.dec[[1]][[3]][16],  
    sig.t[[1]]$dec[i]<-1, 
    ifelse(sig.t[[1]]$x[i] >= smth.dec[[1]][[3]][17] & sig.t[[1]]$x[i] <= smth.dec[[1]][[3]][46], 
    sig.t[[1]]$dec[i]<-2, sig.t[[1]]$dec[i]<-NA))}
  
  if (sig.t[[1]]$Region[i]==4){} #a region with no significant periods is empty
  
  if (sig.t[[1]]$Region[i]==5)
    {ifelse(sig.t[[1]]$x[i] >= smth.dec[[1]][[5]][1] & sig.t[[1]]$x[i] <= smth.dec[[1]][[5]][17],  
    sig.t[[1]]$dec[i]<-1, 
    ifelse(sig.t[[1]]$x[i] >= smth.dec[[1]][[5]][18] & sig.t[[1]]$x[i] <= smth.dec[[1]][[5]][30], 
    sig.t[[1]]$dec[i]<-2, sig.t[[1]]$dec[i]<-NA))}
  
  if (sig.t[[1]]$Region[i]==6){}
  
  if (sig.t[[1]]$Region[i]==7)
    {ifelse(sig.t[[1]]$x[i] >= smth.dec[[1]][[7]][1] & sig.t[[1]]$x[i] <= smth.dec[[1]][[7]][26],  
    sig.t[[1]]$dec[i]<-1, 
    ifelse(sig.t[[1]]$x[i] >= smth.dec[[1]][[7]][27] & sig.t[[1]]$x[i] <= smth.dec[[1]][[7]][45], 
    sig.t[[1]]$dec[i]<-2, sig.t[[1]]$dec[i]<-NA))}
 
   ###########q1
  if (sig.t[[2]]$Region[i]==1)
    {ifelse(sig.t[[2]]$x[i] >= smth.dec[[2]][[1]][1] & sig.t[[2]]$x[i] <= smth.dec[[2]][[1]][185],  
    sig.t[[2]]$dec[i]<-1, sig.t[[2]]$dec[i]<-NA)}
  
  if (sig.t[[2]]$Region[i]==2)
    {ifelse(sig.t[[2]]$x[i] >= smth.dec[[2]][[2]][1] & sig.t[[2]]$x[i] <= smth.dec[[2]][[2]][49],  
    sig.t[[2]]$dec[i]<-1, sig.t[[2]]$dec[i]<-NA)}
  
  if (sig.t[[2]]$Region[i]==3)
    {ifelse(sig.t[[2]]$x[i] >= smth.dec[[2]][[3]][1] & sig.t[[2]]$x[i] <= smth.dec[[2]][[3]][25],  
    sig.t[[2]]$dec[i]<-1, 
    ifelse(sig.t[[2]]$x[i] >= smth.dec[[2]][[3]][26] & sig.t[[2]]$x[i] <= smth.dec[[2]][[3]][66], 
    sig.t[[2]]$dec[i]<-2, sig.t[[2]]$dec[i]<-NA))}
  
  if (sig.t[[2]]$Region[i]==4)
    {ifelse(sig.t[[2]]$x[i] >= smth.dec[[2]][[4]][1] & sig.t[[2]]$x[i] <= smth.dec[[2]][[4]][38],  
    sig.t[[2]]$dec[i]<-1, 
    ifelse(sig.t[[2]]$x[i] >= smth.dec[[2]][[4]][39] & sig.t[[2]]$x[i] <= smth.dec[[2]][[4]][76], 
    sig.t[[2]]$dec[i]<-2, sig.t[[2]]$dec[i]<-NA))}
  
  if (sig.t[[2]]$Region[i]==5)
    {ifelse(sig.t[[2]]$x[i] >= smth.dec[[2]][[5]][1] & sig.t[[2]]$x[i] <= smth.dec[[2]][[5]][28],  
    sig.t[[2]]$dec[i]<-1, sig.t[[2]]$dec[i]<-NA)}
  
  if (sig.t[[2]]$Region[i]==6)
    {ifelse(sig.t[[2]]$x[i] >= smth.dec[[2]][[6]][1] & sig.t[[2]]$x[i] <= smth.dec[[2]][[6]][18],  
    sig.t[[2]]$dec[i]<-1, 
    ifelse(sig.t[[2]]$x[i] >= smth.dec[[2]][[6]][19] & sig.t[[2]]$x[i] <= smth.dec[[2]][[6]][36], 
    sig.t[[2]]$dec[i]<-2,
    ifelse(sig.t[[2]]$x[i] >= smth.dec[[2]][[6]][37] & sig.t[[2]]$x[i] <= smth.dec[[2]][[6]][60],
    sig.t[[2]]$dec[i]<-3, sig.t[[2]]$dec[i]<-NA)))}
  
  if (sig.t[[2]]$Region[i]==7)
    {ifelse(sig.t[[2]]$x[i] >= smth.dec[[2]][[7]][1] & sig.t[[2]]$x[i] <= smth.dec[[2]][[7]][65],  
    sig.t[[2]]$dec[i]<-1, sig.t[[2]]$dec[i]<-NA)}
  
  ######q2
  if (sig.t[[3]]$Region[i]==1)
    {ifelse(sig.t[[3]]$x[i] >= smth.dec[[3]][[1]][1] & sig.t[[3]]$x[i] <= smth.dec[[3]][[1]][4],  
    sig.t[[3]]$dec[i]<-1, 
    ifelse(sig.t[[3]]$x[i] >= smth.dec[[3]][[1]][5] & sig.t[[3]]$x[i] <= smth.dec[[3]][[1]][22],
    sig.t[[3]]$dec[i]<-2,
    ifelse(sig.t[[3]]$x[i] >= smth.dec[[3]][[1]][23] & sig.t[[3]]$x[i] <= smth.dec[[3]][[1]][28],
    sig.t[[3]]$dec[i]<-3, sig.t[[3]]$dec[i]<-NA)))}
 
   if (sig.t[[3]]$Region[i]==2)
    {ifelse(sig.t[[3]]$x[i] >= smth.dec[[3]][[2]][1] & sig.t[[3]]$x[i] <= smth.dec[[3]][[2]][43],  
    sig.t[[3]]$dec[i]<-1, sig.t[[3]]$dec[i]<-NA)}
  
  if (sig.t[[3]]$Region[i]==3)
    {ifelse(sig.t[[3]]$x[i] >= smth.dec[[3]][[3]][1] & sig.t[[3]]$x[i] <= smth.dec[[3]][[3]][23],  
    sig.t[[3]]$dec[i]<-1, 
    ifelse(sig.t[[3]]$x[i] >= smth.dec[[3]][[3]][24] & sig.t[[3]]$x[i] <= smth.dec[[3]][[3]][71], 
    sig.t[[3]]$dec[i]<-2, sig.t[[3]]$dec[i]<-NA))}
  
  if (sig.t[[3]]$Region[i]==4)
    {ifelse(sig.t[[3]]$x[i] >= smth.dec[[3]][[4]][1] & sig.t[[3]]$x[i] <= smth.dec[[3]][[4]][37],  
    sig.t[[3]]$dec[i]<-1, 
    ifelse(sig.t[[3]]$x[i] >= smth.dec[[3]][[4]][38] & sig.t[[3]]$x[i] <= smth.dec[[3]][[4]][74], 
    sig.t[[3]]$dec[i]<-2, sig.t[[3]]$dec[i]<-NA))}
  
  if (sig.t[[3]]$Region[i]==5)
    {ifelse(sig.t[[3]]$x[i] >= smth.dec[[3]][[5]][1] & sig.t[[3]]$x[i] <= smth.dec[[3]][[5]][25],  
    sig.t[[3]]$dec[i]<-1, 
    ifelse(sig.t[[3]]$x[i] >= smth.dec[[3]][[5]][26] & sig.t[[3]]$x[i] <= smth.dec[[3]][[5]][55],
    sig.t[[3]]$dec[i]<-2, sig.t[[3]]$dec[i]<-NA))}
  
  if (sig.t[[3]]$Region[i]==6)
    {ifelse(sig.t[[3]]$x[i] >= smth.dec[[3]][[6]][1] & sig.t[[3]]$x[i] <= smth.dec[[3]][[6]][12],  
    sig.t[[3]]$dec[i]<-1, 
    ifelse(sig.t[[3]]$x[i] >= smth.dec[[3]][[6]][13] & sig.t[[3]]$x[i] <= smth.dec[[3]][[6]][34], 
    sig.t[[3]]$dec[i]<-2,
    ifelse(sig.t[[3]]$x[i] >= smth.dec[[3]][[6]][35] & sig.t[[3]]$x[i] <= smth.dec[[3]][[6]][58],
    sig.t[[3]]$dec[i]<-3, 
    ifelse(sig.t[[3]]$x[i] >= smth.dec[[3]][[6]][59] & sig.t[[3]]$x[i] <= smth.dec[[3]][[6]][64],
    sig.t[[3]]$dec[i]<-4, sig.t[[3]]$dec[i]<-NA))))}
  
  if (sig.t[[3]]$Region[i]==7)
    {ifelse(sig.t[[3]]$x[i] >= smth.dec[[3]][[7]][1] & sig.t[[3]]$x[i] <= smth.dec[[3]][[7]][56],  
    sig.t[[3]]$dec[i]<-1, sig.t[[3]]$dec[i]<-NA)}

#The below code is now for the taxonomic significant increases. The pattern is the same except for using smth.inc and adding values to the inc column of sig.t rather than the dec.
  
  ########q0
  if (sig.t[[1]]$Region[i]==1)
    {ifelse(sig.t[[1]]$x[i] >= smth.inc[[1]][[1]][1] & sig.t[[1]]$x[i] <= smth.inc[[1]][[1]][25],  
    sig.t[[1]]$inc[i]<-1, sig.t[[1]]$inc[i]<-NA)}
  
  if (sig.t[[1]]$Region[i]==2)
    {ifelse(sig.t[[1]]$x[i] >= smth.inc[[1]][[2]][1] & sig.t[[1]]$x[i] <= smth.inc[[1]][[2]][28],  
    sig.t[[1]]$inc[i]<-1, 
    ifelse(sig.t[[1]]$x[i] >= smth.inc[[1]][[2]][29] & sig.t[[1]]$x[i] <= smth.inc[[1]][[2]][69],
    sig.t[[1]]$inc[i]<-2, sig.t[[1]]$inc[i]<-NA))}
  
  if (sig.t[[1]]$Region[i]==3)
    {ifelse(sig.t[[1]]$x[i] >= smth.inc[[1]][[3]][1] & sig.t[[1]]$x[i] <= smth.inc[[1]][[3]][17],  
    sig.t[[1]]$inc[i]<-1, 
    ifelse(sig.t[[1]]$x[i] >= smth.inc[[1]][[3]][18] & sig.t[[1]]$x[i] <= smth.inc[[1]][[3]][33],
    sig.t[[1]]$inc[i]<-2, 
    ifelse(sig.t[[1]]$x[i] >= smth.inc[[1]][[3]][34] & sig.t[[1]]$x[i] <= smth.inc[[1]][[3]][67],
    sig.t[[1]]$inc[i]<-3, sig.t[[1]]$inc[i]<-NA)))}
  
  if (sig.t[[1]]$Region[i]==4)
    {ifelse(sig.t[[1]]$x[i] >= smth.inc[[1]][[4]][1] & sig.t[[1]]$x[i] <= smth.inc[[1]][[4]][32],
    sig.t[[1]]$inc[i]<-1, sig.t[[1]]$inc<-NA)}
  
  if (sig.t[[1]]$Region[i]==5)
    {ifelse(sig.t[[1]]$x[i] >= smth.inc[[1]][[5]][1] & sig.t[[1]]$x[i] <= smth.inc[[1]][[5]][20],  
    sig.t[[1]]$inc[i]<-1, sig.t[[1]]$inc[i]<-NA)}
  
  if (sig.t[[1]]$Region[i]==6)
    {ifelse(sig.t[[1]]$x[i] >= smth.inc[[1]][[6]][1] & sig.t[[1]]$x[i] <= smth.inc[[1]][[6]][45],  
    sig.t[[1]]$inc[i]<-1, sig.t[[1]]$inc[i]<-NA)}
  
  if (sig.t[[1]]$Region[i]==7)
    {ifelse(sig.t[[1]]$x[i] >= smth.inc[[1]][[7]][1] & sig.t[[1]]$x[i] <= smth.inc[[1]][[7]][24],  
    sig.t[[1]]$inc[i]<-1, 
    ifelse(sig.t[[1]]$x[i] >= smth.inc[[1]][[7]][25] & sig.t[[1]]$x[i] <= smth.inc[[1]][[7]][53], 
    sig.t[[1]]$inc[i]<-2, sig.t[[1]]$inc[i]<-NA))}
  
  ###########q1
  if (sig.t[[2]]$Region[i]==1){}
  
  if (sig.t[[2]]$Region[i]==2)
    {ifelse(sig.t[[2]]$x[i] >= smth.inc[[2]][[2]][1] & sig.t[[2]]$x[i] <= smth.inc[[2]][[2]][51],  
    sig.t[[2]]$inc[i]<-1, 
    ifelse(sig.t[[2]]$x[i] >= smth.inc[[2]][[2]][52] & sig.t[[2]]$x[i] <= smth.inc[[2]][[2]][54],
    sig.t[[2]]$inc[i]<-2, sig.t[[2]]$inc[i]<-NA))}
  
  if (sig.t[[2]]$Region[i]==3){}
  
  if (sig.t[[2]]$Region[i]==4)
    {ifelse(sig.t[[2]]$x[i] >= smth.inc[[2]][[4]][1] & sig.t[[2]]$x[i] <= smth.inc[[2]][[4]][20],  
    sig.t[[2]]$inc[i]<-1, 
    ifelse(sig.t[[2]]$x[i] >= smth.inc[[2]][[4]][21] & sig.t[[2]]$x[i] <= smth.inc[[2]][[4]][53], 
    sig.t[[2]]$inc[i]<-2, sig.t[[2]]$inc[i]<-NA))}
  
  if (sig.t[[2]]$Region[i]==5)
    {ifelse(sig.t[[2]]$x[i] >= smth.inc[[2]][[5]][1] & sig.t[[2]]$x[i] <= smth.inc[[2]][[5]][29],  
    sig.t[[2]]$inc[i]<-1, sig.t[[2]]$inc[i]<-NA)}
  
  if (sig.t[[2]]$Region[i]==6)
    {ifelse(sig.t[[2]]$x[i] >= smth.inc[[2]][[6]][1] & sig.t[[2]]$x[i] <= smth.inc[[2]][[6]][21],  
    sig.t[[2]]$inc[i]<-1, 
    ifelse(sig.t[[2]]$x[i] >= smth.inc[[2]][[6]][22] & sig.t[[2]]$x[i] <= smth.inc[[2]][[6]][48], 
    sig.t[[2]]$inc[i]<-2,
    ifelse(sig.t[[2]]$x[i] >= smth.inc[[2]][[6]][49] & sig.t[[2]]$x[i] <= smth.inc[[2]][[6]][57],
    sig.t[[2]]$inc[i]<-3, sig.t[[2]]$inc[i]<-NA)))}
  
  if (sig.t[[2]]$Region[i]==7)
    {ifelse(sig.t[[2]]$x[i] >= smth.inc[[2]][[7]][1] & sig.t[[2]]$x[i] <= smth.inc[[2]][[7]][51],  
    sig.t[[2]]$inc[i]<-1, 
    ifelse(sig.t[[2]]$x[i] >= smth.inc[[2]][[7]][52] & sig.t[[2]]$x[i] <= smth.inc[[2]][[7]][83],
    sig.t[[2]]$inc[i]<-2, sig.t[[2]]$inc[i]<-NA))}
  
  ######q2
  if (sig.t[[3]]$Region[i]==1)
    {ifelse(sig.t[[3]]$x[i] >= smth.inc[[3]][[1]][1] & sig.t[[3]]$x[i] <= smth.inc[[3]][[1]][4],  
    sig.t[[3]]$inc[i]<-1, 
    ifelse(sig.t[[3]]$x[i] >= smth.inc[[3]][[1]][5] & sig.t[[3]]$x[i] <= smth.inc[[3]][[1]][16],
    sig.t[[3]]$inc[i]<-2, sig.t[[3]]$inc[i]<-NA))}
  
  if (sig.t[[3]]$Region[i]==2)
    {ifelse(sig.t[[3]]$x[i] >= smth.inc[[3]][[2]][1] & sig.t[[3]]$x[i] <= smth.inc[[3]][[2]][35],  
    sig.t[[3]]$inc[i]<-1, sig.t[[3]]$inc[i]<-NA)}
  
  if (sig.t[[3]]$Region[i]==3){}
  
  if (sig.t[[3]]$Region[i]==4)
    {ifelse(sig.t[[3]]$x[i] >= smth.inc[[3]][[4]][1] & sig.t[[3]]$x[i] <= smth.inc[[3]][[4]][11],  
    sig.t[[3]]$inc[i]<-1, 
    ifelse(sig.t[[3]]$x[i] >= smth.inc[[3]][[4]][12] & sig.t[[3]]$x[i] <= smth.inc[[3]][[4]][51], 
    sig.t[[3]]$inc[i]<-2, sig.t[[3]]$inc[i]<-NA))}
  
  if (sig.t[[3]]$Region[i]==5)
    {ifelse(sig.t[[3]]$x[i] >= smth.inc[[3]][[5]][1] & sig.t[[3]]$x[i] <= smth.inc[[3]][[5]][32],  
    sig.t[[3]]$inc[i]<-1, 
    ifelse(sig.t[[3]]$x[i] >= smth.inc[[3]][[5]][33] & sig.t[[3]]$x[i] <= smth.inc[[3]][[5]][39],
    sig.t[[3]]$inc[i]<-2, sig.t[[3]]$inc[i]<-NA))}
  
  if (sig.t[[3]]$Region[i]==6)
    {ifelse(sig.t[[3]]$x[i] >= smth.inc[[3]][[6]][1] & sig.t[[3]]$x[i] <= smth.inc[[3]][[6]][15],  
    sig.t[[3]]$inc[i]<-1, 
    ifelse(sig.t[[3]]$x[i] >= smth.inc[[3]][[6]][16] & sig.t[[3]]$x[i] <= smth.inc[[3]][[6]][42], 
    sig.t[[3]]$inc[i]<-2,
    ifelse(sig.t[[3]]$x[i] >= smth.inc[[3]][[6]][43] & sig.t[[3]]$x[i] <= smth.inc[[3]][[6]][55],
    sig.t[[3]]$inc[i]<-3, sig.t[[3]]$inc[i]<-NA)))}
  
  if (sig.t[[3]]$Region[i]==7)
    {ifelse(sig.t[[3]]$x[i] >= smth.inc[[3]][[7]][1] & sig.t[[3]]$x[i] <= smth.inc[[3]][[7]][47],  
    sig.t[[3]]$inc[i]<-1, 
    ifelse(sig.t[[3]]$x[i] >= smth.inc[[3]][[7]][48] & sig.t[[3]]$x[i] <= smth.inc[[3]][[7]][69],
    sig.t[[3]]$inc[i]<-2, sig.t[[3]]$inc[i]<-NA))}
} #here the loop ends as we have iterated through all of the q values and regions for increases and decreases

#the below code is the same as the above, but it is not repeated for all of the functional diversity trends. As such we use sig.f rather than sig.t. The pattern is the same as above. 
sig.f[[1]]$dec<-NA
sig.f[[2]]$dec<-NA
sig.f[[3]]$dec<-NA

sig.f[[1]]$inc<-NA
sig.f[[2]]$inc<-NA
sig.f[[3]]$inc<-NA

#significant functional decreases
#looping through each row of the functional trends
for (i in 1:nrow(sig.f[[1]])){
  ########fq0
  if (sig.f[[1]]$Region[i]==1){}
  
  if (sig.f[[1]]$Region[i]==2){}
  
  if (sig.f[[1]]$Region[i]==3)
    {ifelse(sig.f[[1]]$x[i] >= smth.dec[[4]][[3]][1] & sig.f[[1]]$x[i] <= smth.dec[[4]][[3]][19],  
    sig.f[[1]]$dec[i]<-1, sig.f[[1]]$dec[i]<-NA)}
  
  if (sig.f[[1]]$Region[i]==4){}
  
  if (sig.f[[1]]$Region[i]==5)
    {ifelse(sig.f[[1]]$x[i] >= smth.dec[[4]][[5]][1] & sig.f[[1]]$x[i] <= smth.dec[[4]][[5]][27],  
    sig.f[[1]]$dec[i]<-1, 
    ifelse(sig.f[[1]]$x[i] >= smth.dec[[4]][[5]][28] & sig.f[[1]]$x[i] <= smth.dec[[4]][[5]][52], 
    sig.f[[1]]$dec[i]<-2, sig.f[[1]]$dec[i]<-NA))}
  
  if (sig.f[[1]]$Region[i]==6){}
  
  if (sig.f[[1]]$Region[i]==7)
    {ifelse(sig.f[[1]]$x[i] >= smth.dec[[4]][[7]][1] & sig.f[[1]]$x[i] <= smth.dec[[4]][[7]][36],  
    sig.f[[1]]$dec[i]<-1, 
    ifelse(sig.f[[1]]$x[i] >= smth.dec[[4]][[7]][37] & sig.f[[1]]$x[i] <= smth.dec[[4]][[7]][59], 
    sig.f[[1]]$dec[i]<-2, sig.f[[1]]$dec[i]<-NA))}
  
  ###########fq1
  if (sig.t[[2]]$Region[i]==1)
    {ifelse(sig.f[[2]]$x[i] >= smth.dec[[5]][[1]][1] & sig.f[[2]]$x[i] <= smth.dec[[5]][[1]][41],  
    sig.f[[2]]$dec[i]<-1, 
    ifelse(sig.f[[2]]$x[i] >= smth.dec[[5]][[1]][42] & sig.f[[2]]$x[i] <= smth.dec[[5]][[1]][80],
    sig.f[[2]]$dec[i]<-2, sig.f[[2]]$dec[i]<-NA))}
  
  if (sig.f[[2]]$Region[i]==2)
    {ifelse(sig.f[[2]]$x[i] >= smth.dec[[5]][[2]][1] & sig.f[[2]]$x[i] <= smth.dec[[5]][[2]][76],  
    sig.f[[2]]$dec[i]<-1, sig.f[[2]]$dec[i]<-NA)}
  
  if (sig.f[[2]]$Region[i]==3)
    {ifelse(sig.f[[2]]$x[i] >= smth.dec[[5]][[3]][1] & sig.f[[2]]$x[i] <= smth.dec[[5]][[3]][27],  
    sig.f[[2]]$dec[i]<-1, sig.f[[2]]$dec[i]<-NA)}
  
  if (sig.f[[2]]$Region[i]==4)
    {ifelse(sig.f[[2]]$x[i] >= smth.dec[[5]][[4]][1] & sig.f[[2]]$x[i] <= smth.dec[[5]][[4]][32],  
    sig.f[[2]]$dec[i]<-1, 
    ifelse(sig.f[[2]]$x[i] >= smth.dec[[5]][[4]][33] & sig.f[[2]]$x[i] <= smth.dec[[5]][[4]][69], 
    sig.f[[2]]$dec[i]<-2, sig.f[[2]]$dec[i]<-NA))}
  
  if (sig.f[[2]]$Region[i]==5)
    {ifelse(sig.f[[2]]$x[i] >= smth.dec[[5]][[5]][1] & sig.f[[2]]$x[i] <= smth.dec[[5]][[5]][32],  
    sig.f[[2]]$dec[i]<-1, 
    ifelse(sig.f[[2]]$x[i] >= smth.dec[[5]][[5]][33] & sig.f[[2]]$x[i] <= smth.dec[[5]][[5]][49],
    sig.f[[2]]$dec[i]<-2, sig.f[[2]]$dec[i]<-NA))}
  
  if (sig.f[[2]]$Region[i]==6)
    {ifelse(sig.f[[2]]$x[i] >= smth.dec[[5]][[6]][1] & sig.f[[2]]$x[i] <= smth.dec[[5]][[6]][17],  
    sig.f[[2]]$dec[i]<-1, sig.f[[2]]$dec[i]<-NA)}
  
  if (sig.f[[2]]$Region[i]==7)
    {ifelse(sig.f[[2]]$x[i] >= smth.dec[[5]][[7]][1] & sig.f[[2]]$x[i] <= smth.dec[[5]][[7]][71],  
    sig.f[[2]]$dec[i]<-1, sig.f[[2]]$dec[i]<-NA)}
  
  ######fq2
  if (sig.f[[3]]$Region[i]==1)
    {ifelse(sig.f[[3]]$x[i] >= smth.dec[[6]][[1]][1] & sig.f[[3]]$x[i] <= smth.dec[[6]][[1]][44],  
    sig.f[[3]]$dec[i]<-1, 
    ifelse(sig.f[[3]]$x[i] >= smth.dec[[6]][[1]][45] & sig.f[[3]]$x[i] <= smth.dec[[6]][[1]][103],
    sig.f[[3]]$dec[i]<-2, sig.f[[3]]$dec[i]<-NA))}
  
  if (sig.f[[3]]$Region[i]==2)
    {ifelse(sig.f[[3]]$x[i] >= smth.dec[[6]][[2]][1] & sig.f[[3]]$x[i] <= smth.dec[[6]][[2]][26],  
    sig.f[[3]]$dec[i]<-1, 
    ifelse(sig.f[[3]]$x[i] >= smth.dec[[6]][[2]][27] & sig.f[[3]]$x[i] <= smth.dec[[6]][[2]][52],
    sig.f[[3]]$dec[i]<-2, sig.f[[3]]$dec[i]<-NA))}
  
  if (sig.f[[3]]$Region[i]==3)
    {ifelse(sig.f[[3]]$x[i] >= smth.dec[[6]][[3]][1] & sig.f[[3]]$x[i] <= smth.dec[[6]][[3]][29],  
    sig.f[[3]]$dec[i]<-1, sig.f[[3]]$dec[i]<-NA)}
  
  if (sig.f[[3]]$Region[i]==4)
    {ifelse(sig.f[[3]]$x[i] >= smth.dec[[6]][[4]][1] & sig.f[[3]]$x[i] <= smth.dec[[6]][[4]][30],  
    sig.f[[3]]$dec[i]<-1, 
    ifelse(sig.f[[3]]$x[i] >= smth.dec[[6]][[4]][31] & sig.f[[3]]$x[i] <= smth.dec[[6]][[4]][76], 
    sig.f[[3]]$dec[i]<-2, sig.f[[3]]$dec[i]<-NA))}
  
  if (sig.f[[3]]$Region[i]==5)
    {ifelse(sig.f[[3]]$x[i] >= smth.dec[[6]][[5]][1] & sig.f[[3]]$x[i] <= smth.dec[[6]][[5]][29],  
    sig.f[[3]]$dec[i]<-1, 
    ifelse(sig.f[[3]]$x[i] >= smth.dec[[6]][[5]][30] & sig.f[[3]]$x[i] <= smth.dec[[6]][[5]][48],
    sig.f[[3]]$dec[i]<-2, sig.f[[3]]$dec[i]<-NA))}
  
  if (sig.f[[3]]$Region[i]==6)
    {ifelse(sig.f[[3]]$x[i] >= smth.dec[[6]][[6]][1] & sig.f[[3]]$x[i] <= smth.dec[[6]][[6]][24],  
    sig.f[[3]]$dec[i]<-1, sig.f[[3]]$dec[i]<-NA)}
  
  if (sig.f[[3]]$Region[i]==7)
    {ifelse(sig.f[[3]]$x[i] >= smth.dec[[6]][[7]][1] & sig.f[[3]]$x[i] <= smth.dec[[6]][[7]][68],  
    sig.f[[3]]$dec[i]<-1, sig.f[[3]]$dec[i]<-NA)}

#significant functional increases
  ########fq0
  if (sig.f[[1]]$Region[i]==1)
    {ifelse(sig.f[[1]]$x[i] >= smth.inc[[4]][[1]][1] & sig.f[[1]]$x[i] <= smth.inc[[4]][[1]][29],  
    sig.f[[1]]$inc[i]<-1, sig.f[[1]]$inc[i]<-NA)}
  
  if (sig.f[[1]]$Region[i]==2)
    {ifelse(sig.f[[1]]$x[i] >= smth.inc[[4]][[2]][1] & sig.f[[1]]$x[i] <= smth.inc[[4]][[2]][19],  
    sig.f[[1]]$inc[i]<-1, 
    ifelse(sig.f[[1]]$x[i] >= smth.inc[[4]][[2]][20] & sig.f[[1]]$x[i] <= smth.inc[[4]][[2]][56],
    sig.f[[1]]$inc[i]<-2, sig.f[[1]]$inc[i]<-NA))}
  
  if (sig.f[[1]]$Region[i]==3)
    {ifelse(sig.f[[1]]$x[i] >= smth.inc[[4]][[3]][1] & sig.f[[1]]$x[i] <= smth.inc[[4]][[3]][33],  
    sig.f[[1]]$inc[i]<-1, 
    ifelse(sig.f[[1]]$x[i] >= smth.inc[[4]][[3]][34] & sig.f[[1]]$x[i] <= smth.inc[[4]][[3]][59],
    sig.f[[1]]$inc[i]<-2, sig.f[[1]]$inc[i]<-NA))}
  
  if (sig.f[[1]]$Region[i]==4)
    {ifelse(sig.f[[1]]$x[i] >= smth.inc[[4]][[4]][1] & sig.f[[1]]$x[i] <= smth.inc[[4]][[4]][52],  
    sig.f[[1]]$inc[i]<-1, sig.f[[1]]$inc[i]<-NA)}
  
  if (sig.f[[1]]$Region[i]==5)
    {ifelse(sig.f[[1]]$x[i] >= smth.inc[[4]][[5]][1] & sig.f[[1]]$x[i] <= smth.inc[[4]][[5]][9],  
    sig.f[[1]]$inc[i]<-1, 
    ifelse(sig.f[[1]]$x[i] >= smth.inc[[4]][[5]][10] & sig.f[[1]]$x[i] <= smth.inc[[4]][[5]][33], 
    sig.f[[1]]$inc[i]<-2, sig.f[[1]]$inc[i]<-NA))}
  
  if (sig.f[[1]]$Region[i]==6)
    {ifelse(sig.f[[1]]$x[i] >= smth.inc[[4]][[6]][1] & sig.f[[1]]$x[i] <= smth.inc[[4]][[6]][66],  
    sig.f[[1]]$inc[i]<-1, sig.f[[1]]$inc[i]<-NA)}
  
  if (sig.f[[1]]$Region[i]==7)
    {ifelse(sig.f[[1]]$x[i] >= smth.inc[[4]][[7]][1] & sig.f[[1]]$x[i] <= smth.inc[[4]][[7]][17],  
    sig.f[[1]]$inc[i]<-1, 
    ifelse(sig.f[[1]]$x[i] >= smth.inc[[4]][[7]][18] & sig.f[[1]]$x[i] <= smth.inc[[4]][[7]][66], 
    sig.f[[1]]$inc[i]<-2, sig.f[[1]]$inc[i]<-NA))}
  
  ###########fq1
  if (sig.t[[2]]$Region[i]==1)
    {ifelse(sig.f[[2]]$x[i] >= smth.inc[[5]][[1]][1] & sig.f[[2]]$x[i] <= smth.inc[[5]][[1]][29],  
    sig.f[[2]]$inc[i]<-1, sig.f[[2]]$inc[i]<-NA)}
  
  if (sig.f[[2]]$Region[i]==2)
    {ifelse(sig.f[[2]]$x[i] >= smth.inc[[5]][[2]][1] & sig.f[[2]]$x[i] <= smth.inc[[5]][[2]][79],  
    sig.f[[2]]$inc[i]<-1, sig.f[[2]]$inc[i]<-NA)}
  
  if (sig.f[[2]]$Region[i]==3){}
  
  if (sig.f[[2]]$Region[i]==4)
    {ifelse(sig.f[[2]]$x[i] >= smth.inc[[5]][[4]][1] & sig.f[[2]]$x[i] <= smth.inc[[5]][[4]][20],  
    sig.f[[2]]$inc[i]<-1, 
    ifelse(sig.f[[2]]$x[i] >= smth.inc[[5]][[4]][21] & sig.f[[2]]$x[i] <= smth.inc[[5]][[4]][39], 
    sig.f[[2]]$inc[i]<-2, 
    ifelse(sig.f[[2]]$x[i] >= smth.inc[[5]][[4]][40] & sig.f[[2]]$x[i] <= smth.inc[[5]][[4]][65],
    sig.f[[2]]$inc[i]<-3, sig.f[[2]]$inc[i]<-NA)))}
  
  if (sig.f[[2]]$Region[i]==5)
    {ifelse(sig.f[[2]]$x[i] >= smth.inc[[5]][[5]][1] & sig.f[[2]]$x[i] <= smth.inc[[5]][[5]][29],  
    sig.f[[2]]$inc[i]<-1, 
    ifelse(sig.f[[2]]$x[i] >= smth.inc[[5]][[5]][30] & sig.f[[2]]$x[i] <= smth.inc[[5]][[5]][35],
    sig.f[[2]]$inc[i]<-2, 
    ifelse(sig.f[[2]]$x[i] >= smth.inc[[5]][[5]][36] & sig.f[[2]]$x[i] <= smth.inc[[5]][[5]][64],
    sig.f[[2]]$inc[i]<-3, sig.f[[2]]$inc[i]<-NA)))}
  
  if (sig.f[[2]]$Region[i]==6)
    {ifelse(sig.f[[2]]$x[i] >= smth.inc[[5]][[6]][1] & sig.f[[2]]$x[i] <= smth.inc[[5]][[6]][26],  
    sig.f[[2]]$inc[i]<-1, 
    ifelse(sig.f[[2]]$x[i] >= smth.inc[[5]][[6]][27] & sig.f[[2]]$x[i] <= smth.inc[[5]][[6]][64],
    sig.f[[2]]$inc[i]<-2, 
    ifelse(sig.f[[2]]$x[i] >= smth.inc[[5]][[6]][65] & sig.f[[2]]$x[i] <= smth.inc[[5]][[6]][84],
    sig.f[[2]]$inc[i]<-3, sig.f[[2]]$inc[i]<-NA)))}
  
  if (sig.f[[2]]$Region[i]==7)
    {ifelse(sig.f[[2]]$x[i] >= smth.inc[[5]][[7]][1] & sig.f[[2]]$x[i] <= smth.inc[[5]][[7]][48],  
    sig.f[[2]]$inc[i]<-1, 
    ifelse(sig.f[[2]]$x[i] >= smth.inc[[5]][[7]][49] & sig.f[[2]]$x[i] <= smth.inc[[5]][[7]][81],
    sig.f[[2]]$inc[i]<-2, sig.f[[2]]$inc[i]<-NA))}
  
  ######fq2
  if (sig.f[[3]]$Region[i]==1)
    {ifelse(sig.f[[3]]$x[i] >= smth.inc[[6]][[1]][1] & sig.f[[3]]$x[i] <= smth.inc[[6]][[1]][28],  
    sig.f[[3]]$inc[i]<-1, sig.f[[3]]$inc[i]<-NA)}
  
  if (sig.f[[3]]$Region[i]==2)
    {ifelse(sig.f[[3]]$x[i] >= smth.inc[[6]][[2]][1] & sig.f[[3]]$x[i] <= smth.inc[[6]][[2]][39],  
    sig.f[[3]]$inc[i]<-1, sig.f[[3]]$inc[i]<-NA)}
  
  if (sig.f[[3]]$Region[i]==3){}
  
  if (sig.f[[3]]$Region[i]==4)
    {ifelse(sig.f[[3]]$x[i] >= smth.inc[[6]][[4]][1] & sig.f[[3]]$x[i] <= smth.inc[[6]][[4]][16],  
    sig.f[[3]]$inc[i]<-1, 
    ifelse(sig.f[[3]]$x[i] >= smth.inc[[6]][[4]][17] & sig.f[[3]]$x[i] <= smth.inc[[6]][[4]][28], 
    sig.f[[3]]$inc[i]<-2, 
    ifelse(sig.f[[3]]$x[i] >= smth.inc[[6]][[4]][29] & sig.f[[3]]$x[i] <= smth.inc[[6]][[4]][63],
    sig.f[[3]]$inc[i]<-3, sig.f[[3]]$inc[i]<-NA)))}
  
  if (sig.f[[3]]$Region[i]==5)
    {ifelse(sig.f[[3]]$x[i] >= smth.inc[[6]][[5]][1] & sig.f[[3]]$x[i] <= smth.inc[[6]][[5]][30],  
    sig.f[[3]]$inc[i]<-1, 
    ifelse(sig.f[[3]]$x[i] >= smth.inc[[6]][[5]][31] & sig.f[[3]]$x[i] <= smth.inc[[6]][[5]][40],
    sig.f[[3]]$inc[i]<-2, 
    ifelse(sig.f[[3]]$x[i] >= smth.inc[[6]][[5]][41] & sig.f[[3]]$x[i] <= smth.inc[[6]][[5]][62],
    sig.f[[3]]$inc[i]<-3, sig.f[[3]]$inc[i]<-NA)))}
  
  if (sig.f[[3]]$Region[i]==6)
    {ifelse(sig.f[[3]]$x[i] >= smth.inc[[6]][[6]][1] & sig.f[[3]]$x[i] <= smth.inc[[6]][[6]][14],  
    sig.f[[3]]$inc[i]<-1, 
    ifelse(sig.f[[3]]$x[i] >= smth.inc[[6]][[6]][15] & sig.f[[3]]$x[i] <= smth.inc[[6]][[6]][44],
    sig.f[[3]]$inc[i]<-2,
    ifelse(sig.f[[3]]$x[i] >= smth.inc[[6]][[6]][45] & sig.f[[3]]$x[i] <= smth.inc[[6]][[6]][64],
    sig.f[[3]]$inc[i]<-3, sig.f[[3]]$inc[i]<-NA)))}
  
  if (sig.f[[3]]$Region[i]==7)
    {ifelse(sig.f[[3]]$x[i] >= smth.inc[[6]][[7]][1] & sig.f[[3]]$x[i] <= smth.inc[[6]][[7]][48],  
    sig.f[[3]]$inc[i]<-1, 
    ifelse(sig.f[[3]]$x[i] >= smth.inc[[6]][[7]][49] & sig.f[[3]]$x[i] <= smth.inc[[6]][[7]][82],
    sig.f[[3]]$inc[i]<-2, sig.f[[3]]$inc[i]<-NA))}
} #end of the loop through the functional diversity
```

### Trend line plotting
With all of the significant trends identified and labeled, we can now plot the 6 diversity metrics (3 taxonomic and 3 functional) along with the significant trends added to the splines. The below code generates three plots, one for each q value (q=0, q=1, and q=2) with 7 subplots for region. Both the taxonomic and functional trends are plotted overtop with functional diversity being shown in orange and taxonomic being shown in black.
```{r}
#Here we create a dataframe called dat_text that has two columns, label and Region, the Region column is numbered 1 through 7 in line with region numbers in tot.sm. The label column contains the abbreviations for each region to be added to the plot
dat_text <- data.frame(
  label= c("ARCT", "GL", "NW", "SE", "IMW", "MEX", "YUC"),
  Region= c(1, 2, 3, 4, 5, 6, 7)
)

#the two dataframes created below are for labeling the MIS on the plots. The x values are the year mid-points for each stage. The label is the name for each stage. The region is set to only 1 because the labels will only appear on the region 1 plot. The other dataframe only appears on the region 2 plot. They are separated so the cool even MIS are labeled on region 1 and the warm odd MIS are labeled on region 2. 
mis_lab_1 <- data.frame(
  label = c("MIS 2", "MIS 4", "MIS 5b", "MIS 5d", "MIS 6"),
  x = c(20.35, 64, 83, 111.25, 140),
  Region = c(1, 1, 1, 1, 1)
)

mis_lab_2 <- data.frame(
  label = c("MIS 1", "MIS 3", "MIS 5a", "MIS 5c", "MIS 5e"),
  x = c(5.85, 43, 74.5, 97.25, 123),
  Region = c(2, 2, 2, 2, 2)
)
```

Below is the code to plot the q=0 trends
```{r fig.height=7.5, fig.width=7}
#the plot is stored at the variable p, so it can be saved
p<-ggplot(tot.sm, aes(KyrBP,q0)) + #establishing the plot to use tot.sm with x values as KyrBP and y = q0
  #below we make grey rectanges to highlight the cool periods in the plots, plus the last interglacial period
  geom_rect(aes(xmin=11.7, xmax=29, ymin=-Inf, ymax=Inf), fill="#D2D2D2", color="#5a5a5a", linetype=2, linewidth=0.25) + #creating a grey rectangle to show when MIS 2 occured, the rectangle is outlined by dashed lines
  geom_rect(aes(xmin=57, xmax=71, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #rectangle for MIS 4
  geom_rect(aes(xmin=78, xmax=88, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #rectangle for MIS 5b
  geom_rect(aes(xmin=106.5, xmax=116, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #for MIS5d
  geom_rect(aes(xmin=130, xmax=Inf, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + # forMIS6
  geom_rect(aes(xmin=116, xmax=130, ymin=-Inf, ymax=Inf), fill="#ffffff", color="#5a5a5a", linetype=2, linewidth=0.25) + #a white rectangle is made for MIS 5e and is outlined with grey dashed lines
  #here we plot the taxonomic q=0 for each site and color black
  geom_line(data=tot.sm, mapping=aes(group=site),col="#000000", na.rm=T, alpha=0.25, linewidth=0.25)+
  #adding lines for the functional q=0 for each site and coloring orange (#e4851b)
  geom_line(data=tot.sm, mapping=aes(KyrBP,fq0,group=site),col="#e4851b", na.rm=T, alpha=0.25, linewidth=0.25) +
  theme_linedraw() + #defining the theme of the plot
  theme( #editing the theme of the plot
    strip.text.x = element_blank(), #removing the x axis text to prevent overlap in the facet wrap later
    axis.title = element_text(size=13, family = "sans"), #setting the axis titles to be size 13 and Arial font
    plot.title = element_text(size=15, family = "sans", face = "bold.italic", margin = margin(b=10)), #setting the title to be size 15, bold and italic, Arial, and to have a bottom margin of 10 to allow room for labels beneath it
    panel.grid = element_blank(), #removing grid lines from the plots
    panel.spacing = unit(-0.01, "lines"), #moving plots closer together to prevent space in the facet wrap
    panel.border = element_rect(colour = "black", fill=NA, size=0.25) #defining the panel borders to be size of 0.25
    )+
  #reversing the x axis to be from 150 to 0 with 12 breaks
  scale_x_reverse(limits=c(150,0), n.breaks = 12) + 
  #smoothing all of the site functional q=0 values with a GAM and plotting in orange
  geom_smooth(mapping=aes(KyrBP,fq0),method="gam", na.rm=T, col="#e4851b", linewidth=0.75, level=0.95, alpha=0.5) +
  #smoothing all of the site taxonomic q=0 values with a GAM and plotting in black
  geom_smooth(mapping=aes(KyrBP,q0),method="gam", na.rm=T, col="#000000", linewidth=0.75, level=0.95, alpha=0.5) +
  #plotting the taxonomic significant decreases by filtering out all of the NA values in the sig.t dec column
  geom_line(
    data=sig.t[[1]]%>%filter(!is.na(.$dec)), mapping=aes(x, y, group=dec), col="#000000", linewidth=1.5, alpha=1) + 
  #plotting the taxonomic significant increases by filtering out all of the NA values in the sig.t inc column
  geom_line(
    data=sig.t[[1]]%>%filter(!is.na(.$inc)), mapping=aes(x, y, group=inc), col="#000000", linewidth=1.5, alpha=1) +
  #The same is done for the functional significant increases and decreases but they are plotted in orange 
  geom_line(
    data=sig.f[[1]]%>%filter(!is.na(.$dec)), mapping=aes(x, y, group=dec), col="#e4851b", linewidth=1.5, alpha=1) +
  geom_line(
    data=sig.f[[1]]%>%filter(!is.na(.$inc)), mapping=aes(x, y, group=inc), col="#e4851b", linewidth=1.5, alpha=1) +
  #labeling the y axis, x axis, and title
  labs(y = "Plant diversity (Effective number of species)", x = "Age (cal ka BP)", title="q=0") + #y axis could also just be called diversity
  #using the facet wrap function we split up the plots by region and stack the plots in 4 rows with 2 columns
  facet_wrap(~Region, nrow=4, ncol=2) +
  #using the dat_text dataframe with the region labels we add the label to each plot (the facet wrap automatically splits them by the region number and adds the labels to each individual plot)
  geom_text(
    data = dat_text,
    mapping = aes(x = 150, y = 73, label = label),
    hjust="left",
    vjust="bottom",
    fontface="bold",
    family="sans",
    size=4
  ) + 
  #we add the mis labels below
  geom_text(
    data = mis_lab_1, #adding labels to region 1
    mapping = aes(x = x, y = 90, label = label),
    hjust="middle",
    vjust="top",
    fontface = "bold",
    family="sans",
    size=3
  ) +
  geom_text(
    data = mis_lab_2, #adding labels to region 2
    mapping = aes(x = x, y = 90, label = label),
    hjust="middle",
    vjust="top",
    fontface = "bold",
    family="sans",
    size=3
  ) + 
  coord_cartesian(ylim=c(0, max(tot.sm$fq0, na.rm=TRUE)), clip="off") #the coord cartesian function defines the y axis limits from 0 to the max value of functional q=0. The clip = "off" argument enables data to be plotted outside of the y limits, so the above mis labels can be plotted at a y=90 despite the y axis max being 80. This enable text to be added outside of the plot.

p #view the created plot

#The plot is saved as q0_sig in three formats (pdf, tiff, and jpeg) within the plots folder of the working directory
ggsave("./plots/q0_sig.pdf", p, width=7, height=7.5, units = "in", device="pdf") #saving the plot as a pdf file
ggsave("./plots/q0_sig.tif", p, width=7, height=7.5, units = "in", device="tiff", dpi = 1000) #saving the plot as a tiff file
ggsave("./plots/q0_sig.jpg", p, width=7, height=7.5, units = "in", device="jpeg", dpi = 1000) #saving the plot as a jpeg file 
```

Below is the code to plot the q=1 trends. Most of the code is identical, but where it differs from q=0, I have commented
```{r fig.height=7.5, fig.width=7}
#assigning the q=1 plot to p1
p1<-ggplot(tot.sm, aes(KyrBP,q1))+ #y = q1 rather than q0
  geom_rect(aes(xmin=11.7, xmax=29, ymin=-Inf, ymax=Inf), fill="#D2D2D2", color="#5a5a5a", linetype=2, linewidth=0.25) + #MIS2
  geom_rect(aes(xmin=57, xmax=71, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS4
  geom_rect(aes(xmin=78, xmax=88, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS5b
  geom_rect(aes(xmin=106.5, xmax=116, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS5d
  geom_rect(aes(xmin=130, xmax=Inf, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS6
  geom_rect(aes(xmin=116, xmax=130, ymin=-Inf, ymax=Inf), fill="#ffffff", color="#5a5a5a", linetype=2, linewidth=0.25) + #MIS5e
  #plotting the taxonomic q=1 trends for each site
  geom_line(data=tot.sm, mapping=aes(group=site),col="#000000", na.rm=T, alpha=0.25, linewidth=0.25)+
  #ploting the functional q=1
  geom_line(data=tot.sm, mapping=aes(KyrBP,fq1,group=site),col="#e4851b", na.rm=T, alpha=0.25, linewidth=0.25) +
  theme_linedraw() + 
  theme(
    strip.text.x = element_blank(),
    axis.title = element_text(size=13, family = "sans"),
    plot.title = element_text(size=15, family = "sans", face = "bold.italic", margin = margin(b=10)),
    panel.grid = element_blank(), 
    panel.spacing = unit(-0.01, "lines"),
    panel.border = element_rect(colour = "black", fill=NA, size=0.25)
    )+
  scale_x_reverse(limits=c(150,0), n.breaks = 12) + 
  #smoothing the functional q=1 for all sites
  geom_smooth(mapping=aes(KyrBP,fq1),method="gam", na.rm=T, col="#e4851b", linewidth=0.75, level=0.95, alpha=0.5) +
  #smoothing the taxonomic q=1 for all sites
  geom_smooth(mapping=aes(KyrBP,q1),method="gam", na.rm=T, col="#000000", linewidth=0.75, level=0.95, alpha=0.5) +
  #adding the taxonomic and functional significant increases and decreases for q=1
  geom_line(
    data=sig.t[[2]]%>%filter(!is.na(.$dec)), mapping=aes(x, y, group=dec), col="#000000", linewidth=1.5, alpha=1) + 
  geom_line(
    data=sig.t[[2]]%>%filter(!is.na(.$inc)), mapping=aes(x, y, group=inc), col="#000000", linewidth=1.5, alpha=1) +
  geom_line(
    data=sig.f[[2]]%>%filter(!is.na(.$dec)), mapping=aes(x, y, group=dec), col="#e4851b", linewidth=1.5, alpha=1) +
  geom_line(
    data=sig.f[[2]]%>%filter(!is.na(.$inc)), mapping=aes(x, y, group=inc), col="#e4851b", linewidth=1.5, alpha=1) +
  #title is set to q=1
  labs(y = "Plant diversity (Effective number of species)", x = "Age (cal ka BP)", title="q=1") + 
  facet_wrap(~Region, nrow=4, ncol=2) +
  geom_text(
    data = dat_text,
    mapping = aes(x = 150, y = 18.5, label = label), #y value is different due to different y axis range
    hjust="left",
    vjust="bottom",
    fontface="bold",
    family="sans",
    size=4
  ) + 
  geom_text(
    data = mis_lab_1,
    mapping = aes(x = x, y = 22.8, label = label), #y value is differnet due to the q=1 having a different range of y values than q=0
    hjust="middle",
    vjust="top",
    fontface = "bold",
    family="sans",
    size=3
  ) +
  geom_text(
    data = mis_lab_2,
    mapping = aes(x = x, y = 22.8, label = label),
    hjust="middle",
    vjust="top",
    fontface = "bold",
    family="sans",
    size=3
  ) + 
  coord_cartesian(ylim=c(0, max(tot.sm$fq1, na.rm=TRUE)+1), clip="off") #max value of functional q=1 + 1. The max has 1 added to it to make the y axis labels cleaner to read

p1

#saving p1 as q1_sig in the same three formats within the plots folder of the working directory
ggsave("./plots/q1_sig.pdf", p1, width=7, height=7.5, units = "in", device="pdf")
ggsave("./plots/q1_sig.tif", p1, width=7, height=7.5, units = "in", device="tiff", dpi = 1000)
ggsave("./plots/q1_sig.jpg", p1, width=7, height=7.5, units = "in", device="jpeg", dpi = 1000)
```

```{r fig.height=7.5, fig.width=7}
#plot is assigned as p2 for q=2
p2<-ggplot(tot.sm, aes(KyrBP,q2))+ #y = q2 
  geom_rect(aes(xmin=11.7, xmax=29, ymin=-Inf, ymax=Inf), fill="#D2D2D2", color="#5a5a5a", linetype=2, linewidth=0.25) + #MIS2
  geom_rect(aes(xmin=57, xmax=71, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS4
  geom_rect(aes(xmin=78, xmax=88, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS5b
  geom_rect(aes(xmin=106.5, xmax=116, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS5d
  geom_rect(aes(xmin=130, xmax=Inf, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS6
  geom_rect(aes(xmin=116, xmax=130, ymin=-Inf, ymax=Inf), fill="#ffffff", color="#5a5a5a", linetype=2, linewidth=0.25) + #MIS5e
  #plotting the taxonomic q=2 trends for each site
  geom_line(data=tot.sm, mapping=aes(group=site),col="#000000", na.rm=T, alpha=0.25, linewidth=0.25)+
  #plotting the functional q=2 trends for each site.
  geom_line(data=tot.sm, mapping=aes(KyrBP,fq2,group=site),col="#e4851b", na.rm=T, alpha=0.25, linewidth=0.25) +
  theme_linedraw() + 
  theme(
    strip.text.x = element_blank(),
    axis.title = element_text(size=13, family = "sans"),
    plot.title = element_text(size=15, family = "sans", face = "bold.italic", margin = margin(b=10)),
    panel.grid = element_blank(), 
    panel.spacing = unit(-0.01, "lines"),
    panel.border = element_rect(colour = "black", fill=NA, size=0.25)
    )+
  scale_x_reverse(limits=c(150,0), n.breaks = 12) + 
  #smoothing the functional q=2
  geom_smooth(mapping=aes(KyrBP,fq2),method="gam", na.rm=T, col="#e4851b", linewidth=0.75, level=0.95, alpha=0.5) +
  #smoothing the taxonomic q=2
  geom_smooth(mapping=aes(KyrBP,q2),method="gam", na.rm=T, col="#000000", linewidth=0.75, level=0.95, alpha=0.5) +
  #adding the taxonomic and functional signficant increases and decreases for q=2
  geom_line(
    data=sig.t[[3]]%>%filter(!is.na(.$dec)), mapping=aes(x, y, group=dec), col="#000000", linewidth=1.5, alpha=1) + 
  geom_line(
    data=sig.t[[3]]%>%filter(!is.na(.$inc)), mapping=aes(x, y, group=inc), col="#000000", linewidth=1.5, alpha=1) +
  geom_line(
    data=sig.f[[3]]%>%filter(!is.na(.$dec)), mapping=aes(x, y, group=dec), col="#e4851b", linewidth=1.5, alpha=1) +
  geom_line(
    data=sig.f[[3]]%>%filter(!is.na(.$inc)), mapping=aes(x, y, group=inc), col="#e4851b", linewidth=1.5, alpha=1) +
  labs(y = "Plant diversity (Effective number of species)", x = "Age (cal ka BP)", title="q=2") + #y axis could also just be called diversity
  facet_wrap(~Region, nrow=4, ncol=2) +
  geom_text(
    data = dat_text,
    mapping = aes(x = 150, y = 11.4, label = label), #y value is different due to different y axis range
    hjust="left",
    vjust="bottom",
    fontface="bold",
    family="sans",
    size=4
  ) + 
  geom_text(
    data = mis_lab_1,
    mapping = aes(x = x, y = 14.1, label = label), #y value is different due to different y axis range
    hjust="middle",
    vjust="top",
    fontface = "bold",
    family="sans",
    size=3
  ) +
  geom_text(
    data = mis_lab_2,
    mapping = aes(x = x, y = 14.1, label = label),
    hjust="middle",
    vjust="top",
    fontface = "bold",
    family="sans",
    size=3
  ) + 
  coord_cartesian(ylim=c(0, max(tot.sm$fq2, na.rm=TRUE)+0.5), clip="off") #y axis is set to max functional q=2 plus 0.5. 0.5 is added so the y axis labels are cleaner

p2


#p2 is saved in the three formats as q2_sig in the plots folder within the working directory.
ggsave("./plots/q2_sig.pdf", p2, width=7, height=7.5, units = "in", device="pdf")
ggsave("./plots/q2_sig.tif", p2, width=7, height=7.5, units = "in", device="tiff", dpi = 1000)
ggsave("./plots/q2_sig.jpg", p2, width=7, height=7.5, units = "in", device="jpeg", dpi = 1000)
```

# Summary trend plot
The below code is to create the summary figure 7 used in our paper. It compiles all of the significant trends and plots them with the oxygen isotope curve derived from the NGRIP data.
```{r}
#creating an empty vector called yr
yr<-vector()

for (r in 1:7){ #looping through the 7 regions
  yr[r]<-tot.sm %>% #the maximum KyrBP value for each region is stored within the yr vector. This givens up the start date for each region
  filter(.$Region == r & rowSums(!is.na(.[3:150])) !=0) %>%
  .$KyrBP %>%
  max()
}
yr[5]<-NA #because the start date of region 5 (Intermountain West) is older than 150, we replace it with NA to show it extends beyond our time frame. 

#creating a start year dataframe with a column for the start year and a column for which region it is for
st.year <- data.frame(
  Region = c(1, 2, 3, 4, 5, 6, 7),
  yr = yr
)

#again we want to label the MIS on the plot which is done here, this time it is not split into odd and even stages
mis_lab_sig <- data.frame(
  label = c("MIS 1", "MIS 2", "MIS 3", "MIS 4", "MIS 5a", "MIS 5b", "MIS 5c", "MIS 5d", "MIS 5e", "MIS 6"),
  x = c(5.85, 20.35, 43, 64, 74.5, 83, 97.25, 111.25, 123, 140),
  y = c(12, 12, 12, 12, 13.5, 12, 12, 13.5, 12, 12), #the y value differs for some labels to prevent overlap
  Region = c(1, 1, 1, 1, 1, 1, 1, 1, 1, 1) #all are being plotted above region 1
)

#we also want to label the which lines are associated with which q value, these are all in a row with different y values
q.lab <- data.frame(
  label = c("q=0", "q=1", "q=2"),
  y = c(8.525, 5, 1.475),
  Region = c(1, 1, 1) #all will be plotted on region 1
)
```

```{r fig.height=6, fig.width=6}
#This plot is the same general format as the previous three plots with a few key differences, the most notable being the only lines being plotted are the significant increases and decreases for each q value and both taxonomic and functional diversity
p.sig<-ggplot(tot.sm, aes(KyrBP,q0))+
  geom_rect(aes(xmin=11.7, xmax=29, ymin=-Inf, ymax=Inf), fill="#D2D2D2", color="#5a5a5a", linetype=2, linewidth=0.25) + #MIS2
  geom_rect(aes(xmin=57, xmax=71, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS4
  geom_rect(aes(xmin=78, xmax=88, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS5b
  geom_rect(aes(xmin=106.5, xmax=116, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS5d
  geom_rect(aes(xmin=130, xmax=Inf, ymin=-Inf, ymax=Inf), fill="#D2D2D2") +
  geom_rect(aes(xmin=116, xmax=130, ymin=-Inf, ymax=Inf), fill="#ffffff", color="#5a5a5a", linetype=2, linewidth=0.25) + #MIS5e
  theme_linedraw() + 
  theme(
    strip.text.x = element_blank(),
    axis.title = element_text(size=13, family="sans"),
    axis.title.y=element_blank(),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    panel.grid = element_blank(), 
    panel.spacing = unit(-0.01, "lines"),
    panel.border = element_rect(colour = "black", fill=NA, size=0.25),
    plot.margin = margin(0,5,5,5, unit="pt")
    )+
  scale_x_reverse(limits=c(150,0), n.breaks = 12) + 
  #here we plot all of the signficant increases and decreases for all three q values and for both taxonomic anf functional diversity. However all of the y values are set to be equal to a constant so the lines only show the temporal extent of the trends and not the magnitude. The constants selected are for visual clarity and are arbitrary numbers
  geom_line(
    data=sig.t[[1]]%>%filter(!is.na(.$dec)), mapping=aes(x, y=8, group=dec), col="#000000", size=2.5, alpha=1) + 
  geom_line(
    data=sig.t[[1]]%>%filter(!is.na(.$inc)), mapping=aes(x, y=8, group=inc), col="#000000", size=2.5, alpha=1) + 
  geom_line(
    data=sig.f[[1]]%>%filter(!is.na(.$dec)), mapping=aes(x, y=9.05, group=dec), col="#e4851b", size=2.5, alpha=1) +
  geom_line(
    data=sig.f[[1]]%>%filter(!is.na(.$inc)), mapping=aes(x, y=9.05, group=inc), col="#e4851b", size=2.5, alpha=1) +
  geom_line(
    data=sig.t[[2]]%>%filter(!is.na(.$dec)), mapping=aes(x, y=4.475, group=dec), col="#000000", size=2.5, alpha=1) +
  geom_line(
    data=sig.t[[2]]%>%filter(!is.na(.$inc)), mapping=aes(x, y=4.475, group=inc), col="#000000", size=2.5, alpha=1) +
  geom_line(
    data=sig.f[[2]]%>%filter(!is.na(.$dec)), mapping=aes(x, y=5.525, group=dec), col="#e4851b", size=2.5, alpha=1) +
  geom_line(
    data=sig.f[[2]]%>%filter(!is.na(.$inc)), mapping=aes(x, y=5.525, group=inc), col="#e4851b", size=2.5, alpha=1) +
  geom_line(
    data=sig.t[[3]]%>%filter(!is.na(.$dec)), mapping=aes(x, y=0.95, group=dec), col="#000000", size=2.5, alpha=1) + 
  geom_line(
    data=sig.t[[3]]%>%filter(!is.na(.$inc)), mapping=aes(x, y=0.95, group=inc), col="#000000", size=2.5, alpha=1) + 
  geom_line(
    data=sig.f[[3]]%>%filter(!is.na(.$dec)), mapping=aes(x, y=2, group=dec), col="#e4851b", size=2.5, alpha=1) +
  geom_line(
    data=sig.f[[3]]%>%filter(!is.na(.$inc)), mapping=aes(x, y=2, group=inc), col="#e4851b", size=2.5, alpha=1) +
  #vertical lines are added to indicate the start of the record for each region
  geom_vline(aes(xintercept = yr), st.year, size=0.5, linetype = 1, col="#5a5a5a") +
  labs(x = "Age (cal ka BP)") + #y axis is unlabeled
  facet_wrap(~Region, nrow=7, ncol=1) + #the plots are arranged in 1 column with 7 rows
  geom_text( #region labeles are again added
    check_overlap = T,
    data = dat_text,
    mapping = aes(x = 150, y = 7.8, label = label),
    hjust="left",
    vjust="bottom",
    fontface="bold",
    family= "sans",
    size=4
  ) +
  geom_text( #MIS labels are added
    data = mis_lab_sig,
    mapping = aes(x = x, y = y, label = label),
    hjust="middle",
    vjust="top",
    fontface = "bold",
    family="sans",
    size=3
  ) +
  geom_text( #q value labels are added
    data = q.lab,
    mapping = aes(x = 0, y = y, label = label),
    hjust = "middle",
    vjust = "middle",
    fontface = "bold.italic",
    family = "sans",
    size = 3
  ) +
  coord_cartesian(ylim=c(0, 10), clip="off") #y axis limits are defined and clip is turned off to allow labels to be placed outside of the plot

#The NGRIP data is imported and plotted below in the plot named oxy
#import NGRIP data and name GRIP
GRIP<-read.csv("./composite/GRIP_data.csv")

#filter the NGRIP data to only include samples from our age range of 0 to 150000 years and create a new KyrBP column and convert years to thousands of years. 
GRIP<-GRIP %>%
  filter(.$yr <= 150000) %>%
  mutate(KyrBP = .$yr/1000)

#create the oxygen isotope curve plot
oxy<-ggplot(GRIP, aes(KyrBP,del18O))+ #data is set to GRIP and the x values are KyrBP and y values are del18O
 #adding the same shaded rectangles to show the different MIS
  geom_rect(aes(xmin=11.7, xmax=29, ymin=-Inf, ymax=Inf), fill="#D2D2D2", color="#5a5a5a", linetype=2, linewidth=0.25) + #MIS2
  geom_rect(aes(xmin=57, xmax=71, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS4
  geom_rect(aes(xmin=78, xmax=88, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS5b
  geom_rect(aes(xmin=106.5, xmax=116, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS5d
  geom_rect(aes(xmin=130, xmax=Inf, ymin=-Inf, ymax=Inf), fill="#D2D2D2") + #MIS6
  geom_rect(aes(xmin=116, xmax=130, ymin=-Inf, ymax=Inf), fill="#ffffff", color="#5a5a5a", linetype=2, linewidth=0.25) + #MIS5e
  #smooth the oxygen isotope data with a spline
  geom_spline(data=GRIP, col="#000000", linewidth=0.75, na.rm=T, spar=0.75)+
  #set the y limits of the plot
  ylim(min(GRIP$del18O, na.rm=T), max(GRIP$del18O, na.rm=T)) + 
  theme_linedraw() + 
  theme(
    strip.text.x = element_blank(),
    axis.title = element_text(size=12, family = "sans"),
    axis.title.y = element_text(hjust = 1, margin = margin(r=15)), #give the y axis title a large right margin to make room to add text beneath it
    axis.text.x = element_blank(),
    axis.ticks.x=element_blank(),
    axis.text.y= element_blank(),
    axis.ticks.y=element_blank(),
    panel.grid = element_blank(), 
    panel.spacing = unit(-0.01, "lines"),
    panel.border = element_rect(colour = "#000000", fill=NA, linewidth=0.25),
    legend.position = "none",
    plot.margin = margin(5,5,0,5, unit="pt") #change the plot margins so there is no bottom margin, allowing the plot to be stacked atop p.sig
    ) +
  labs(x = "", y = expression(""*delta*"18O (Temperature)")) + #create the axis labels
  # create an arrow that is plotted outside of the plot but along the y axis
  geom_segment(aes(x=160, xend = 160 , y=min(del18O, na.rm=T)+1.5, yend = max(del18O, na.rm=T)), size=0.25, arrow =   arrow(length = unit(4,"pt"), ends = "both", type = "closed")) +
  #add a label of cooler and warmer to be added to the ends of the arrow and rotate 90 degrees to be in line with the y axis title
  annotate("text", x= 163, y= -37, label="cooler                 warmer", angle = 90, size = 3, family = "sans")+
  coord_cartesian(xlim = c(150, 0), clip = "off") #define the x axis limits and allow data to be plotted beyond the x axis range

#using the ggarange function combine the two plots (p.sig and oxy) as well with an empty (NULL) third plot between them that can be given a negative height to allow the other two plots to be stacked closer together
sigfig<-ggarrange(oxy, NULL, p.sig, ncol=1, nrow=3, align = "v", heights = c(1, -0.2, 3))

#save sigfig in the three formats within the plots folder of the working directory
ggsave("./plots/sigfig.pdf", sigfig, width=6, height=8, units = "in", device="pdf")
ggsave("./plots/sigfig.tif", sigfig, width=6, height=8, units = "in", device="tiff", dpi = 1000)
ggsave("./plots/sigfig.jpg", sigfig, width=6, height=8, units = "in", device="jpeg", dpi = 1000)
```

# Data prep for ArcGIS Pro Maps
Below is the code used to create the dataframes that were imported into ArcGIS Pro and used in the map making for figures 1, 5, and 6 in our paper. We create an MIS column to label which MIS each row of sig.t and sig.f fall within and then calculate the MIS averages.

### MIS labels
The code below is used to label each row of sig.t and sig.f with the MIS it falls within
```{r}
#looping through the three q values
for (q in 1:3){
  sig.t[[q]]$mis<-NA #for each q value create a column called MIS and fill with NA
  #loop through each row of sig.t
  for (i in 1:nrow(sig.t[[q]])){
    ifelse(11.7 >= sig.t[[q]]$x[i], sig.t[[q]]$mis[i]<-"1", NA) #if the x values of the current row i fall with the numeric range given, mis is given a value of 1, indicating MIS 1, if not then do nothing (NA)
    ifelse(29 >= sig.t[[q]]$x[i] & sig.t[[q]]$x[i] > 11.7, sig.t[[q]]$mis[i]<-"2", NA) #MIS 2 range
    ifelse(57 >= sig.t[[q]]$x[i] & sig.t[[q]]$x[i] > 29, sig.t[[q]]$mis[i]<-"3", NA) #MIS 3 range
    ifelse(71 >= sig.t[[q]]$x[i] & sig.t[[q]]$x[i] > 57, sig.t[[q]]$mis[i]<-"4", NA) #MIS 4 range
    ifelse(78 >= sig.t[[q]]$x[i] & sig.t[[q]]$x[i] > 71, sig.t[[q]]$mis[i]<-"5a", NA) #MIS 5a range
    ifelse(88 >= sig.t[[q]]$x[i] & sig.t[[q]]$x[i] > 78, sig.t[[q]]$mis[i]<-"5b", NA) #MIS 5b range
    ifelse(106.5 >= sig.t[[q]]$x[i] & sig.t[[q]]$x[i] > 88, sig.t[[q]]$mis[i]<-"5c", NA) #MIS 5c range
    ifelse(116 >= sig.t[[q]]$x[i] & sig.t[[q]]$x[i] > 106.5, sig.t[[q]]$mis[i]<-"5d", NA) #MIS 5d range
    ifelse(130 >= sig.t[[q]]$x[i] & sig.t[[q]]$x[i] > 116, sig.t[[q]]$mis[i]<-"5e", NA) #MIS 5e range
    ifelse(sig.t[[q]]$x[i] > 130, sig.t[[q]]$mis[i]<-"6", NA) #MIS 6 range
  }
  #the same is done for sig.f for all the functional values
  sig.f[[q]]$mis<-NA
  for (i in 1:nrow(sig.f[[q]])){
    ifelse(sig.f[[q]]$x[i] > 130, sig.f[[q]]$mis[i]<-"6", NA)
    ifelse(130 >= sig.f[[q]]$x[i] & sig.f[[q]]$x[i] > 116, sig.f[[q]]$mis[i]<-"5e", NA)
    ifelse(116 >= sig.f[[q]]$x[i] & sig.f[[q]]$x[i] > 106.5, sig.f[[q]]$mis[i]<-"5d", NA)
    ifelse(106.5 >= sig.f[[q]]$x[i] & sig.f[[q]]$x[i] > 88, sig.f[[q]]$mis[i]<-"5c", NA)
    ifelse(88 >= sig.f[[q]]$x[i] & sig.f[[q]]$x[i] > 78, sig.f[[q]]$mis[i]<-"5b", NA)
    ifelse(78 >= sig.f[[q]]$x[i] & sig.f[[q]]$x[i] > 71, sig.f[[q]]$mis[i]<-"5a", NA)
    ifelse(71 >= sig.f[[q]]$x[i] & sig.f[[q]]$x[i] > 57, sig.f[[q]]$mis[i]<-"4", NA)
    ifelse(57 >= sig.f[[q]]$x[i] & sig.f[[q]]$x[i] > 29, sig.f[[q]]$mis[i]<-"3", NA)
    ifelse(29 >= sig.f[[q]]$x[i] & sig.f[[q]]$x[i] > 11.7, sig.f[[q]]$mis[i]<-"2", NA)
    ifelse(11.7 >= sig.f[[q]]$x[i], sig.f[[q]]$mis[i]<-"1", NA)
  }
}
```

### MIS Averages and Kruskal - Wallis Tests
The below code is used to calculate the average diversity value for each MIS and then apply kruskal-wallis tests between adjacent stages to determine whether significant changes in the MIS average occurred over the transition or not.
```{r}
#creating a vector called mis.val with the MIS labels
mis.val<-c("1","2","3","4","5a","5b","5c","5d","5e","6")

#looping through the three q values
for (q in 1:3){
  #read in the site coordinate data frame containing the GPS coordinates for each site in our study. The .csv file is within the composite folder of the working directory
  coord<-read.csv("./composite/site_coord.csv")
  
  #create 4 empty data frames, 2 for the taxonomic and functional MIS averages and 2 for the taxonomic and functional p values from the Kruskal-Wallis tests
  avgs.t<-data.frame()
  avgs.f<-data.frame()
  
  pval.t<-data.frame()
  pval.f<-data.frame()
  
  #loop through the 7 regions
  for (r in 1:7){
    
    #store only the trend data for the current region as reg.trend.t for taxonomic anf reg.trend.f for functional
    reg.trend.t<-sig.t[[q]] %>% filter(.$Region==r)
    reg.trend.f<-sig.f[[q]] %>% filter(.$Region==r)
    
    #loop through the number of MIS stages present in the current region (r)
    for (i in 1:length(unique(reg.trend.t$mis))){
      #take the average of the taxonomic diversity values for all the rows that are in the same MIS as the current MIS (i) and save as a single value in row r and column i of avs.t. The result is avgs.t has a row for each region and column for each MIS
      avgs.t[r,i]<-mean(reg.trend.t %>% filter(.$mis==mis.val[i]) %>% .$y, na.rm=T)}
    
    #repeat the same loop but for the functional diversity instead of the taxonomic
    for (i in 1:length(unique(reg.trend.f$mis))){
      avgs.f[r,i]<-mean(reg.trend.f %>% filter(.$mis==mis.val[i]) %>% .$y, na.rm=T)}
    
    #loop through the number of unique MIS for the current region
    for (i in 1:length(unique(reg.trend.t$mis))){
      #loop through the number of the unique MIS for the current region. The double loop will allow us to apply the Kruskal-Wallis test to every MIS pairing
      for (j in 1:length(unique(reg.trend.t$mis))){
        if ( i-j==-1){ #if i - j is -1, it indicates the MIS are adjecent, for example the index of MIS3 minus MIS2 would be- -1 but MIS 3 minus MIS 1 would be -2.
          #if the p value of the kruskal-wallis test of the means of the adjacent MIS is <= 0.05 then we subtract the two stage averages and multiple by -1 (due to reversed x axis) and store that value in pval.t, if the pvalue is greater than 0.05 then we store a 0. The result is pval.t has a row for each region and a column for each MIS transition
          ifelse(kruskal.test(reg.trend.t %>% filter(.$mis==mis.val[i] | .$mis==mis.val[j]) %>% .$y ~ 
                             reg.trend.t %>% filter(.$mis==mis.val[i] | .$mis==mis.val[j]) %>% .$mis)$p.value 
                 <= 0.05, pval.t[r,i]<-(avgs.t[r,j]-avgs.t[r,i])*-1, pval.t[r,i]<-0)}
      }
    }
    #we repeat all of the above testing but with the functional diversity
    for (i in 1:length(unique(reg.trend.f$mis))){
      for (j in 1:length(unique(reg.trend.f$mis))){
        if ( i-j==-1){
          ifelse(kruskal.test(reg.trend.f %>% filter(.$mis==mis.val[i] | .$mis==mis.val[j]) %>% .$y ~ 
                              reg.trend.f %>% filter(.$mis==mis.val[i] | .$mis==mis.val[j]) %>% .$mis)$p.value 
                 <= 0.05, pval.f[r,i]<-(avgs.f[r,j]-avgs.f[r,i])*-1, pval.f[r,i]<-0)}
      }
    }
  }
  #We rename the columns of avgs.t to the mis stages and make a new column called Region with the region numbers (1 through 7)
  avgs.t<-avgs.t %>%
    `colnames<-`(., c("MIS_1","MIS_2","MIS_3","MIS_4","MIS_5a","MIS_5b","MIS_5c","MIS_5d","MIS_5e","MIS_6")) %>%
    mutate(Region = 1:7)
  
  #merging the averages with the site coordinate file
  coord.avgs.t<-coord %>%
  left_join(avgs.t) 
  
  #saving the coordinate file with the averages in the composites folder of the working directory and naming it qx_t_means.csv, the x is either 0, 1, or 2 based on which iteration of q the loop is on.
  write.csv(coord.avgs.t, paste("./composite/q",q-1,"_t_means.csv", sep=''), row.names = F, na="")
  
  #repeating for functional diversity
  avgs.f<-avgs.f %>%
    `colnames<-`(., c("MIS_1","MIS_2","MIS_3","MIS_4","MIS_5a","MIS_5b","MIS_5c","MIS_5d","MIS_5e","MIS_6")) %>%
    mutate(Region = 1:7)
  
  coord.avgs.f<-coord %>%
    left_join(avgs.f)
  
  write.csv(coord.avgs.f, paste("./composite/q",q-1,"_f_means.csv", sep=''), row.names = F, na = "")
  
  #renaming the columns and rows and with the mis transitions and region names
  pval.t<-pval.t %>%
  `colnames<-`(., c("MIS_2-1","MIS_3-2","MIS_4-3","MIS_5a-4","MIS_5b-5a","MIS_5c-5b","MIS_5d-5c","MIS_5e-5d","MIS_6-5e")) %>%
  mutate(Region = 1:7)
  
  #merging with the site coordinates
  coord.trends.t<-coord %>%
    left_join(pval.t)
  
  #writing the dataframe as a .csv named qx_t_trends.csv where the x is either 0, 1, or 2 based on the q loop
  write.csv(coord.trends.t, paste("./composite/q",q-1,"_t_trends.csv", sep=''), row.names = F)
  
  #repeating for the functional diversity (pval.f)
  pval.f<-pval.f %>%
  `colnames<-`(., c("MIS_2-1","MIS_3-2","MIS_4-3","MIS_5a-4","MIS_5b-5a","MIS_5c-5b","MIS_5d-5c","MIS_5e-5d","MIS_6-5e")) %>%
  mutate(Region = 1:7)
  
  coord.trends.f<-coord %>%
    left_join(pval.f)
  
  write.csv(coord.trends.f, paste("./composite/q",q-1,"_f_trends.csv", sep=''), row.names = F)
}
```
